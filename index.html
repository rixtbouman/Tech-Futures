<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Tech Futures Explorer - Quantum Delta NL</title>

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Roboto+Mono:wght@400;500&display=swap" rel="stylesheet">

  <!-- Supabase Client -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    /* ================================
       Design System - Clean & Professional
       Quantum Superposition Theme
       ================================ */
    :root {
      /* Core Colors */
      --black: #000000;
      --blue: #2563EB;
      --white: #FFFFFF;

      /* Accent Colors */
      --error: #9333EA;

      /* Background Colors */
      --bg-page: #F5F5F5;
      --bg-card: #FFFFFF;
      --bg-content: #F8FAFC;
      --bg-subtle: #FAFAFA;

      /* Shadows */
      --shadow-sm: 0 1px 3px rgba(0,0,0,0.08);
      --shadow-md: 0 2px 8px rgba(0,0,0,0.1);
      --shadow-lg: 0 4px 16px rgba(0,0,0,0.12);

      /* Border Radius - Soft & Modern */
      --radius-sm: 8px;
      --radius-md: 12px;
      --radius-lg: 16px;

      /* Typography */
      --font-mono: 'Roboto Mono', monospace;
      --font-body: Arial, sans-serif;

      /* Spacing */
      --space-xs: 0.5rem;
      --space-sm: 0.75rem;
      --space-md: 1rem;
      --space-lg: 1.5rem;
      --space-xl: 2rem;
    }

    /* ================================
       Reset & Base Styles
       ================================ */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent;
    }

    body {
      font-family: var(--font-body);
      background-color: var(--bg-page);
      color: var(--black);
      min-height: 100vh;
      font-size: 16px;
      line-height: 1.5;
    }

    /* ================================
       Superposition Background Effect
       ================================ */
    .superposition-bg {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      pointer-events: none;
      z-index: -1;
      overflow: hidden;
    }

    .superposition-bg::before,
    .superposition-bg::after {
      content: '';
      position: absolute;
      border-radius: 50%;
    }

    .superposition-bg::before {
      width: 220px;
      height: 220px;
      background: radial-gradient(circle, rgba(0, 0, 255, 0.35) 0%, rgba(0, 0, 255, 0.15) 50%, transparent 75%);
      top: -40px;
      right: -40px;
    }

    .superposition-bg::after {
      width: 200px;
      height: 200px;
      background: radial-gradient(circle, rgba(255, 0, 255, 0.35) 0%, rgba(255, 0, 255, 0.15) 50%, transparent 75%);
      bottom: -30px;
      left: -30px;
    }

    /* ================================
       Typography Styles
       ================================ */
    .label {
      font-family: var(--font-mono);
      text-transform: uppercase;
      letter-spacing: 0.08em;
      font-size: 0.8rem;
      font-weight: 500;
      color: var(--blue);
    }

    .headline {
      font-family: var(--font-body);
      font-weight: 300;
      font-size: 1.75rem;
      line-height: 1.3;
      color: var(--black);
    }

    .sub-headline {
      font-family: var(--font-mono);
      font-weight: 400;
      font-size: 1rem;
      line-height: 1.5;
      color: #333;
    }

    .body-text {
      font-family: var(--font-body);
      font-weight: 400;
      font-size: 1rem;
      line-height: 1.7;
      color: #222;
    }

    .small-label {
      font-family: var(--font-mono);
      text-transform: uppercase;
      letter-spacing: 0.08em;
      font-size: 0.7rem;
      font-weight: 500;
      color: #666;
    }

    @media (min-width: 768px) {
      .headline {
        font-size: 2rem;
      }
      .sub-headline {
        font-size: 1.125rem;
      }
    }

    /* ================================
       Layout Components
       ================================ */
    .container {
      max-width: 800px;
      margin: 0 auto;
      padding: var(--space-md);
    }

    @media (min-width: 768px) {
      .container {
        padding: var(--space-xl);
      }
    }

    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: var(--space-sm) var(--space-md);
      background: var(--white);
      box-shadow: var(--shadow-sm);
      gap: var(--space-sm);
    }

    @media (min-width: 768px) {
      .header {
        padding: var(--space-md) var(--space-xl);
      }
    }

    .logo {
      font-family: var(--font-mono);
      font-weight: 400;
      font-size: 0.85rem;
      letter-spacing: 0.05em;
      color: #333;
    }

    @media (min-width: 768px) {
      .logo {
        font-size: 1rem;
      }
    }

    .phase-indicator {
      display: flex;
      gap: 0.5rem;
      align-items: center;
    }

    .phase-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: #DDD;
      transition: all 0.2s ease;
    }

    @media (min-width: 768px) {
      .phase-dot {
        width: 10px;
        height: 10px;
      }
      .phase-indicator {
        gap: 0.6rem;
      }
    }

    .phase-dot.active {
      background: var(--blue);
      transform: scale(1.2);
    }

    .phase-dot.completed {
      background: var(--blue);
      opacity: 0.5;
    }

    /* ================================
       Viewer Mode - Hide Controller Elements
       ================================ */
    body.viewer-mode .controller-only {
      display: none !important;
    }

    body.viewer-mode .viewer-content {
      display: block !important;
    }

    /* Show insights as read-only text for viewers */
    body.viewer-mode .insight-display {
      display: block;
      padding: 0.75rem;
      background: var(--bg-content);
      border-radius: var(--radius-sm);
      margin-bottom: 0.5rem;
      min-height: 2.5rem;
    }

    body.viewer-mode input[type="text"],
    body.viewer-mode textarea,
    body.viewer-mode select {
      display: none !important;
    }

    /* ================================
       Button Styles
       ================================ */
    .btn {
      font-family: var(--font-mono);
      text-transform: uppercase;
      letter-spacing: 0.06em;
      padding: 0.875rem 1.25rem;
      border: none;
      border-radius: var(--radius-sm);
      background: var(--white);
      color: var(--black);
      cursor: pointer;
      transition: all 0.15s ease;
      font-size: 0.8rem;
      font-weight: 500;
      min-height: 48px;
      touch-action: manipulation;
      box-shadow: var(--shadow-sm);
    }

    @media (min-width: 768px) {
      .btn {
        padding: 0.75rem 1.5rem;
        min-height: 44px;
      }
    }

    .btn:hover {
      box-shadow: var(--shadow-md);
      transform: translateY(-1px);
    }

    .btn:active {
      transform: translateY(0);
      box-shadow: var(--shadow-sm);
    }

    .btn-primary {
      background: var(--blue);
      color: var(--white);
    }

    .btn-primary:hover {
      background: #0000DD;
    }

    .btn-secondary {
      background: var(--black);
      color: var(--white);
    }

    .btn-secondary:hover {
      background: #222;
    }

    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }

    /* ================================
       Card Styles
       ================================ */
    .card {
      background: var(--bg-card);
      border-radius: var(--radius-md);
      box-shadow: var(--shadow-md);
      padding: var(--space-lg);
      margin-bottom: var(--space-md);
    }

    @media (min-width: 768px) {
      .card {
        padding: var(--space-xl);
        margin-bottom: var(--space-lg);
      }
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: var(--space-md);
      padding-bottom: var(--space-sm);
      border-bottom: 1px solid #EEE;
    }

    @media (min-width: 768px) {
      .card-header {
        margin-bottom: var(--space-lg);
      }
    }

    /* Nested cards for content sections */
    .card .card {
      background: var(--bg-content);
      box-shadow: none;
      border: 1px solid #EEE;
    }

    /* ================================
       Screen/View Styles
       ================================ */
    .screen {
      display: none;
      min-height: calc(100vh - 80px);
    }

    .screen.active {
      display: block;
    }

    /* ================================
       Language Selection Screen
       ================================ */
    #screen-start {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
      background: var(--white);
      padding: var(--space-lg);
    }

    .start-content {
      text-align: center;
      max-width: 500px;
      width: 100%;
    }

    .start-content .headline {
      margin-bottom: var(--space-sm);
    }

    .start-content .sub-headline {
      color: #666;
    }

    .language-buttons {
      display: flex;
      flex-direction: column;
      gap: var(--space-md);
      margin-top: var(--space-xl);
    }

    @media (min-width: 480px) {
      .language-buttons {
        flex-direction: row;
        justify-content: center;
      }
    }

    .language-btn {
      padding: 1rem 2rem;
      font-size: 0.875rem;
      background: var(--blue);
      color: var(--white);
    }

    .language-btn:hover {
      background: #0000DD;
    }

    /* ================================
       Role Selection (Controller/Viewer)
       ================================ */
    .role-selection,
    .language-selection,
    .viewer-join {
      display: none;
    }

    .role-selection.active,
    .language-selection.active,
    .viewer-join.active {
      display: block;
    }

    .role-buttons {
      display: flex;
      flex-direction: column;
      gap: var(--space-md);
      margin-top: var(--space-xl);
    }

    @media (min-width: 480px) {
      .role-buttons {
        flex-direction: row;
        justify-content: center;
      }
    }

    .role-btn {
      padding: 1.25rem 2rem;
      font-size: 0.875rem;
      background: var(--white);
      color: var(--blue);
      border: 2px solid var(--blue);
      min-width: 180px;
    }

    .role-btn:hover {
      background: var(--blue);
      color: var(--white);
    }

    .role-btn.primary {
      background: var(--blue);
      color: var(--white);
    }

    .role-btn.primary:hover {
      background: #0000DD;
    }

    .group-code-display {
      font-family: var(--font-mono);
      font-size: 2rem;
      font-weight: 700;
      letter-spacing: 0.5rem;
      color: var(--blue);
      background: var(--bg-blue);
      padding: 1rem 2rem;
      border-radius: var(--radius-sm);
      margin: 1.5rem 0;
      display: inline-block;
    }

    .group-code-input {
      font-family: var(--font-mono);
      font-size: 1.5rem;
      text-align: center;
      letter-spacing: 0.3rem;
      text-transform: uppercase;
      padding: 1rem;
      border: 2px solid var(--blue);
      border-radius: var(--radius-sm);
      width: 200px;
      margin: 1rem 0;
    }

    .group-code-input:focus {
      outline: none;
      border-color: #0000DD;
    }

    .back-link {
      color: var(--blue);
      text-decoration: underline;
      cursor: pointer;
      font-size: 0.875rem;
      margin-top: 1rem;
      display: inline-block;
    }

    .back-link:hover {
      color: #0000DD;
    }

    /* ================================
       Status/Loading States
       ================================ */
    .status-message {
      padding: var(--space-md);
      margin: var(--space-md) 0;
      border-radius: var(--radius-sm);
      font-family: var(--font-mono);
      font-size: 0.8rem;
    }

    .status-message.error {
      background: #FEF2F2;
      color: #991B1B;
    }

    .status-message.success {
      background: #F0FDF4;
      color: #166534;
    }

    .status-message.loading {
      background: var(--bg-content);
      color: #666;
    }

    .loading-spinner {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 2px solid #DDD;
      border-top-color: var(--blue);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* ================================
       Debug Panel (Development)
       ================================ */
    #debug-panel {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: var(--black);
      color: var(--white);
      padding: 1rem;
      font-family: var(--font-mono);
      font-size: 0.75rem;
      max-height: 200px;
      overflow-y: auto;
    }

    #debug-panel.hidden {
      display: none;
    }

    .debug-toggle {
      position: fixed;
      bottom: 1rem;
      right: 1rem;
      z-index: 1000;
    }

    /* ================================
       Camera Modal Styles
       ================================ */
    .camera-modal {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.85);
      z-index: 2000;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: var(--space-md);
    }

    .camera-modal-content {
      background: var(--white);
      border-radius: var(--radius-lg);
      max-width: 600px;
      width: 100%;
      max-height: 90vh;
      overflow: hidden;
      box-shadow: var(--shadow-lg);
    }

    .camera-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: var(--space-md);
      border-bottom: 1px solid #EEE;
      background: var(--white);
    }

    .camera-view {
      position: relative;
      background: #111;
      min-height: 300px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .camera-view video,
    .camera-view img {
      width: 100%;
      max-height: 400px;
      object-fit: contain;
    }

    .camera-hint {
      position: absolute;
      bottom: var(--space-md);
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0, 0, 0, 0.7);
      color: var(--white);
      padding: var(--space-xs) var(--space-md);
      border-radius: var(--radius-sm);
      font-family: var(--font-mono);
      font-size: 0.7rem;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    .camera-controls {
      display: flex;
      flex-direction: column;
      gap: var(--space-sm);
      padding: var(--space-md);
      background: var(--bg-subtle);
    }

    @media (min-width: 480px) {
      .camera-controls {
        flex-direction: row;
        justify-content: center;
      }
    }

    .camera-controls .btn {
      width: 100%;
    }

    @media (min-width: 480px) {
      .camera-controls .btn {
        width: auto;
        min-width: 140px;
      }
    }

    .scan-button {
      width: 100%;
      margin-bottom: var(--space-md);
      background: var(--white);
      color: var(--blue);
      font-size: 0.875rem;
      padding: var(--space-md);
      border: 1px dashed var(--blue);
      border-radius: var(--radius-md);
    }

    .scan-button:hover {
      background: var(--blue);
      color: var(--white);
      border-style: solid;
    }

    .scan-divider {
      display: flex;
      align-items: center;
      gap: var(--space-md);
      margin: var(--space-md) 0;
      color: #999;
    }

    .scan-divider::before,
    .scan-divider::after {
      content: '';
      flex: 1;
      height: 1px;
      background: #DDD;
    }

    .scan-divider span {
      font-family: var(--font-mono);
      font-size: 0.7rem;
      text-transform: uppercase;
    }

    /* ================================
       Back Button Styles
       ================================ */
    .back-button {
      font-family: var(--font-mono);
      font-size: 0.8rem;
      color: #666;
      background: none;
      border: none;
      cursor: pointer;
      padding: var(--space-xs) 0;
      margin-bottom: var(--space-md);
      display: inline-flex;
      align-items: center;
      gap: var(--space-xs);
      transition: color 0.15s ease;
    }

    .back-button:hover {
      color: var(--blue);
    }

    .phase-header {
      display: flex;
      align-items: center;
      gap: var(--space-md);
      margin-bottom: var(--space-sm);
    }

    /* ================================
       Mobile Responsive Grids
       ================================ */
    .mobile-grid-1 {
      display: grid;
      grid-template-columns: 1fr;
      gap: 1rem;
    }

    .mobile-grid-2 {
      display: grid;
      grid-template-columns: 1fr;
      gap: 1rem;
    }

    .mobile-grid-3 {
      display: grid;
      grid-template-columns: 1fr;
      gap: 1rem;
    }

    @media (min-width: 768px) {
      .mobile-grid-2 {
        grid-template-columns: repeat(2, 1fr);
      }
      .mobile-grid-3 {
        grid-template-columns: repeat(3, 1fr);
      }
    }

    /* ================================
       Form Elements (Mobile Optimized)
       ================================ */
    select.btn,
    input.btn,
    textarea.btn {
      width: 100%;
      font-size: 16px;
      min-height: 48px;
      padding: var(--space-sm) var(--space-md);
      appearance: none;
      -webkit-appearance: none;
      border-radius: var(--radius-sm);
      border: 1px solid #DDD;
      background: var(--white);
      box-shadow: none;
    }

    select.btn:focus,
    input.btn:focus,
    textarea.btn:focus {
      outline: none;
      border-color: var(--blue);
      box-shadow: 0 0 0 3px rgba(0, 0, 255, 0.1);
    }

    select.btn {
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%23666' d='M6 8L1 3h10z'/%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right var(--space-md) center;
      padding-right: 2.5rem;
    }

    textarea.btn {
      min-height: 100px;
      resize: vertical;
    }

    input[type="text"].btn,
    input[type="email"].btn {
      text-transform: none;
    }

    /* Form field labels */
    .field-label {
      display: block;
      font-family: var(--font-mono);
      font-size: 0.7rem;
      text-transform: uppercase;
      letter-spacing: 0.06em;
      margin-bottom: var(--space-xs);
      color: #555;
    }

    .field-group {
      margin-bottom: var(--space-md);
    }

    /* Radio/Checkbox touch targets */
    input[type="radio"],
    input[type="checkbox"] {
      width: 20px;
      height: 20px;
      margin: 0;
      cursor: pointer;
      accent-color: var(--blue);
    }

    /* Clickable card items */
    .selectable-item {
      padding: var(--space-md);
      margin-bottom: var(--space-sm);
      background: var(--white);
      border: 1px solid #DDD;
      border-radius: var(--radius-sm);
      cursor: pointer;
      transition: all 0.15s ease;
    }

    .selectable-item:active {
      background: var(--bg-content);
    }

    .selectable-item.selected {
      background: rgba(0, 0, 255, 0.05);
      border-color: var(--blue);
    }

    /* Mobile-specific visibility */
    .hide-mobile {
      display: none;
    }

    @media (min-width: 768px) {
      .hide-mobile {
        display: block;
      }
      .hide-desktop {
        display: none;
      }
    }

    /* ================================
       AI Generated Content Styling
       ================================ */

    /* Scenario Title */
    .scenario-title {
      font-size: 1.25rem;
      font-weight: 600;
      color: var(--black);
      margin-bottom: var(--space-lg);
      line-height: 1.4;
    }

    /* ================================
       AI Output Styling - Simple & Clean
       ================================ */

    /* Section Headers (h3.section-header) */
    h3.section-header,
    .section-header {
      font-size: 1rem;
      font-weight: 700;
      color: #0000FF;
      margin: 1.5rem 0 0.5rem 0;
      padding: 0;
    }

    .section-header:first-child,
    h3.section-header:first-child {
      margin-top: 0;
    }

    /* Narrative Vignette (italic blocks) */
    .narrative-vignette {
      background: #E8F4FC;
      border-left: 3px solid #0000FF;
      padding: 1rem;
      margin: 1rem 0;
      border-radius: 4px;
      font-style: italic;
    }

    .narrative-vignette p {
      line-height: 1.7;
      color: #333;
      margin: 0;
    }

    /* Styled Lists - clean single bullets */
    .styled-list {
      list-style: none;
      padding: 0;
      margin: 0.5rem 0 1rem 0;
    }

    .styled-list li {
      padding: 0.4rem 0 0.4rem 1.25rem;
      position: relative;
      line-height: 1.6;
      color: #333;
    }

    .styled-list li::before {
      content: '‚Ä¢';
      position: absolute;
      left: 0;
      color: #0000FF;
      font-weight: bold;
    }

    /* Body paragraphs in output */
    .formatted-content p,
    #scenario-text p,
    #consequences-text p {
      line-height: 1.7;
      margin: 0.75rem 0;
      color: #333;
    }

    /* What-If Question Cards */
    .whatif-card {
      background: var(--white);
      border: 1px solid #E0E0E0;
      border-radius: var(--radius-md);
      padding: var(--space-md);
      margin-bottom: var(--space-md);
      cursor: pointer;
      transition: all 0.15s ease;
    }

    .whatif-card:hover {
      border-color: var(--blue);
      box-shadow: var(--shadow-sm);
    }

    .whatif-card.selected {
      border-color: var(--blue);
      background: rgba(0, 0, 255, 0.03);
    }

    .whatif-question {
      font-size: 1.05rem;
      font-weight: 400;
      color: var(--black);
      margin-bottom: var(--space-sm);
      line-height: 1.5;
    }

    .whatif-meta {
      display: flex;
      flex-wrap: wrap;
      gap: var(--space-sm);
      margin-top: var(--space-sm);
    }

    .whatif-tag {
      font-family: var(--font-mono);
      font-size: 0.65rem;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      padding: 0.25rem 0.5rem;
      border-radius: 3px;
      background: #F0F0F0;
    }

    .whatif-tag.tech {
      background: rgba(0, 0, 255, 0.1);
      color: var(--blue);
    }

    .whatif-tag.domain {
      background: #F5F5F5;
      color: #666;
    }

    /* Strategic Priority Items */
    .priority-item {
      background: var(--white);
      border: 1px solid #E0E0E0;
      border-radius: var(--radius-sm);
      padding: var(--space-md);
      margin-bottom: var(--space-sm);
      cursor: pointer;
      transition: all 0.15s ease;
    }

    .priority-item:hover {
      border-color: #CCC;
    }

    .priority-item.selected {
      border-color: var(--blue);
      background: rgba(0, 0, 255, 0.03);
    }

    .priority-source {
      font-family: var(--font-mono);
      font-size: 0.6rem;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: #888;
      margin-bottom: var(--space-xs);
    }

    .priority-text {
      font-size: 0.95rem;
      line-height: 1.5;
      color: #333;
    }
  </style>
</head>
<body>
  <!-- Quantum Superposition Background -->
  <div class="superposition-bg"></div>

  <!-- ================================
       Start Screen (Role & Language Selection)
       ================================ -->
  <div id="screen-start" class="screen active">
    <div class="start-content">
      <p class="label">Quantum Delta NL</p>
      <h1 class="headline" style="margin: 1rem 0;">Tech Futures Explorer</h1>
      <p class="sub-headline" style="margin-bottom: 2rem;">
        Emerging Technologies Futures Exploration Tool
      </p>

      <!-- Step 1: Role Selection -->
      <div id="role-selection" class="role-selection active">
        <p class="body-text" data-i18n="role_description">
          Kies je rol in de workshop sessie.
        </p>
        <div class="role-buttons">
          <button class="btn role-btn primary" onclick="selectRole('controller')" data-i18n="role_controller">
            Start Sessie
          </button>
          <button class="btn role-btn" onclick="selectRole('viewer')" data-i18n="role_viewer">
            Join Sessie
          </button>
        </div>
      </div>

      <!-- Step 2a: Language Selection (Controller) -->
      <div id="language-selection" class="language-selection">
        <p class="body-text" data-i18n="start_description">
          Verken hoe opkomende technologie√´n kunnen samenkomen en impact hebben op de samenleving.
        </p>
        <div class="language-buttons">
          <button class="btn language-btn" onclick="startAsController('nl')">
            Nederlands
          </button>
          <button class="btn language-btn" onclick="startAsController('en')">
            English
          </button>
        </div>
        <span class="back-link" onclick="backToRoleSelection()" data-i18n="back">‚Üê Terug</span>
      </div>

      <!-- Step 2b: Join with Code (Viewer) -->
      <div id="viewer-join" class="viewer-join">
        <p class="body-text" data-i18n="viewer_description">
          Voer de groepscode in om de sessie te volgen.
        </p>
        <input type="text"
               id="group-code-input"
               class="group-code-input"
               placeholder="ABC12"
               maxlength="5"
               oninput="this.value = this.value.toUpperCase()">
        <div id="viewer-error" class="status-message error" style="display: none;">
          Code niet gevonden
        </div>
        <div style="margin-top: 1rem;">
          <button class="btn role-btn primary" onclick="joinAsViewer()" data-i18n="join_session">
            Join Sessie
          </button>
        </div>
        <span class="back-link" onclick="backToRoleSelection()" data-i18n="back">‚Üê Terug</span>
      </div>

      <!-- Controller: Show Group Code after creation -->
      <div id="controller-code-display" class="language-selection">
        <p class="body-text" data-i18n="share_code">
          Deel deze code met je teamleden:
        </p>
        <div class="group-code-display" id="display-group-code">-----</div>
        <div style="margin-top: 1rem;">
          <button class="btn role-btn primary" onclick="proceedToMainScreen()" data-i18n="continue">
            Doorgaan
          </button>
        </div>
      </div>

      <!-- Connection Status -->
      <div id="connection-status" class="status-message loading" style="margin-top: 2rem;">
        <span class="loading-spinner"></span>
        Verbinding maken met database...
      </div>
    </div>
  </div>

  <!-- ================================
       Main App Screen
       ================================ -->
  <div id="screen-main" class="screen">
    <header class="header">
      <div class="logo">TECH FUTURES</div>
      <div class="phase-indicator">
        <div class="phase-dot active" data-phase="1" title="Phase 1: Scenario"></div>
        <div class="phase-dot" data-phase="2" title="Phase 2: Disruption"></div>
        <div class="phase-dot" data-phase="3" title="Phase 3: Consequences"></div>
        <div class="phase-dot" data-phase="4" title="Phase 4: Strategy"></div>
        <div class="phase-dot" data-phase="5" title="Phase 5: Export"></div>
      </div>
      <div style="display: flex; align-items: center; gap: 0.5rem;">
        <span id="group-code-badge" style="display: none; font-family: var(--font-mono); font-size: 0.75rem; background: var(--bg-blue); color: var(--blue); padding: 0.25rem 0.5rem; border-radius: 4px;"></span>
        <span id="viewer-badge" style="display: none; font-size: 0.7rem; background: var(--bg-grey); padding: 0.25rem 0.5rem; border-radius: 4px;">VIEW ONLY</span>
        <button class="btn" onclick="showDebugInfo()" data-i18n="debug">Debug</button>
      </div>
    </header>

    <main class="container">
      <!-- Phase 1: Scenario Foundation -->
      <section id="phase-1" class="phase-content active">
        <div class="card">
          <div class="card-header">
            <span class="label" data-i18n="phase1_title">Fase 1: Scenario Basis</span>
          </div>
          <p class="body-text" data-i18n="phase1_intro">
            Selecteer de 3 binaire keuzes om het basisscenario te bepalen.
          </p>

          <!-- Card Selection - Controller Only -->
          <div class="card controller-only" style="background: var(--bg-grey); margin-top: 1.5rem;">
            <!-- Scan Cards Button -->
            <button class="btn scan-button" onclick="openCamera('phase1')" data-i18n="scan_cards_phase1">
              üì∑ Scan Cards
            </button>
            <div class="scan-divider"><span data-i18n="or_manual">or select manually</span></div>

            <div class="mobile-grid-3">
              <div class="field-group">
                <label class="field-label" data-i18n="card_resources">Resources</label>
                <select id="select-resources" class="btn">
                  <option value="" data-i18n="select_placeholder">-- Kies --</option>
                  <option value="Abundance">Abundance</option>
                  <option value="Limits">Limits</option>
                </select>
              </div>
              <div class="field-group">
                <label class="field-label" data-i18n="card_system">System</label>
                <select id="select-system" class="btn">
                  <option value="" data-i18n="select_placeholder">-- Kies --</option>
                  <option value="Stable">Stable</option>
                  <option value="Breaks">Breaks</option>
                </select>
              </div>
              <div class="field-group">
                <label class="field-label" data-i18n="card_values">Values</label>
                <select id="select-values" class="btn">
                  <option value="" data-i18n="select_placeholder">-- Kies --</option>
                  <option value="Collective">Collective</option>
                  <option value="Individual">Individual</option>
                </select>
              </div>
            </div>
            <button class="btn btn-primary" style="margin-top: 1.5rem; width: 100%;" onclick="determineArchetype()" id="btn-determine" data-i18n="determine_archetype">
              Bepaal Archetype
            </button>
          </div>

          <!-- Archetype Result -->
          <div id="archetype-result" class="card" style="display: none; background: var(--bg-blue); margin-top: 1rem;">
            <p class="small-label" data-i18n="archetype">Archetype</p>
            <h2 class="headline" id="archetype-name" style="margin: 0.5rem 0;"></h2>
            <p class="sub-headline" id="archetype-nuance" style="color: var(--blue);"></p>
            <p class="body-text" id="archetype-summary" style="margin-top: 0.75rem;"></p>
          </div>

          <!-- Generated Scenario -->
          <div id="scenario-result" class="card" style="display: none; background: var(--bg-magenta); margin-top: 1rem;">
            <p class="small-label" data-i18n="generated_scenario">Gegenereerd Scenario</p>
            <div class="body-text" id="scenario-text" style="margin-top: 1rem; white-space: pre-line;"></div>
            <button class="btn btn-primary controller-only" style="margin-top: 1.5rem; width: 100%;" onclick="goToPhase(2)" data-i18n="continue_phase2">
              Verder naar Fase 2
            </button>
          </div>
        </div>
      </section>

      <!-- Phase 2: Disruption Introduction -->
      <section id="phase-2" class="phase-content" style="display: none;">
        <div class="card">
          <button class="back-button controller-only" onclick="goToPhase(1)">‚Üê Back</button>
          <div class="card-header">
            <span class="label" data-i18n="phase2_title">Fase 2: Disruptie</span>
          </div>
          <p class="body-text controller-only" data-i18n="phase2_intro">
            Selecteer technologie√´n, een actor en een trigger om what-if vragen te genereren.
          </p>

          <!-- Technology Selection - Controller Only -->
          <div class="card controller-only" style="background: var(--bg-grey); margin-top: 1.5rem;">
            <!-- Scan Cards Button -->
            <button class="btn scan-button" onclick="openCamera('phase2')" data-i18n="scan_cards_phase2">
              üì∑ Scan All Cards (Tech + Actor + Event)
            </button>
            <div class="scan-divider"><span data-i18n="or_manual">or select manually</span></div>

            <p class="small-label" style="margin-bottom: 0.75rem;" data-i18n="select_technologies">Technologie√´n (3, inclusief quantum)</p>
            <div class="mobile-grid-3">
              <div class="field-group">
                <label class="field-label">Quantum Tech</label>
                <select id="select-tech-quantum" class="btn">
                  <option value="quantum">Quantum</option>
                </select>
              </div>
              <div class="field-group">
                <label class="field-label">Technology 2</label>
                <select id="select-tech-2" class="btn">
                  <option value="" data-i18n="select_placeholder">-- Kies --</option>
                  <option value="AGI">AGI</option>
                  <option value="Neuro tech">Neuro tech</option>
                  <option value="biotech">biotech</option>
                  <option value="Robotics">Robotics</option>
                  <option value="Climate tech">Climate tech</option>
                </select>
              </div>
              <div class="field-group">
                <label class="field-label">Technology 3</label>
                <select id="select-tech-3" class="btn">
                  <option value="" data-i18n="select_placeholder">-- Kies --</option>
                  <option value="AGI">AGI</option>
                  <option value="Neuro tech">Neuro tech</option>
                  <option value="biotech">biotech</option>
                  <option value="Robotics">Robotics</option>
                  <option value="Climate tech">Climate tech</option>
                </select>
              </div>
            </div>

            <!-- Actor and Event -->
            <div class="mobile-grid-2" style="margin-top: 1.5rem;">
              <div class="field-group">
                <label class="field-label" data-i18n="select_actor">Actor</label>
                <select id="select-actor" class="btn">
                  <option value="" data-i18n="select_placeholder">-- Kies --</option>
                  <option value="criminal_networks">Criminal networks</option>
                  <option value="foreign_states">Foreign states</option>
                  <option value="big_tech">Big Tech</option>
                  <option value="research_institutions">Research institutions</option>
                  <option value="ngos">NGOs</option>
                  <option value="citizens">Citizens</option>
                  <option value="journalists">Journalists</option>
                  <option value="startups">Startups</option>
                  <option value="insurance_companies">Insurance companies</option>
                  <option value="custom">Custom (enter below)</option>
                </select>
                <input type="text" id="input-actor-custom" class="btn" placeholder="Custom actor..." style="margin-top: 0.5rem; display: none;">
              </div>
              <div class="field-group">
                <label class="field-label" data-i18n="select_event">Trigger Event</label>
                <select id="select-event" class="btn">
                  <option value="" data-i18n="select_placeholder">-- Kies --</option>
                  <option value="major_breakthrough">Major breakthrough</option>
                  <option value="security_breach">Security breach</option>
                  <option value="regulatory_shift">Regulatory shift</option>
                  <option value="talent_exodus">Talent exodus</option>
                  <option value="international_treaty">International treaty</option>
                  <option value="maturity_tipping_point">Maturity tipping point</option>
                  <option value="loss_of_control">Loss of control</option>
                  <option value="public_scandal">Public scandal</option>
                  <option value="market_collapse">Market collapse</option>
                  <option value="custom">Custom (enter below)</option>
                </select>
                <input type="text" id="input-event-custom" class="btn" placeholder="Custom event..." style="margin-top: 0.5rem; display: none;">
              </div>
            </div>

            <button class="btn btn-primary" style="margin-top: 1.5rem; width: 100%;" onclick="generateWhatIfQuestions()" id="btn-generate-whatif" data-i18n="generate_whatif">
              Genereer What-If Vragen
            </button>
          </div>

          <!-- What-If Questions Result -->
          <div id="whatif-result" class="card" style="display: none; background: var(--bg-blue); margin-top: 1rem;">
            <p class="small-label" data-i18n="whatif_questions">What-If Vragen</p>
            <div id="whatif-questions-list" style="margin-top: 1rem;"></div>

            <!-- Custom What-If Input - Controller Only -->
            <div class="controller-only" style="margin-top: 1.5rem; padding-top: 1rem; border-top: 1px solid var(--black);">
              <p class="small-label" data-i18n="or_custom_whatif">Of voer een eigen vraag in:</p>
              <textarea id="input-custom-whatif" class="btn" placeholder="What if..." style="width: 100%; height: 80px; margin-top: 0.5rem; resize: vertical; text-transform: none;"></textarea>
            </div>

            <button class="btn btn-primary controller-only" style="margin-top: 1rem; width: 100%;" onclick="proceedToPhase3()" id="btn-proceed-phase3" data-i18n="continue_phase3">
              Verder met geselecteerde vraag
            </button>
          </div>
        </div>
      </section>

      <!-- Phase 3: Consequences -->
      <section id="phase-3" class="phase-content" style="display: none;">
        <div class="card">
          <button class="back-button controller-only" onclick="goToPhase(2)">‚Üê Back</button>
          <div class="card-header">
            <span class="label" data-i18n="phase3_title">Fase 3: Consequenties</span>
          </div>

          <!-- Selected What-If Display -->
          <div class="card" style="background: var(--bg-blue); margin-bottom: 1rem;">
            <p class="small-label" data-i18n="selected_whatif">Geselecteerde What-If Vraag</p>
            <p class="sub-headline" id="selected-whatif-display" style="margin-top: 0.5rem;"></p>
          </div>

          <!-- Consequences Result -->
          <div id="consequences-result" class="card" style="background: var(--bg-magenta);">
            <p class="small-label" data-i18n="consequences">Consequenties</p>
            <div class="body-text" id="consequences-text" style="margin-top: 1rem; white-space: pre-line;">
              <div style="text-align: center; padding: 2rem;">
                <span class="loading-spinner"></span><br><br>
                <span data-i18n="generating_consequences">Consequenties genereren...</span>
              </div>
            </div>
          </div>

          <button class="btn btn-primary controller-only" style="margin-top: 1rem; width: 100%;" onclick="goToPhase(4)" data-i18n="continue_phase4">
            Verder naar Fase 4
          </button>
        </div>
      </section>

      <!-- Phase 4: Strategic Insights -->
      <section id="phase-4" class="phase-content" style="display: none;">
        <div class="card">
          <button class="back-button controller-only" onclick="goToPhase(3)">‚Üê Back</button>
          <div class="card-header">
            <span class="label" data-i18n="phase4_title">Fase 4: Strategische Inzichten</span>
          </div>

          <!-- Reflective Question - Controller Only -->
          <p class="body-text controller-only" style="font-style: italic; margin-top: 1rem;" data-i18n="phase4_question">
            Stel dat je morgen een collega bijpraat over de meest interessante inzichten van deze sessie: wat zijn de kern punten die je over zal dragen?
          </p>

          <!-- Strategic Insights Input - Controller Only -->
          <div class="card controller-only" style="background: var(--bg-grey); margin-top: 1.5rem;">
            <p class="small-label" data-i18n="strategic_insights">Strategische Inzichten</p>
            <p class="body-text" style="font-size: 0.85rem; color: #666; margin-bottom: 1rem;" data-i18n="min_insights_hint">Vul minimaal 2 inzichten in</p>

            <div style="display: flex; flex-direction: column; gap: 0.75rem;">
              <div style="display: flex; align-items: center; gap: 0.5rem;">
                <span style="font-weight: 700; color: var(--blue);">1.</span>
                <input type="text" id="insight-1" class="btn" style="flex: 1; text-transform: none;" data-i18n-placeholder="insight_placeholder" placeholder="inzicht van vandaag">
              </div>
              <div style="display: flex; align-items: center; gap: 0.5rem;">
                <span style="font-weight: 700; color: var(--blue);">2.</span>
                <input type="text" id="insight-2" class="btn" style="flex: 1; text-transform: none;" data-i18n-placeholder="insight_placeholder" placeholder="inzicht van vandaag">
              </div>
              <div style="display: flex; align-items: center; gap: 0.5rem;">
                <span style="font-weight: 700; color: var(--blue);">3.</span>
                <input type="text" id="insight-3" class="btn" style="flex: 1; text-transform: none;" data-i18n-placeholder="insight_placeholder" placeholder="inzicht van vandaag">
              </div>
            </div>
          </div>

          <!-- Strategic Insights Display - Viewer Only -->
          <div id="insights-viewer-display" class="card" style="background: var(--bg-grey); margin-top: 1.5rem; display: none;">
            <p class="small-label" data-i18n="strategic_insights">Strategische Inzichten</p>
            <div id="insights-viewer-list" style="margin-top: 1rem;"></div>
          </div>

          <!-- Error message -->
          <p id="phase4-error" class="body-text controller-only" style="color: var(--error); text-align: center; margin-top: 1rem; display: none;" data-i18n="min_insights_error">
            Vul minimaal 2 inzichten in
          </p>

          <!-- Continue button -->
          <button id="phase4-continue-btn" class="btn btn-primary controller-only" style="margin-top: 1.5rem; width: 100%;" onclick="proceedToPhase5()" data-i18n="continue_phase5">
            Verder naar Export
          </button>
        </div>
      </section>

      <!-- Phase 5: Export -->
      <section id="phase-5" class="phase-content" style="display: none;">
        <div class="card">
          <button class="back-button controller-only" onclick="goToPhase(4)">‚Üê Back</button>
          <div class="card-header">
            <span class="label" data-i18n="phase5_title">Fase 5: Export & Opslaan</span>
          </div>

          <!-- Team Name Input (Required) - Controller Only -->
          <div class="card controller-only" style="background: var(--bg-blue); margin-top: 1.5rem;">
            <label class="small-label" data-i18n="team_name_label">Wat is de naam van jullie team van Futuristen?</label>
            <input type="text" id="input-team-name" class="btn" data-i18n-placeholder="team_name_placeholder" placeholder="Team naam..." style="width: 100%; margin-top: 0.75rem; text-transform: none;">
            <p id="team-name-error" class="body-text" style="color: var(--error); margin-top: 0.5rem; display: none;" data-i18n="team_name_required">Vul een teamnaam in om te exporteren</p>
          </div>

          <!-- Session Summary -->
          <div id="session-summary" class="card" style="background: var(--bg-grey); margin-top: 1rem;">
            <p class="small-label" data-i18n="session_summary">Sessie Samenvatting</p>

            <!-- 1. Foundation: Binary choices + Archetype -->
            <div style="margin-top: 1rem; padding: 1rem; background: var(--white); border: 1px solid #E5E7EB;">
              <p class="small-label" style="color: var(--blue);" data-i18n="section_foundation">DE BASIS</p>
              <div style="margin-top: 0.5rem;">
                <p class="body-text" style="margin-bottom: 0.25rem;"><strong data-i18n="label_resources">Resources:</strong> <span id="summary-resources"></span></p>
                <p class="body-text" style="margin-bottom: 0.25rem;"><strong data-i18n="label_system">System:</strong> <span id="summary-system"></span></p>
                <p class="body-text" style="margin-bottom: 0.5rem;"><strong data-i18n="label_values">Values:</strong> <span id="summary-values"></span></p>
                <p class="body-text"><strong data-i18n="label_archetype">Archetype:</strong> <span id="summary-archetype"></span></p>
              </div>
            </div>

            <!-- 2. The World: Full scenario -->
            <div style="margin-top: 1rem; padding: 1rem; background: var(--white); border: 1px solid #E5E7EB;">
              <p class="small-label" style="color: var(--magenta);" data-i18n="section_world">DE WERELD</p>
              <p class="body-text" id="summary-scenario" style="margin-top: 0.5rem; max-height: 200px; overflow-y: auto;"></p>
            </div>

            <!-- 3. The Disruption: Technologies + Actor + Trigger -->
            <div style="margin-top: 1rem; padding: 1rem; background: var(--white); border: 1px solid #E5E7EB;">
              <p class="small-label" style="color: var(--magenta);" data-i18n="section_disruption">DE DISRUPTIE</p>
              <div style="margin-top: 0.5rem;">
                <p class="body-text" style="margin-bottom: 0.25rem;"><strong data-i18n="label_technologies">Technologies:</strong> <span id="summary-techs"></span></p>
                <p class="body-text" style="margin-bottom: 0.25rem;"><strong>Actor:</strong> <span id="summary-actor"></span></p>
                <p class="body-text"><strong>Trigger:</strong> <span id="summary-trigger"></span></p>
              </div>
            </div>

            <!-- 4. The Provocation: All 3 what-if questions -->
            <div style="margin-top: 1rem; padding: 1rem; background: var(--white); border: 1px solid #E5E7EB;">
              <p class="small-label" style="color: var(--blue);" data-i18n="section_provocation">DE PROVOCATIE</p>
              <div id="summary-whatif-questions" style="margin-top: 0.5rem;"></div>
              <div style="margin-top: 0.75rem; padding-top: 0.75rem; border-top: 1px dashed #D1D5DB;">
                <p class="body-text" style="font-weight: 700;" data-i18n="selected_question">Gekozen vraag:</p>
                <p class="body-text" id="summary-selected-whatif" style="margin-top: 0.25rem; font-style: italic;"></p>
              </div>
            </div>

            <!-- 5. Consequences -->
            <div style="margin-top: 1rem; padding: 1rem; background: var(--white); border: 1px solid #E5E7EB;">
              <p class="small-label" style="color: var(--magenta);" data-i18n="section_consequences">DE CONSEQUENTIES</p>
              <div id="summary-consequences" style="margin-top: 0.5rem; max-height: 250px; overflow-y: auto;"></div>
            </div>

            <!-- 6. The Strategy: Strategic insights -->
            <div style="margin-top: 1rem; padding: 1rem; background: var(--white); border: 1px solid #E5E7EB;">
              <p class="small-label" style="color: var(--blue);" data-i18n="section_strategy">DE STRATEGIE</p>
              <div id="summary-insights" style="margin-top: 0.5rem;"></div>
            </div>
          </div>

          <!-- Export Options - Controller Only -->
          <div class="card controller-only" style="background: var(--bg-blue); margin-top: 1rem;">
            <p class="small-label" data-i18n="export_options">Export Opties</p>
            <div class="mobile-grid-2" style="margin-top: 1rem;">
              <button class="btn btn-secondary" onclick="exportToPDF()" data-i18n="export_pdf">
                Download PDF
              </button>
              <button class="btn btn-secondary" onclick="copyToClipboard()" data-i18n="copy_summary">
                Kopieer Tekst
              </button>
            </div>
          </div>

          <!-- Save to Database - Controller Only -->
          <div class="card controller-only" style="background: var(--bg-magenta); margin-top: 1rem;">
            <p class="small-label" data-i18n="save_session">Sessie Opslaan</p>
            <button class="btn btn-primary" style="margin-top: 1rem; width: 100%;" onclick="saveSession()" id="btn-save-session" data-i18n="save_to_database">
              Opslaan in Database
            </button>
            <div id="save-status" style="margin-top: 0.75rem;"></div>
          </div>

          <!-- New Session Button - Controller Only -->
          <button class="btn controller-only" style="margin-top: 1.5rem; width: 100%;" onclick="startNewSession()" data-i18n="start_new">
            Start Nieuwe Sessie
          </button>
        </div>
      </section>
    </main>
  </div>

  <!-- Camera Modal -->
  <div id="camera-modal" class="camera-modal" style="display: none;">
    <div class="camera-modal-content">
      <div class="camera-header">
        <span class="label" id="camera-title">üì∑ Scan Cards</span>
        <button class="btn" onclick="closeCamera()">‚úï</button>
      </div>

      <!-- Live Camera View -->
      <div id="camera-live" class="camera-view">
        <video id="camera-video" autoplay playsinline></video>
        <p class="camera-hint" id="camera-hint">Position all cards in frame</p>
      </div>

      <!-- Captured Image Preview -->
      <div id="camera-preview" class="camera-view" style="display: none;">
        <img id="camera-image" alt="Captured cards">
        <canvas id="camera-canvas" style="display: none;"></canvas>
      </div>

      <!-- Processing State -->
      <div id="camera-processing" class="camera-view" style="display: none;">
        <div style="text-align: center; padding: 3rem;">
          <span class="loading-spinner" style="width: 40px; height: 40px;"></span>
          <p class="body-text" style="margin-top: 1rem;" id="camera-processing-text">Analyzing cards...</p>
        </div>
      </div>

      <!-- Camera Controls -->
      <div class="camera-controls">
        <button id="btn-capture" class="btn btn-primary" onclick="capturePhoto()">
          üì∏ Capture
        </button>
        <button id="btn-retake" class="btn" onclick="retakePhoto()" style="display: none;">
          ‚Üª Retake
        </button>
        <button id="btn-use-photo" class="btn btn-primary" onclick="usePhoto()" style="display: none;">
          ‚úì Use This Photo
        </button>
      </div>

      <!-- Error Message -->
      <div id="camera-error" class="status-message error" style="display: none; margin-top: 1rem;"></div>
    </div>
  </div>

  <!-- Debug Toggle -->
  <button class="btn debug-toggle" onclick="toggleDebug()">DB</button>

  <!-- Debug Panel -->
  <div id="debug-panel" class="hidden">
    <strong>Debug Log:</strong>
    <pre id="debug-log"></pre>
  </div>

  <!-- ================================
       JavaScript Application
       ================================ -->
  <script>
    // ================================
    // Configuration
    // ================================
    const SUPABASE_URL = 'https://ccfyvpqtxypiawbbftgs.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNjZnl2cHF0eHlwaWF3YmJmdGdzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY4MzIzOTYsImV4cCI6MjA4MjQwODM5Nn0.C-_T4ZmhcB1rihlcnpwUC_APohAOGEE9nQREmsXBTVg';

    // ================================
    // Global State
    // ================================
    const AppState = {
      // Real-time sync
      role: null,           // 'controller' | 'viewer' | null
      groupCode: null,      // e.g., 'K7X2M'

      // Session data
      language: 'nl',
      currentPhase: 1,
      sessionId: null,
      archetype: null,
      archetypeContext: null,
      scenario: null,
      selectedTechnologies: [],
      selectedActor: null,
      selectedEvent: null,
      whatIfQuestions: [],
      selectedWhatIf: null,
      selectedWhatIfTechs: [],
      consequences: null,
      strategicInsights: [],
      teamName: '',
      savedSessionId: null
    };

    // Realtime channel reference
    let realtimeChannel = null;

    // Debounce utility for typed inputs
    function debounce(func, wait) {
      let timeout;
      return function executedFunction(...args) {
        const later = () => {
          clearTimeout(timeout);
          func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
      };
    }

    // Debounced sync function (500ms delay)
    const debouncedSync = debounce(() => {
      syncStateToDatabase();
    }, 500);

    // ================================
    // Supabase Client
    // ================================
    let supabaseClient = null;

    function initSupabase() {
      try {
        supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        debugLog('Supabase client initialized');
        return true;
      } catch (error) {
        debugLog('Supabase init error: ' + error.message);
        return false;
      }
    }

    // ================================
    // Language/i18n System
    // ================================
    const translations = {
      nl: {
        phase1_title: 'Fase 1: Scenario Basis',
        phase1_intro: 'Selecteer de 3 binaire keuzes om het basisscenario te bepalen.',
        card_resources: 'Resources',
        card_system: 'System',
        card_values: 'Values',
        select_placeholder: '-- Kies --',
        determine_archetype: 'Genereer Scenario',
        archetype: 'Archetype',
        generated_scenario: 'Gegenereerd Scenario',
        continue_phase2: 'Verder naar Fase 2',
        debug: 'Debug',
        connecting: 'Verbinding maken...',
        connected: 'Verbonden met database',
        connection_error: 'Kan geen verbinding maken met database',
        select_all_options: 'Selecteer alle drie de opties',
        generating_scenario: 'Scenario wordt gegenereerd...',
        determining_archetype: 'Archetype bepalen...',
        error_archetype: 'Fout bij ophalen archetype',
        // Phase 2
        phase2_title: 'Fase 2: Disruptie',
        phase2_intro: 'Selecteer technologie√´n, een actor en een trigger om what-if vragen te genereren.',
        select_technologies: 'Technologie√´n (3, inclusief quantum)',
        select_actor: 'Actor',
        select_event: 'Trigger Event',
        generate_whatif: 'Genereer What-If Vragen',
        generating_whatif: 'What-if vragen genereren...',
        whatif_questions: 'What-If Vragen',
        or_custom_whatif: 'Of voer een eigen vraag in:',
        continue_phase3: 'Verder met geselecteerde vraag',
        select_whatif_error: 'Selecteer een what-if vraag of voer een eigen vraag in',
        select_tech_actor_event: 'Selecteer alle technologie√´n, actor en event',
        // Phase 3
        phase3_title: 'Fase 3: Consequenties',
        selected_whatif: 'Geselecteerde What-If Vraag',
        consequences: 'Consequenties',
        generating_consequences: 'Consequenties genereren...',
        continue_phase4: 'Verder naar Fase 4',
        // Phase 4
        phase4_title: 'Fase 4: Strategische Inzichten',
        phase4_question: 'Stel dat je morgen een collega bijpraat over de meest interessante inzichten van deze sessie: wat zijn de kern punten die je over zal dragen?',
        strategic_insights: 'Strategische Inzichten',
        min_insights_hint: 'Vul minimaal 2 inzichten in',
        min_insights_error: 'Vul minimaal 2 inzichten in',
        insight_placeholder: 'inzicht van vandaag',
        continue_phase5: 'Verder naar Export',
        // Phase 5
        phase5_title: 'Fase 5: Export & Opslaan',
        team_name_label: 'Wat is de naam van jullie team van Futuristen?',
        team_name_placeholder: 'Team naam...',
        team_name_required: 'Vul een teamnaam in om te exporteren',
        session_summary: 'Sessie Samenvatting',
        section_foundation: 'DE BASIS',
        section_world: 'DE WERELD',
        section_disruption: 'DE DISRUPTIE',
        section_provocation: 'DE PROVOCATIE',
        section_consequences: 'DE CONSEQUENTIES',
        section_strategy: 'DE STRATEGIE',
        label_resources: 'Resources:',
        label_system: 'System:',
        label_values: 'Values:',
        label_archetype: 'Archetype:',
        label_technologies: 'Technologie√´n:',
        selected_question: 'Gekozen vraag:',
        export_options: 'Export Opties',
        export_pdf: 'Download PDF',
        copy_summary: 'Kopieer Tekst',
        save_session: 'Sessie Opslaan',
        save_to_database: 'Opslaan in Database',
        start_new: 'Start Nieuwe Sessie',
        copied_success: 'Gekopieerd naar klembord!',
        save_success: 'Sessie opgeslagen!',
        save_error: 'Fout bij opslaan',
        no_insights: 'Geen inzichten ingevuld',
        pdf_generating: 'PDF genereren...',
        // Camera
        scan_cards_phase1: 'üì∑ Scan Kaarten',
        scan_cards_phase2: 'üì∑ Scan Alle Kaarten (Tech + Actor + Event)',
        or_manual: 'of selecteer handmatig',
        camera_error: 'Camera niet beschikbaar',
        analyzing_cards: 'Kaarten analyseren...',
        card_scan_failed: 'Kaarten niet herkend, probeer opnieuw',
        cards_detected: 'Kaarten gedetecteerd!',
        // Real-time sync
        role_description: 'Kies je rol in de workshop sessie.',
        role_controller: 'Start Sessie',
        role_viewer: 'Join Sessie',
        start_description: 'Verken hoe opkomende technologie√´n kunnen samenkomen en impact hebben op de samenleving.',
        viewer_description: 'Voer de groepscode in om de sessie te volgen.',
        join_session: 'Join Sessie',
        share_code: 'Deel deze code met je teamleden:',
        continue: 'Doorgaan',
        back: '‚Üê Terug'
      },
      en: {
        phase1_title: 'Phase 1: Scenario Foundation',
        phase1_intro: 'Select the 3 binary choices to determine the base scenario.',
        card_resources: 'Resources',
        card_system: 'System',
        card_values: 'Values',
        select_placeholder: '-- Select --',
        determine_archetype: 'Generate Scenario',
        archetype: 'Archetype',
        generated_scenario: 'Generated Scenario',
        continue_phase2: 'Continue to Phase 2',
        debug: 'Debug',
        connecting: 'Connecting...',
        connected: 'Connected to database',
        connection_error: 'Cannot connect to database',
        select_all_options: 'Please select all three options',
        generating_scenario: 'Generating scenario...',
        determining_archetype: 'Determining archetype...',
        error_archetype: 'Error fetching archetype',
        // Phase 2
        phase2_title: 'Phase 2: Disruption',
        phase2_intro: 'Select technologies, an actor, and a trigger to generate what-if questions.',
        select_technologies: 'Technologies (3, including quantum)',
        select_actor: 'Actor',
        select_event: 'Trigger Event',
        generate_whatif: 'Generate What-If Questions',
        generating_whatif: 'Generating what-if questions...',
        whatif_questions: 'What-If Questions',
        or_custom_whatif: 'Or enter your own question:',
        continue_phase3: 'Continue with selected question',
        select_whatif_error: 'Select a what-if question or enter your own',
        select_tech_actor_event: 'Select all technologies, actor, and event',
        // Phase 3
        phase3_title: 'Phase 3: Consequences',
        selected_whatif: 'Selected What-If Question',
        consequences: 'Consequences',
        generating_consequences: 'Generating consequences...',
        continue_phase4: 'Continue to Phase 4',
        // Phase 4
        phase4_title: 'Phase 4: Strategic Insights',
        phase4_question: 'Imagine you\'re briefing a colleague tomorrow on the most interesting insights from this session: what are the key points you would pass along?',
        strategic_insights: 'Strategic Insights',
        min_insights_hint: 'Fill in at least 2 insights',
        min_insights_error: 'Please fill in at least 2 insights',
        insight_placeholder: 'insight from today',
        continue_phase5: 'Continue to Export',
        // Phase 5
        phase5_title: 'Phase 5: Export & Save',
        team_name_label: 'What is the name of your team of Futurists?',
        team_name_placeholder: 'Team name...',
        team_name_required: 'Enter a team name to export',
        session_summary: 'Session Summary',
        section_foundation: 'THE FOUNDATION',
        section_world: 'THE WORLD',
        section_disruption: 'THE DISRUPTION',
        section_provocation: 'THE PROVOCATION',
        section_consequences: 'THE CONSEQUENCES',
        section_strategy: 'THE STRATEGY',
        label_resources: 'Resources:',
        label_system: 'System:',
        label_values: 'Values:',
        label_archetype: 'Archetype:',
        label_technologies: 'Technologies:',
        selected_question: 'Selected question:',
        export_options: 'Export Options',
        export_pdf: 'Download PDF',
        copy_summary: 'Copy Text',
        save_session: 'Save Session',
        save_to_database: 'Save to Database',
        start_new: 'Start New Session',
        copied_success: 'Copied to clipboard!',
        save_success: 'Session saved!',
        save_error: 'Error saving',
        no_insights: 'No insights provided',
        pdf_generating: 'Generating PDF...',
        // Camera
        scan_cards_phase1: 'üì∑ Scan Cards',
        scan_cards_phase2: 'üì∑ Scan All Cards (Tech + Actor + Event)',
        or_manual: 'or select manually',
        camera_error: 'Camera not available',
        analyzing_cards: 'Analyzing cards...',
        card_scan_failed: 'Cards not recognized, please try again',
        cards_detected: 'Cards detected!',
        // Real-time sync
        role_description: 'Choose your role in the workshop session.',
        role_controller: 'Start Session',
        role_viewer: 'Join Session',
        start_description: 'Explore how emerging technologies can converge and impact society.',
        viewer_description: 'Enter the group code to follow the session.',
        join_session: 'Join Session',
        share_code: 'Share this code with your team members:',
        continue: 'Continue',
        back: '‚Üê Back'
      }
    };

    function t(key) {
      return translations[AppState.language]?.[key] || translations['en']?.[key] || key;
    }

    function updateUILanguage() {
      document.querySelectorAll('[data-i18n]').forEach(el => {
        const key = el.getAttribute('data-i18n');
        el.textContent = t(key);
      });
      document.documentElement.lang = AppState.language;
    }

    // ================================
    // Debug Utilities
    // ================================
    function debugLog(message) {
      const timestamp = new Date().toLocaleTimeString();
      const logEl = document.getElementById('debug-log');
      if (logEl) {
        logEl.textContent += `[${timestamp}] ${message}\n`;
        logEl.scrollTop = logEl.scrollHeight;
      }
      console.log(`[Debug] ${message}`);
    }

    function toggleDebug() {
      document.getElementById('debug-panel').classList.toggle('hidden');
    }

    function showDebugInfo() {
      debugLog('Current State: ' + JSON.stringify(AppState, null, 2));
    }

    // ================================
    // Screen Navigation
    // ================================
    function showScreen(screenId) {
      document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
      document.getElementById(screenId)?.classList.add('active');
    }

    function goToPhase(phase) {
      AppState.currentPhase = phase;

      // Update phase indicators
      document.querySelectorAll('.phase-dot').forEach(dot => {
        const dotPhase = parseInt(dot.dataset.phase);
        dot.classList.remove('active', 'completed');
        if (dotPhase === phase) dot.classList.add('active');
        if (dotPhase < phase) dot.classList.add('completed');
      });

      // Show correct phase content
      document.querySelectorAll('.phase-content').forEach(p => p.style.display = 'none');
      document.getElementById(`phase-${phase}`).style.display = 'block';

      // Restore previously generated content when navigating back
      if (phase === 1) {
        // Show archetype and scenario if they exist
        if (AppState.archetype) {
          document.getElementById('archetype-result').style.display = 'block';
        }
        if (AppState.scenario) {
          document.getElementById('scenario-result').style.display = 'block';
        }
      } else if (phase === 2) {
        // Show what-if questions if they exist
        if (AppState.whatIfQuestions.length > 0) {
          document.getElementById('whatif-result').style.display = 'block';
        }
      } else if (phase === 3) {
        // Show consequences if they exist
        if (AppState.consequences) {
          const consequencesResult = document.getElementById('consequences-result');
          if (consequencesResult) consequencesResult.style.display = 'block';
          document.getElementById('consequences-text').innerHTML = formatConsequencesOutput(AppState.consequences);
        }
      }

      // Initialize phase-specific content
      if (phase === 4) initPhase4();
      if (phase === 5) initPhase5();

      // Sync phase change to database for viewers (only if controller)
      syncStateToDatabase();

      debugLog(`Navigated to Phase ${phase}`);
    }

    // ================================
    // Session Management & Real-time Sync
    // ================================

    // Generate random 5-character group code
    function generateGroupCode() {
      const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789'; // Exclude confusing chars: I,O,0,1
      let code = '';
      for (let i = 0; i < 5; i++) {
        code += chars.charAt(Math.floor(Math.random() * chars.length));
      }
      return code;
    }

    // Check if group code exists in database
    async function checkGroupCodeExists(code) {
      try {
        const { data, error } = await supabaseClient
          .from('live_sessions')
          .select('group_code')
          .eq('group_code', code)
          .single();

        if (error && error.code !== 'PGRST116') { // PGRST116 = no rows found
          throw error;
        }
        return !!data;
      } catch (error) {
        debugLog(`Error checking group code: ${error.message}`);
        return false;
      }
    }

    // Generate unique group code (retry if exists)
    async function generateUniqueGroupCode() {
      let code = generateGroupCode();
      let attempts = 0;
      const maxAttempts = 10;

      while (await checkGroupCodeExists(code) && attempts < maxAttempts) {
        code = generateGroupCode();
        attempts++;
      }

      if (attempts >= maxAttempts) {
        throw new Error('Could not generate unique group code');
      }

      return code;
    }

    // Role selection UI navigation
    function selectRole(role) {
      document.getElementById('role-selection').classList.remove('active');

      if (role === 'controller') {
        document.getElementById('language-selection').classList.add('active');
      } else {
        document.getElementById('viewer-join').classList.add('active');
      }
    }

    function backToRoleSelection() {
      document.getElementById('language-selection').classList.remove('active');
      document.getElementById('viewer-join').classList.remove('active');
      document.getElementById('controller-code-display').classList.remove('active');
      document.getElementById('viewer-error').style.display = 'none';
      document.getElementById('role-selection').classList.add('active');
    }

    // Start session as Controller
    async function startAsController(language) {
      try {
        AppState.role = 'controller';
        AppState.language = language;

        // Generate unique group code
        const groupCode = await generateUniqueGroupCode();
        AppState.groupCode = groupCode;

        // Create live session in database
        const { error } = await supabaseClient
          .from('live_sessions')
          .insert({
            group_code: groupCode,
            current_phase: 1,
            app_state: AppState
          });

        if (error) throw error;

        // Subscribe to channel for this group
        subscribeToChannel(groupCode);

        // Show the group code to controller
        document.getElementById('display-group-code').textContent = groupCode;
        document.getElementById('language-selection').classList.remove('active');
        document.getElementById('controller-code-display').classList.add('active');

        debugLog(`Controller session started with code: ${groupCode}`);
      } catch (error) {
        debugLog(`Error starting controller session: ${error.message}`);
        alert('Error starting session: ' + error.message);
      }
    }

    // Join session as Viewer
    async function joinAsViewer() {
      const codeInput = document.getElementById('group-code-input');
      const code = codeInput.value.toUpperCase().trim();
      const errorDiv = document.getElementById('viewer-error');

      if (code.length !== 5) {
        errorDiv.textContent = 'Voer een 5-karakter code in';
        errorDiv.style.display = 'block';
        return;
      }

      try {
        // Check if session exists
        const { data, error } = await supabaseClient
          .from('live_sessions')
          .select('*')
          .eq('group_code', code)
          .single();

        if (error || !data) {
          errorDiv.textContent = 'Code niet gevonden';
          errorDiv.style.display = 'block';
          return;
        }

        // Set viewer state
        AppState.role = 'viewer';
        AppState.groupCode = code;

        // Load the current state from the session
        if (data.app_state) {
          Object.assign(AppState, data.app_state);
          AppState.role = 'viewer'; // Ensure viewer role is preserved
          AppState.groupCode = code;
        }

        // Subscribe to channel for real-time updates
        subscribeToChannel(code);

        // Update UI and go to main screen
        updateUILanguage();
        showScreen('screen-main');
        goToPhase(AppState.currentPhase || 1);

        // Show badges for viewer
        const codeBadge = document.getElementById('group-code-badge');
        codeBadge.textContent = code;
        codeBadge.style.display = 'inline-block';
        document.getElementById('viewer-badge').style.display = 'inline-block';

        // Enable viewer mode (hides controller-only elements via CSS)
        document.body.classList.add('viewer-mode');

        // Hide debug button for viewers
        const debugBtn = document.querySelector('button[onclick="showDebugInfo()"]');
        if (debugBtn) debugBtn.style.display = 'none';

        // Update display with current state
        updateViewerDisplay();

        // Auto-scroll to current phase content
        setTimeout(() => {
          const currentPhaseEl = document.getElementById(`phase-${AppState.currentPhase || 1}`);
          if (currentPhaseEl) {
            currentPhaseEl.scrollIntoView({ behavior: 'smooth', block: 'start' });
          }
        }, 100);

        debugLog(`Viewer joined session with code: ${code}`);
      } catch (error) {
        debugLog(`Error joining session: ${error.message}`);
        errorDiv.textContent = 'Fout bij verbinden';
        errorDiv.style.display = 'block';
      }
    }

    // Proceed to main screen (for Controller after seeing code)
    function proceedToMainScreen() {
      updateUILanguage();
      showScreen('screen-main');

      // Show group code badge for controller
      if (AppState.groupCode) {
        const badge = document.getElementById('group-code-badge');
        badge.textContent = AppState.groupCode;
        badge.style.display = 'inline-block';
      }

      debugLog('Controller proceeding to main screen');
    }

    // Subscribe to Supabase Realtime channel
    function subscribeToChannel(groupCode) {
      // Unsubscribe from any existing channel
      if (realtimeChannel) {
        supabaseClient.removeChannel(realtimeChannel);
      }

      // Subscribe to changes for this group
      realtimeChannel = supabaseClient
        .channel(`live_session_${groupCode}`)
        .on(
          'postgres_changes',
          {
            event: 'UPDATE',
            schema: 'public',
            table: 'live_sessions',
            filter: `group_code=eq.${groupCode}`
          },
          (payload) => {
            debugLog('Received realtime update:', payload);
            handleRealtimeUpdate(payload.new);
          }
        )
        .subscribe((status) => {
          debugLog(`Realtime subscription status: ${status}`);
        });
    }

    // Handle incoming realtime updates (for Viewers)
    function handleRealtimeUpdate(newData) {
      if (AppState.role !== 'viewer') return; // Controllers don't receive updates

      debugLog('Realtime update received:', JSON.stringify(newData).substring(0, 500));
      debugLog('Has consequences:', !!newData.app_state?.consequences);
      debugLog('Current phase from DB:', newData.current_phase);

      // Parse app_state if it's a string (JSONB might come as string)
      let appStateData = newData.app_state;
      if (typeof appStateData === 'string') {
        try {
          appStateData = JSON.parse(appStateData);
        } catch (e) {
          debugLog('Error parsing app_state:', e.message);
          return;
        }
      }

      if (appStateData) {
        const previousPhase = parseInt(AppState.currentPhase) || 1;
        const newPhase = parseInt(newData.current_phase) || parseInt(appStateData.currentPhase) || 1;

        // Update AppState with new data, preserving viewer role
        Object.assign(AppState, appStateData);
        AppState.role = 'viewer';
        AppState.groupCode = newData.group_code;
        AppState.currentPhase = newPhase;

        // Update UI if phase changed
        if (newPhase !== previousPhase) {
          debugLog(`Phase changed from ${previousPhase} to ${newPhase}`);
          goToPhase(newPhase);
        }

        // Update displayed content
        updateViewerDisplay();

        // Always reinitialize current phase to ensure content is shown
        if (newPhase === 4) initPhase4();
        if (newPhase === 5) initPhase5();

        debugLog('Viewer state updated from realtime');
      }
    }

    // Sync state to database (called by Controller)
    async function syncStateToDatabase() {
      if (AppState.role !== 'controller' || !AppState.groupCode) return;

      try {
        const { error } = await supabaseClient
          .from('live_sessions')
          .update({
            current_phase: AppState.currentPhase,
            app_state: AppState,
            updated_at: new Date().toISOString()
          })
          .eq('group_code', AppState.groupCode);

        if (error) throw error;
        debugLog('State synced to database');
      } catch (error) {
        debugLog(`Error syncing state: ${error.message}`);
      }
    }

    // Apply restrictions for Viewer role
    function applyViewerRestrictions() {
      // Disable all interactive elements for viewers
      const interactiveElements = document.querySelectorAll(
        'button:not(.back-button), select, input, .card-option'
      );

      interactiveElements.forEach(el => {
        // Don't disable navigation/back buttons
        if (!el.classList.contains('back-button') &&
            !el.closest('#debug-panel') &&
            el.id !== 'btn-new-session') {
          el.disabled = true;
          el.style.pointerEvents = 'none';
          el.style.opacity = '0.7';
        }
      });

      debugLog('Viewer restrictions applied');
    }

    // Update viewer display with current state
    function updateViewerDisplay() {
      // Update archetype display
      if (AppState.archetypeContext) {
        const archetypeEl = document.getElementById('archetype-result');
        if (archetypeEl) archetypeEl.style.display = 'block';

        const displayName = AppState.archetypeContext.scenario_name || AppState.archetypeContext.archetype;
        const summary = getFirstSentence(AppState.archetypeContext.description);

        const nameEl = document.getElementById('archetype-name');
        const nuanceEl = document.getElementById('archetype-nuance');
        const summaryEl = document.getElementById('archetype-summary');

        if (nameEl) nameEl.textContent = displayName;
        if (nuanceEl) nuanceEl.textContent = AppState.archetypeContext.archetype;
        if (summaryEl) summaryEl.textContent = summary;
      }

      // Update scenario display
      if (AppState.scenario) {
        const scenarioEl = document.getElementById('scenario-result');
        const scenarioTextEl = document.getElementById('scenario-text');
        if (scenarioEl) scenarioEl.style.display = 'block';
        if (scenarioTextEl) scenarioTextEl.innerHTML = formatScenarioWithSections(AppState.scenario);
      }

      // Update what-if questions
      if (AppState.whatIfQuestions && AppState.whatIfQuestions.length > 0) {
        document.getElementById('whatif-result').style.display = 'block';
        displayWhatIfQuestions(AppState.whatIfQuestions);
      }

      // Update selected what-if display (Phase 3) - FIX for custom what-if
      if (AppState.selectedWhatIf) {
        const whatIfDisplay = (AppState.selectedWhatIf || '')
          .replace(/\*\*([^*]+)\*\*/g, '$1')
          .replace(/\*([^*]+)\*/g, '$1');
        const selectedWhatIfEl = document.getElementById('selected-whatif-display');
        if (selectedWhatIfEl) selectedWhatIfEl.textContent = whatIfDisplay;
      }

      // Update consequences - ensure visibility
      if (AppState.consequences) {
        const consequencesResult = document.getElementById('consequences-result');
        const consequencesEl = document.getElementById('consequences-text');
        if (consequencesResult) consequencesResult.style.display = 'block';
        if (consequencesEl) {
          consequencesEl.innerHTML = formatConsequencesOutput(AppState.consequences);
          debugLog('Viewer: consequences updated');
        }
      }

      // Update strategic insights - show in viewer display div
      if (AppState.strategicInsights && AppState.strategicInsights.length > 0) {
        const viewerDisplay = document.getElementById('insights-viewer-display');
        const viewerList = document.getElementById('insights-viewer-list');

        if (viewerDisplay && viewerList) {
          viewerDisplay.style.display = 'block';
          viewerList.innerHTML = AppState.strategicInsights.map((insight, i) =>
            `<p class="body-text" style="margin-bottom: 0.5rem;"><strong style="color: var(--blue);">${i + 1}.</strong> ${insight}</p>`
          ).join('');
        }
      }

      // Update summary if on phase 5 (use parseInt for type safety)
      if (parseInt(AppState.currentPhase) === 5) {
        initPhase5();
        debugLog('Viewer: Phase 5 summary initialized');
      }

      // Update team name if present
      if (AppState.teamName) {
        const teamNameInput = document.getElementById('input-team-name');
        if (teamNameInput) teamNameInput.value = AppState.teamName;
      }

      // Auto-scroll to current phase content
      const currentPhaseEl = document.getElementById(`phase-${AppState.currentPhase}`);
      if (currentPhaseEl) {
        currentPhaseEl.scrollIntoView({ behavior: 'smooth', block: 'start' });
      }
    }

    // Legacy function for backwards compatibility
    async function startSession(language) {
      AppState.language = language;
      updateUILanguage();
      showScreen('screen-main');
      debugLog(`Session started with language: ${language}`);
    }

    // ================================
    // Supabase Data Functions
    // ================================
    async function fetchArchetypeContext(resources, system, values) {
      debugLog(`Fetching archetype context for: ${resources}, ${system}, ${values}`);

      try {
        // New combined table: archetype_context
        // Columns: id, scenario_name, axis_a, axis_b, axis_d, archetype, key_vocabulary (JSONB), description, opportunity, risk
        const { data, error } = await supabaseClient
          .from('archetype_context')
          .select('*')
          .eq('axis_a', resources)
          .eq('axis_b', system)
          .eq('axis_d', values);

        if (error) throw error;

        debugLog(`Archetype context result: ${JSON.stringify(data)}`);
        return data?.[0] || null;
      } catch (error) {
        debugLog(`Error fetching archetype context: ${error.message}`);
        return null;
      }
    }

    async function fetchPrompt(promptId) {
      debugLog(`Fetching prompt: ${promptId}`);

      try {
        // Prompts table uses 'id' column (e.g., 'scenario_writing')
        const { data, error } = await supabaseClient
          .from('prompts')
          .select('*')
          .eq('id', promptId)
          .single();

        if (error) throw error;

        debugLog(`Prompt fetched: ${promptId}`);
        return data;
      } catch (error) {
        debugLog(`Error fetching prompt: ${error.message}`);
        return null;
      }
    }

    async function fetchSectorInfo() {
      debugLog('Fetching sector information');

      try {
        const { data, error } = await supabaseClient
          .from('Sector information: JenV')
          .select('*');

        if (error) throw error;

        debugLog(`Sector info fetched: ${data?.length} records`);
        return data;
      } catch (error) {
        debugLog(`Error fetching sector info: ${error.message}`);
        return null;
      }
    }

    // ================================
    // Gemini API Functions
    // ================================
    async function callGemini(prompt, image = null, type = 'text') {
      debugLog(`Calling Gemini API (type: ${type})`);

      try {
        const response = await fetch('/api/gemini', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ prompt, image, type })
        });

        const data = await response.json();

        if (data.error) {
          throw new Error(data.error);
        }

        debugLog('Gemini response received');
        return data.result;
      } catch (error) {
        debugLog(`Gemini API error: ${error.message}`);
        throw error;
      }
    }

    // ================================
    // Phase 1: Scenario Foundation
    // ================================
    async function determineArchetype() {
      const resources = document.getElementById('select-resources').value;
      const system = document.getElementById('select-system').value;
      const values = document.getElementById('select-values').value;

      if (!resources || !system || !values) {
        alert(t('select_all_options'));
        return;
      }

      debugLog(`Determining archetype for: ${resources}, ${system}, ${values}`);

      // Disable button and show loading
      const btnEl = document.getElementById('btn-determine');
      btnEl.disabled = true;
      btnEl.innerHTML = `<span class="loading-spinner"></span> ${t('determining_archetype')}`;

      // Show archetype result with loading state
      const resultEl = document.getElementById('archetype-result');
      resultEl.style.display = 'block';
      document.getElementById('archetype-name').textContent = '...';
      document.getElementById('archetype-nuance').textContent = '';
      document.getElementById('archetype-summary').textContent = t('connecting');

      try {
        // Get archetype context from combined table
        const archetypeContext = await fetchArchetypeContext(resources, system, values);

        if (!archetypeContext) {
          throw new Error('No archetype context found for this combination');
        }

        // Store in AppState for use in prompts
        AppState.archetype = archetypeContext.archetype;
        AppState.archetypeContext = archetypeContext;

        // Display the archetype - using new column names
        const displayName = archetypeContext.scenario_name || archetypeContext.archetype;
        const summary = getFirstSentence(archetypeContext.description);

        document.getElementById('archetype-name').textContent = displayName;
        document.getElementById('archetype-nuance').textContent = archetypeContext.archetype;
        document.getElementById('archetype-summary').textContent = summary;

        debugLog(`Archetype determined: ${archetypeContext.archetype} (${archetypeContext.scenario_name})`);

        // Generate scenario
        await generateScenario(archetypeContext);

      } catch (error) {
        debugLog(`Error: ${error.message}`);
        document.getElementById('archetype-name').textContent = t('error_archetype');
        document.getElementById('archetype-summary').textContent = error.message;
      } finally {
        // Re-enable button
        btnEl.disabled = false;
        btnEl.textContent = t('determine_archetype');
      }
    }

    // Helper to extract first sentence
    function getFirstSentence(text) {
      if (!text) return '';
      // Split on period followed by space or end of string
      const match = text.match(/^[^.]+\./);
      return match ? match[0].trim() : text.substring(0, 150) + '...';
    }

    async function generateScenario(archetypeContext) {
      debugLog('Generating scenario...');

      const scenarioEl = document.getElementById('scenario-result');
      const scenarioTextEl = document.getElementById('scenario-text');

      scenarioEl.style.display = 'block';
      scenarioTextEl.innerHTML = `<div style="text-align: center; padding: 2rem;"><span class="loading-spinner"></span><br><br>${t('generating_scenario')}</div>`;

      try {
        // Fetch required data from Supabase
        const [promptData, sectorData] = await Promise.all([
          fetchPrompt('scenario_writing'),
          fetchSectorInfo()
        ]);

        debugLog(`Prompt data: ${promptData ? 'loaded' : 'missing'}`);
        debugLog(`Sector data: ${sectorData?.length || 0} items`);

        // Build the prompt for Gemini
        const fullPrompt = buildScenarioPrompt(promptData, archetypeContext, sectorData);

        debugLog('Sending prompt to Gemini...');
        debugLog(`Prompt length: ${fullPrompt.length} chars`);

        // Call Gemini API
        const scenario = await callGemini(fullPrompt, null, 'scenario');

        AppState.scenario = scenario;

        // Format the scenario for display with styled sections
        scenarioTextEl.innerHTML = formatScenarioWithSections(scenario);

        // Sync to database for viewers
        syncStateToDatabase();

        debugLog('Scenario generated successfully');

      } catch (error) {
        debugLog(`Scenario generation error: ${error.message}`);
        scenarioTextEl.innerHTML = `
          <div class="status-message error">
            <p style="margin-bottom: 0.75rem;">Error: ${error.message}</p>
            <button class="btn btn-primary" onclick="determineArchetype()" style="padding: 0.5rem 1rem;">
              Probeer Opnieuw / Try Again
            </button>
          </div>`;
      }
    }

    // Filter out quantum-related entries from sector data (for Phase 1)
    function filterOutQuantum(sectorData) {
      if (!sectorData) return [];
      const quantumKeywords = ['quantum', 'q-day', 'pqc', 'qkd', 'qutech'];
      return sectorData.filter(item => {
        const text = `${item.title} ${item.content}`.toLowerCase();
        return !quantumKeywords.some(keyword => text.includes(keyword));
      });
    }

    function buildScenarioPrompt(promptData, archetypeContext, sectorData) {
      // Get the card choices for context
      const resources = document.getElementById('select-resources').value;
      const system = document.getElementById('select-system').value;
      const values = document.getElementById('select-values').value;

      // Filter out quantum content for Phase 1 scenarios
      const filteredSectorData = filterOutQuantum(sectorData);
      debugLog(`Sector data: ${sectorData?.length || 0} total, ${filteredSectorData.length} after quantum filter`);

      // Format key_vocabulary (JSONB array) as comma-separated string
      const vocabulary = Array.isArray(archetypeContext?.key_vocabulary)
        ? archetypeContext.key_vocabulary.join(', ')
        : archetypeContext?.key_vocabulary || '';

      // Use the prompt from Supabase (column: prompt_text)
      const basePrompt = promptData?.prompt_text || `
Generate a future scenario for the Dutch Ministry of Justice and Security (JenV).
The scenario should be vivid, concrete, and thought-provoking.
Write in ${AppState.language === 'nl' ? 'Dutch' : 'English'}.
      `;

      // Build the context to inject into the prompt
      const context = `
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
INPUT DATA
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

CARD CHOICES:
- Resources: ${resources}
- System: ${system}
- Values: ${values}

SCENARIO: ${archetypeContext?.scenario_name || ''}
ARCHETYPE: ${archetypeContext?.archetype || ''}

ARCHETYPE DESCRIPTION:
${archetypeContext?.description || ''}

KEY VOCABULARY:
${vocabulary}

OPPORTUNITY:
${archetypeContext?.opportunity || ''}

RISK/TENSION:
${archetypeContext?.risk || ''}

SECTOR KNOWLEDGE (Dutch Ministry of Justice and Security - JenV):
${filteredSectorData.map(s => `- [${s.category || 'General'}] ${s.title}: ${s.content}`).join('\n') || 'Focus on justice, security, and law enforcement.'}

OUTPUT LANGUAGE: ${AppState.language === 'nl' ? 'Dutch (Nederlands)' : 'English'}
`;

      return `${basePrompt}\n\n${context}`;
    }

    // ================================
    // SIMPLE MARKDOWN PARSER
    // ================================

    function parseMarkdown(text) {
      if (!text) return '';

      const lines = text.split('\n');
      let html = '';
      let inList = false;
      let inVignette = false;
      let vignetteContent = '';

      for (let i = 0; i < lines.length; i++) {
        let line = lines[i];
        const trimmed = line.trim();

        // Skip empty lines (but close list if open)
        if (!trimmed) {
          if (inList) {
            html += '</ul>';
            inList = false;
          }
          html += '<br>';
          continue;
        }

        // Detect italic block start/end (vignette)
        if (trimmed.startsWith('*') && !trimmed.startsWith('**')) {
          // Check if this is a multi-line italic block
          if (trimmed.endsWith('*') && trimmed.length > 2) {
            // Single line italic - treat as vignette
            const content = trimmed.slice(1, -1);
            html += `<div class="narrative-vignette"><p>${formatInlineMarkdown(content)}</p></div>`;
            continue;
          }
        }

        // Headers: ### or ## or lines that are ALL CAPS or end with :
        if (trimmed.startsWith('###')) {
          if (inList) { html += '</ul>'; inList = false; }
          const headerText = trimmed.replace(/^#{1,4}\s*/, '').replace(/\*\*/g, '');
          html += `<h3 class="section-header">${headerText}</h3>`;
          continue;
        }
        if (trimmed.startsWith('##')) {
          if (inList) { html += '</ul>'; inList = false; }
          const headerText = trimmed.replace(/^#{1,4}\s*/, '').replace(/\*\*/g, '');
          html += `<h3 class="section-header">${headerText}</h3>`;
          continue;
        }

        // ALL CAPS lines or **Header** lines or lines ending with : ‚Üí section header
        const isAllCaps = trimmed === trimmed.toUpperCase() && trimmed.length > 3 && /[A-Z]/.test(trimmed);
        const isBoldHeader = trimmed.startsWith('**') && trimmed.endsWith('**');
        const endsWithColon = trimmed.endsWith(':') && trimmed.length > 5;

        if (isAllCaps || isBoldHeader || endsWithColon) {
          if (inList) { html += '</ul>'; inList = false; }
          const headerText = trimmed.replace(/\*\*/g, '').replace(/:$/, '');
          html += `<h3 class="section-header">${headerText}</h3>`;
          continue;
        }

        // Bullet points: - or ‚Ä¢ or *  (but not *italic*)
        if (trimmed.match(/^[-‚Ä¢]\s/) || (trimmed.startsWith('* ') && !trimmed.endsWith('*'))) {
          if (!inList) {
            html += '<ul class="styled-list">';
            inList = true;
          }
          const content = trimmed.replace(/^[-‚Ä¢*]\s*/, '');
          html += `<li>${formatInlineMarkdown(content)}</li>`;
          continue;
        }

        // Numbered lists: 1. or 1)
        if (trimmed.match(/^\d+[.)]\s/)) {
          if (!inList) {
            html += '<ul class="styled-list">';
            inList = true;
          }
          const content = trimmed.replace(/^\d+[.)]\s*/, '');
          html += `<li>${formatInlineMarkdown(content)}</li>`;
          continue;
        }

        // Regular paragraph
        if (inList) { html += '</ul>'; inList = false; }
        html += `<p>${formatInlineMarkdown(trimmed)}</p>`;
      }

      // Close any open list
      if (inList) html += '</ul>';

      return html;
    }

    function formatInlineMarkdown(text) {
      if (!text) return '';
      return text
        // Bold: **text**
        .replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>')
        // Italic: *text* (but not inside bold)
        .replace(/(?<!\*)\*([^*]+)\*(?!\*)/g, '<em>$1</em>');
    }

    // ================================
    // PHASE 1: SCENARIO OUTPUT
    // ================================

    function formatScenarioOutput(text) {
      return parseMarkdown(text);
    }

    function formatScenarioWithSections(text) {
      return parseMarkdown(text);
    }

    // ================================
    // PHASE 3: CONSEQUENCES OUTPUT
    // ================================

    function formatConsequencesOutput(text) {
      return parseMarkdown(text);
    }

    // ================================
    // Phase 2: What-If Generation
    // ================================

    // Show/hide custom input fields based on dropdown selection
    document.addEventListener('DOMContentLoaded', () => {
      const actorSelect = document.getElementById('select-actor');
      const eventSelect = document.getElementById('select-event');

      if (actorSelect) {
        actorSelect.addEventListener('change', (e) => {
          const customInput = document.getElementById('input-actor-custom');
          customInput.style.display = e.target.value === 'custom' ? 'block' : 'none';
        });
      }

      if (eventSelect) {
        eventSelect.addEventListener('change', (e) => {
          const customInput = document.getElementById('input-event-custom');
          customInput.style.display = e.target.value === 'custom' ? 'block' : 'none';
        });
      }
    });

    async function fetchTechnologyKnowledge(parentTechs = []) {
      debugLog(`Fetching technology knowledge for: ${parentTechs.join(', ')}`);
      try {
        // Filter out empty values
        const validTechs = parentTechs.filter(t => t && t.trim());

        if (validTechs.length === 0) {
          debugLog('No technologies selected, returning empty array');
          return [];
        }

        const { data, error } = await supabaseClient
          .from('technology_knowledge')
          .select('*')
          .in('parent_tech', validTechs);

        if (error) throw error;
        debugLog(`Technology knowledge fetched: ${data?.length || 0} items for ${validTechs.length} parent_techs`);
        return data || [];
      } catch (error) {
        debugLog(`Error fetching technology knowledge: ${error.message}`);
        return [];
      }
    }

    // Phase 2: Fetch ALL applications + ALL key concepts for 3 selected parent_techs
    async function fetchTechKnowledgeForWhatIf(parentTechs = []) {
      debugLog(`Fetching tech knowledge for What-If (applications + key concepts): ${parentTechs.join(', ')}`);
      try {
        const validTechs = parentTechs.filter(t => t && t.trim());
        if (validTechs.length === 0) {
          debugLog('No technologies selected, returning empty array');
          return [];
        }

        const { data, error } = await supabaseClient
          .from('technology_knowledge')
          .select('*')
          .in('parent_tech', validTechs)
          .in('category', ['applications', 'key concepts']);

        if (error) throw error;
        debugLog(`What-If tech knowledge fetched: ${data?.length || 0} items (applications + key concepts)`);
        return data || [];
      } catch (error) {
        debugLog(`Error fetching What-If tech knowledge: ${error.message}`);
        return [];
      }
    }

    // Phase 3: Fetch ALL applications + ELSA + critical materials + key concepts for 2 selected parent_techs
    async function fetchTechKnowledgeForConsequences(parentTechs = []) {
      debugLog(`Fetching tech knowledge for Consequences (full context): ${parentTechs.join(', ')}`);
      try {
        const validTechs = parentTechs.filter(t => t && t.trim());
        if (validTechs.length === 0) {
          debugLog('No technologies selected, returning empty array');
          return [];
        }

        const { data, error } = await supabaseClient
          .from('technology_knowledge')
          .select('*')
          .in('parent_tech', validTechs)
          .in('category', ['applications', 'ELSA', 'critical materials', 'key concepts']);

        if (error) throw error;
        debugLog(`Consequences tech knowledge fetched: ${data?.length || 0} items (full context)`);
        return data || [];
      } catch (error) {
        debugLog(`Error fetching Consequences tech knowledge: ${error.message}`);
        return [];
      }
    }

    async function generateWhatIfQuestions() {
      // Get selections
      const techQuantum = document.getElementById('select-tech-quantum').value;
      const tech2 = document.getElementById('select-tech-2').value;
      const tech3 = document.getElementById('select-tech-3').value;

      let actor = document.getElementById('select-actor').value;
      if (actor === 'custom') {
        actor = document.getElementById('input-actor-custom').value;
      }

      let event = document.getElementById('select-event').value;
      if (event === 'custom') {
        event = document.getElementById('input-event-custom').value;
      }

      // Validate
      if (!tech2 || !tech3 || !actor || !event) {
        alert(t('select_tech_actor_event'));
        return;
      }

      // Store in AppState
      AppState.selectedTechnologies = [techQuantum, tech2, tech3];
      AppState.selectedActor = actor;
      AppState.selectedEvent = event;

      debugLog(`Generating what-if questions for: ${techQuantum}, ${tech2}, ${tech3}, ${actor}, ${event}`);

      // Show loading
      const btnEl = document.getElementById('btn-generate-whatif');
      btnEl.disabled = true;
      btnEl.innerHTML = `<span class="loading-spinner"></span> ${t('generating_whatif')}`;

      const resultEl = document.getElementById('whatif-result');
      resultEl.style.display = 'block';
      document.getElementById('whatif-questions-list').innerHTML = `<div style="text-align: center; padding: 1rem;"><span class="loading-spinner"></span></div>`;

      try {
        // Fetch data from Supabase (filter tech knowledge by selected parent_techs)
        // Phase 2: ALL applications + ALL key concepts for 3 selected techs
        const selectedTechs = [techQuantum, tech2, tech3];
        const [promptData, sectorData, techData] = await Promise.all([
          fetchPrompt('whatif_generation'),
          fetchSectorInfo(),
          fetchTechKnowledgeForWhatIf(selectedTechs)
        ]);

        // Build prompt
        const fullPrompt = buildWhatIfPrompt(promptData, sectorData, techData);

        debugLog('Sending what-if prompt to Gemini...');

        // Call Gemini
        const response = await callGemini(fullPrompt, null, 'whatif');

        // Parse the response into questions
        const questions = parseWhatIfResponse(response);
        AppState.whatIfQuestions = questions;

        // Display questions with radio buttons
        displayWhatIfQuestions(questions);

        // Sync to database for viewers
        syncStateToDatabase();

        debugLog(`Generated ${questions.length} what-if questions`);

      } catch (error) {
        debugLog(`What-if generation error: ${error.message}`);
        document.getElementById('whatif-questions-list').innerHTML = `
          <div class="status-message error">
            <p style="margin-bottom: 0.75rem;">Error: ${error.message}</p>
            <button class="btn btn-primary" onclick="generateWhatIfQuestions()" style="padding: 0.5rem 1rem;">
              Probeer Opnieuw / Try Again
            </button>
          </div>`;
      } finally {
        btnEl.disabled = false;
        btnEl.textContent = t('generate_whatif');
      }
    }

    // Format technology knowledge data for prompts (grouped by parent_tech)
    function formatTechDataForPrompt(techData) {
      if (!techData || techData.length === 0) {
        return '‚ö†Ô∏è WARNING: Technology knowledge data unavailable. Output may be less specific.';
      }

      // Group by parent_tech
      const grouped = {};
      for (const item of techData) {
        const parent = item.parent_tech || 'Other';
        if (!grouped[parent]) grouped[parent] = [];
        grouped[parent].push(item);
      }

      // Format each group
      let result = '';
      for (const [parent, items] of Object.entries(grouped)) {
        result += `\n${parent.toUpperCase()}:\n`;
        for (const item of items) {
          const subUse = item.sub_use ? `[${item.sub_use}]` : '';
          const category = item.category ? `(${item.category})` : '';
          const title = item.title || '';
          const desc = item.description || '';
          result += `- ${subUse} ${title} ${category}: ${desc}\n`;
        }
      }
      return result.trim();
    }

    function buildWhatIfPrompt(promptData, sectorData, techData) {
      const [techQuantum, tech2, tech3] = AppState.selectedTechnologies;
      const actor = AppState.selectedActor;
      const event = AppState.selectedEvent;

      // Format technology names for display
      const formatTech = (t) => t.replace(/_/g, ' ').replace(/\b\w/g, c => c.toUpperCase());

      const basePrompt = promptData?.prompt_text || `
Generate 3 what-if questions based on the selected technologies, actor, and trigger event.
Each question should be provocative and challenge assumptions about the future.
Write in ${AppState.language === 'nl' ? 'Dutch' : 'English'}.
      `;

      // Replace placeholders in the prompt
      let prompt = basePrompt
        .replace(/\[TECH_1\]/g, formatTech(tech2))
        .replace(/\[TECH_2\]/g, formatTech(tech3))
        .replace(/\[ACTOR\]/g, formatTech(actor))
        .replace(/\[TRIGGER\]/g, formatTech(event));

      const context = `
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
INPUT DATA
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

SELECTED TECHNOLOGIES:
1. Quantum: ${formatTech(techQuantum)}
2. Technology 2: ${formatTech(tech2)}
3. Technology 3: ${formatTech(tech3)}

ACTOR: ${formatTech(actor)}

TRIGGER EVENT: ${formatTech(event)}

ARCHETYPE CONTEXT: ${AppState.archetypeContext?.scenario_name || AppState.archetype}
${AppState.archetypeContext?.description || ''}

‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
‚ö†Ô∏è CRITICAL: TECHNOLOGY KNOWLEDGE BASE
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
The following contains verified, curated information about the selected
technologies. Your response MUST be grounded in this data.

DO NOT use general knowledge or assumptions.
DO reference specific applications, ELSA implications, and key concepts listed below.

${formatTechDataForPrompt(techData)}

‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
‚úì VERIFICATION: Your response must reference at least 1 specific
  item from EACH technology category listed above.
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

SECTOR KNOWLEDGE (JenV):
${sectorData?.map(s => `- [${s.category || 'General'}] ${s.title}: ${s.content}`).join('\n') || 'Dutch Ministry of Justice and Security'}

OUTPUT LANGUAGE: ${AppState.language === 'nl' ? 'Dutch (Nederlands)' : 'English'}
`;

      return `${prompt}\n\n${context}`;
    }

    function parseWhatIfResponse(response) {
      debugLog('Parsing what-if response...');

      // Get selected technologies for tech headers
      const [techQuantum, tech2, tech3] = AppState.selectedTechnologies || ['Quantum', '', ''];
      const formatTech = (t) => t ? t.replace(/_/g, ' ').replace(/\b\w/g, c => c.toUpperCase()) : '';

      // Define tech combinations for each question position
      const techCombinations = [
        ['Quantum', formatTech(tech2)],           // Q1: Quantum + Tech 2
        ['Quantum', formatTech(tech3)],           // Q2: Quantum + Tech 3
        ['Quantum', formatTech(tech2) || formatTech(tech3)]  // Q3: Quantum + one of them
      ];

      let extractedTexts = [];

      // Method 1: Split on numbered patterns (1. / 2. / 3. or 1) / 2) / 3))
      const numberedPattern = /(?:^|\n)\s*(?:\*\*)?(\d)[.)]\*?\*?\s*/g;
      const parts = response.split(/(?:^|\n)\s*(?:\*\*)?[1-3][.)]\*?\*?\s*/);

      // Filter out empty parts and take only parts that look like questions
      for (let i = 1; i < parts.length && extractedTexts.length < 3; i++) {
        let text = parts[i].trim();
        // Remove markdown formatting
        text = text.replace(/\*\*/g, '');
        // Take up to the first question mark or first line if no question mark
        const questionMatch = text.match(/^[^?]+\?/);
        if (questionMatch) {
          extractedTexts.push(questionMatch[0].trim());
        } else {
          const firstLine = text.split('\n')[0].trim();
          if (firstLine.length > 10) {
            extractedTexts.push(firstLine);
          }
        }
      }

      // Method 2: Fallback - look for "What if" or "Wat als" patterns
      if (extractedTexts.length === 0) {
        debugLog('Using What-if pattern fallback...');
        const whatIfPattern = /(?:What if|Wat als)[^?]*\?/gi;
        const matches = response.match(whatIfPattern);
        if (matches) {
          extractedTexts = matches.slice(0, 3).map(m => m.trim());
        }
      }

      // Method 3: Last resort - split by double newlines
      if (extractedTexts.length === 0) {
        debugLog('Using double-newline fallback...');
        const parts = response.split(/\n\n+/);
        for (const part of parts) {
          const cleaned = part.trim();
          if (cleaned.includes('?') && cleaned.length > 20) {
            extractedTexts.push(cleaned.split('?')[0] + '?');
            if (extractedTexts.length >= 3) break;
          }
        }
      }

      // Build final questions array with exactly 3 questions
      const questions = [];
      for (let i = 0; i < 3; i++) {
        questions.push({
          id: i + 1,
          text: extractedTexts[i] || `Question ${i + 1} could not be parsed from response.`,
          techs: techCombinations[i].filter(t => t)
        });
      }

      debugLog(`parseWhatIfResponse: extracted ${extractedTexts.length} questions`);
      return questions;
    }

    function displayWhatIfQuestions(questions) {
      const container = document.getElementById('whatif-questions-list');

      if (questions.length === 0) {
        container.innerHTML = '<p class="body-text">No questions generated. Try again or enter a custom question.</p>';
        return;
      }

      let html = '';
      questions.forEach((q, i) => {
        // Build tech header from question's techs array
        const techHeader = (q.techs || []).join(' + ');

        // Clean question text - remove markdown
        let questionText = (q.text || '')
          .replace(/\*\*/g, '')
          .replace(/(?<!\*)\*([^*]+)\*(?!\*)/g, '$1');

        // Make technology names bold in the question text
        (q.techs || []).forEach(tech => {
          if (tech) {
            const regex = new RegExp(`(${tech})`, 'gi');
            questionText = questionText.replace(regex, '<strong>$1</strong>');
          }
        });

        html += `
          <div class="whatif-card" onclick="selectWhatIf(${i})">
            <label style="display: flex; align-items: flex-start; gap: 0.75rem; cursor: pointer;">
              <input type="radio" name="whatif-selection" value="${i}" style="margin-top: 0.35rem; flex-shrink: 0;">
              <div style="flex: 1;">
                <div class="whatif-tech-header" style="font-weight: 700; color: #0000FF; margin-bottom: 0.5rem; font-size: 0.9rem;">${techHeader}</div>
                <div class="whatif-question">${questionText}</div>
              </div>
            </label>
          </div>
        `;
      });

      container.innerHTML = html;
    }

    function selectWhatIf(index) {
      // Clear custom input when selecting a generated question
      document.getElementById('input-custom-whatif').value = '';

      // Select the radio button
      const radios = document.querySelectorAll('input[name="whatif-selection"]');
      if (radios[index]) {
        radios[index].checked = true;
      }
    }

    function proceedToPhase3() {
      // Get selected question
      const selectedRadio = document.querySelector('input[name="whatif-selection"]:checked');
      const customInput = document.getElementById('input-custom-whatif').value.trim();

      let selectedQuestion = null;
      let selectedTechs = null;

      if (customInput) {
        selectedQuestion = customInput;
        // For custom questions, use all 3 selected technologies
        selectedTechs = AppState.selectedTechnologies || [];
      } else if (selectedRadio) {
        const index = parseInt(selectedRadio.value);
        const questionObj = AppState.whatIfQuestions[index];
        selectedQuestion = questionObj?.text;
        // Get the 2 techs from the selected question
        selectedTechs = questionObj?.techs || [];
      }

      if (!selectedQuestion) {
        alert(t('select_whatif_error'));
        return;
      }

      AppState.selectedWhatIf = selectedQuestion;
      AppState.selectedWhatIfTechs = selectedTechs;
      debugLog(`Selected what-if: ${selectedQuestion}`);
      debugLog(`Selected what-if techs: ${selectedTechs?.join(', ')}`);

      // Sync to database for viewers
      syncStateToDatabase();

      // Navigate to Phase 3 and generate consequences
      goToPhase(3);
      generateConsequences();
    }

    // ================================
    // Phase 3: Consequences
    // ================================

    async function generateConsequences() {
      debugLog('Generating consequences...');

      // Display selected what-if (parse markdown to remove **)
      const whatIfDisplay = (AppState.selectedWhatIf || '')
        .replace(/\*\*([^*]+)\*\*/g, '$1')
        .replace(/\*([^*]+)\*/g, '$1');
      document.getElementById('selected-whatif-display').textContent = whatIfDisplay;

      const resultEl = document.getElementById('consequences-text');
      resultEl.innerHTML = `<div style="text-align: center; padding: 2rem;"><span class="loading-spinner"></span><br><br>${t('generating_consequences')}</div>`;

      try {
        // Fetch data from Supabase
        // Phase 3: ALL applications + ELSA + critical materials + key concepts
        // Only for the 2 techs from the selected what-if question (or all 3 for custom questions)
        const techsForConsequences = AppState.selectedWhatIfTechs || AppState.selectedTechnologies || [];
        debugLog(`Fetching tech knowledge for consequences: ${techsForConsequences.join(', ')}`);

        const [promptData, sectorData, techData] = await Promise.all([
          fetchPrompt('consequence_generation'),
          fetchSectorInfo(),
          fetchTechKnowledgeForConsequences(techsForConsequences)
        ]);

        // Build prompt
        const fullPrompt = buildConsequencePrompt(promptData, sectorData, techData);

        debugLog('Sending consequence prompt to Gemini...');
        debugLog(`Prompt length: ${fullPrompt.length} chars`);

        // Call Gemini
        const response = await callGemini(fullPrompt, null, 'consequences');

        AppState.consequences = response;

        // Format and display with styled sections
        resultEl.innerHTML = formatConsequencesOutput(response);

        // Sync to database for viewers
        syncStateToDatabase();

        debugLog('Consequences generated successfully');

      } catch (error) {
        debugLog(`Consequence generation error: ${error.message}`);
        resultEl.innerHTML = `
          <div class="status-message error">
            <p style="margin-bottom: 0.75rem;">Error: ${error.message}</p>
            <button class="btn btn-primary" onclick="generateConsequences()" style="padding: 0.5rem 1rem;">
              Probeer Opnieuw / Try Again
            </button>
          </div>`;
      }
    }

    function buildConsequencePrompt(promptData, sectorData, techData) {
      const [techQuantum, tech2, tech3] = AppState.selectedTechnologies;
      const formatTech = (t) => t.replace(/_/g, ' ').replace(/\b\w/g, c => c.toUpperCase());

      const basePrompt = promptData?.prompt_text || `
Generate consequences for the selected what-if question, including 2nd and 3rd order effects,
new technology applications, ELSA implications, and who wins/loses.
Write in ${AppState.language === 'nl' ? 'Dutch' : 'English'}.
      `;

      const context = `
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
INPUT DATA
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

SELECTED WHAT-IF QUESTION:
${AppState.selectedWhatIf}

PHASE 1 SCENARIO:
${AppState.scenario || 'No scenario available'}

ARCHETYPE: ${AppState.archetypeContext?.scenario_name || AppState.archetype}
${AppState.archetypeContext?.description || ''}

SELECTED TECHNOLOGIES:
1. ${formatTech(techQuantum)}
2. ${formatTech(tech2)}
3. ${formatTech(tech3)}

ACTOR: ${formatTech(AppState.selectedActor)}
TRIGGER: ${formatTech(AppState.selectedEvent)}

‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
‚ö†Ô∏è CRITICAL: TECHNOLOGY KNOWLEDGE BASE
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
The following contains verified, curated information about the selected
technologies. Your response MUST be grounded in this data.

DO NOT use general knowledge or assumptions.
DO reference specific applications, ELSA implications, and key concepts listed below.

${formatTechDataForPrompt(techData)}

‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
‚úì VERIFICATION: Your response must reference at least 1 specific
  item from EACH technology category listed above.
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

SECTOR KNOWLEDGE (JenV):
${sectorData?.map(s => `- [${s.category || 'General'}] ${s.title}: ${s.content}`).join('\n') || 'Dutch Ministry of Justice and Security'}

OUTPUT LANGUAGE: ${AppState.language === 'nl' ? 'Dutch (Nederlands)' : 'English'}
`;

      return `${basePrompt}\n\n${context}`;
    }

    // ================================
    // Phase 4: Strategic Insights
    // ================================

    function initPhase4() {
      debugLog('Initializing Phase 4...');

      // Restore any existing insights
      const insights = AppState.strategicInsights || [];
      document.getElementById('insight-1').value = insights[0] || '';
      document.getElementById('insight-2').value = insights[1] || '';
      document.getElementById('insight-3').value = insights[2] || '';

      // Add event listeners for debounced sync (only for controller)
      if (AppState.role === 'controller') {
        ['insight-1', 'insight-2', 'insight-3'].forEach(id => {
          const input = document.getElementById(id);
          input.oninput = () => {
            // Update AppState and trigger debounced sync
            AppState.strategicInsights = [
              document.getElementById('insight-1').value.trim(),
              document.getElementById('insight-2').value.trim(),
              document.getElementById('insight-3').value.trim()
            ].filter(i => i.length > 0);
            debouncedSync();
          };
        });
      }

      // Hide error message
      document.getElementById('phase4-error').style.display = 'none';

      debugLog('Phase 4 initialized');
    }

    function proceedToPhase5() {
      // Collect insights
      const insight1 = document.getElementById('insight-1').value.trim();
      const insight2 = document.getElementById('insight-2').value.trim();
      const insight3 = document.getElementById('insight-3').value.trim();

      const insights = [insight1, insight2, insight3].filter(i => i.length > 0);

      // Validate minimum 2 insights
      if (insights.length < 2) {
        document.getElementById('phase4-error').style.display = 'block';
        debugLog('Phase 4 validation failed: minimum 2 insights required');
        return;
      }

      // Store insights
      AppState.strategicInsights = insights;
      debugLog(`Strategic insights saved: ${insights.length} items`);

      // Sync to database for viewers
      syncStateToDatabase();

      // Navigate to Phase 5
      goToPhase(5);
    }

    // ================================
    // Phase 5: Export & Save
    // ================================

    function initPhase5() {
      debugLog('Initializing Phase 5...');

      const formatTech = (t) => t?.replace(/_/g, ' ').replace(/\b\w/g, c => c.toUpperCase()) || '';

      // Restore team name if exists
      document.getElementById('input-team-name').value = AppState.teamName || '';
      document.getElementById('team-name-error').style.display = 'none';

      // 1. Foundation: Binary choices + Archetype
      document.getElementById('summary-resources').textContent =
        AppState.archetypeContext?.axis_a || document.getElementById('select-resources')?.value || '-';
      document.getElementById('summary-system').textContent =
        AppState.archetypeContext?.axis_b || document.getElementById('select-system')?.value || '-';
      document.getElementById('summary-values').textContent =
        AppState.archetypeContext?.axis_d || document.getElementById('select-values')?.value || '-';
      document.getElementById('summary-archetype').textContent =
        `${AppState.archetypeContext?.scenario_name || ''} (${AppState.archetypeContext?.archetype || ''})`;

      // 2. The World: Full scenario
      document.getElementById('summary-scenario').textContent = AppState.scenario || '-';

      // 3. The Disruption: Technologies + Actor + Trigger
      document.getElementById('summary-techs').textContent =
        AppState.selectedTechnologies.map(formatTech).join(', ') || '-';
      document.getElementById('summary-actor').textContent =
        formatTech(AppState.selectedActor) || '-';
      document.getElementById('summary-trigger').textContent =
        formatTech(AppState.selectedEvent) || '-';

      // 4. The Provocation: All 3 what-if questions + selected
      const whatIfContainer = document.getElementById('summary-whatif-questions');
      if (AppState.whatIfQuestions && AppState.whatIfQuestions.length > 0) {
        whatIfContainer.innerHTML = AppState.whatIfQuestions.map((q, i) => {
          const isSelected = q.text === AppState.selectedWhatIf;
          const techHeader = (q.techs || []).join(' + ');
          return `
            <div style="margin-bottom: 0.5rem; ${isSelected ? 'background: var(--bg-blue); padding: 0.5rem; border-radius: 4px;' : ''}">
              <p class="body-text" style="font-size: 0.8rem; color: var(--blue); font-weight: 600;">${techHeader}</p>
              <p class="body-text">${i + 1}. ${q.text || ''}</p>
            </div>
          `;
        }).join('');
      } else {
        whatIfContainer.innerHTML = '<p class="body-text" style="opacity: 0.7;">-</p>';
      }
      document.getElementById('summary-selected-whatif').textContent = AppState.selectedWhatIf || '-';

      // 5. Consequences
      const consequencesEl = document.getElementById('summary-consequences');
      if (AppState.consequences) {
        // Simple markdown-like formatting
        consequencesEl.innerHTML = AppState.consequences
          .replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>')
          .replace(/\n/g, '<br>');
      } else {
        consequencesEl.innerHTML = '<p class="body-text" style="opacity: 0.7;">-</p>';
      }

      // 6. The Strategy: Strategic insights
      const insightsEl = document.getElementById('summary-insights');
      if (AppState.strategicInsights && AppState.strategicInsights.length > 0) {
        insightsEl.innerHTML = AppState.strategicInsights.map((insight, i) =>
          `<p class="body-text" style="margin-bottom: 0.25rem;">${i + 1}. ${insight}</p>`
        ).join('');
      } else {
        insightsEl.innerHTML = `<p class="body-text" style="opacity: 0.7;">${t('no_insights')}</p>`;
      }

      // Add debounced sync for team name input (only for controller)
      if (AppState.role === 'controller') {
        document.getElementById('input-team-name').oninput = (e) => {
          AppState.teamName = e.target.value.trim();
          debouncedSync();
        };
      }

      debugLog('Phase 5 summary populated');
    }

    function buildExportText() {
      const formatTech = (t) => t?.replace(/_/g, ' ').replace(/\b\w/g, c => c.toUpperCase()) || '';
      const lang = AppState.language;
      const teamName = AppState.teamName || document.getElementById('input-team-name')?.value || '';

      // Format all 3 what-if questions
      const whatIfQuestionsText = AppState.whatIfQuestions && AppState.whatIfQuestions.length > 0
        ? AppState.whatIfQuestions.map((q, i) => {
            const techHeader = (q.techs || []).join(' + ');
            const isSelected = q.text === AppState.selectedWhatIf;
            return `${i + 1}. [${techHeader}] ${q.text}${isSelected ? ' ‚Üê ' + (lang === 'nl' ? 'GEKOZEN' : 'SELECTED') : ''}`;
          }).join('\n')
        : '-';

      let text = `
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
TECH FUTURES EXPLORER - ${lang === 'nl' ? 'SESSIE RAPPORT' : 'SESSION REPORT'}
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
${lang === 'nl' ? 'Team' : 'Team'}: ${teamName}
${lang === 'nl' ? 'Datum' : 'Date'}: ${new Date().toLocaleString(lang === 'nl' ? 'nl-NL' : 'en-US')}

‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
1. ${lang === 'nl' ? 'DE BASIS' : 'THE FOUNDATION'}
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
Resources: ${AppState.archetypeContext?.axis_a || '-'}
System: ${AppState.archetypeContext?.axis_b || '-'}
Values: ${AppState.archetypeContext?.axis_d || '-'}
Archetype: ${AppState.archetypeContext?.scenario_name || '-'} (${AppState.archetypeContext?.archetype || '-'})

‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
2. ${lang === 'nl' ? 'DE WERELD' : 'THE WORLD'}
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
${AppState.scenario || '-'}

‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
3. ${lang === 'nl' ? 'DE DISRUPTIE' : 'THE DISRUPTION'}
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
${lang === 'nl' ? 'Technologie√´n' : 'Technologies'}: ${AppState.selectedTechnologies.map(formatTech).join(', ')}
Actor: ${formatTech(AppState.selectedActor)}
Trigger: ${formatTech(AppState.selectedEvent)}

‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
4. ${lang === 'nl' ? 'DE PROVOCATIE' : 'THE PROVOCATION'}
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
${whatIfQuestionsText}

${lang === 'nl' ? 'Gekozen vraag' : 'Selected question'}:
${AppState.selectedWhatIf || '-'}

‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
5. ${lang === 'nl' ? 'DE CONSEQUENTIES' : 'THE CONSEQUENCES'}
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
${AppState.consequences || '-'}

‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
6. ${lang === 'nl' ? 'DE STRATEGIE' : 'THE STRATEGY'}
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
${AppState.strategicInsights && AppState.strategicInsights.length > 0 ?
        AppState.strategicInsights.map((insight, i) => `${i + 1}. ${insight}`).join('\n') :
        (lang === 'nl' ? 'Geen inzichten ingevuld' : 'No insights provided')}

‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
Tech Futures Explorer - Quantum Delta NL
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
`;

      return text.trim();
    }

    function validateAndSaveTeamName() {
      const teamNameInput = document.getElementById('input-team-name');
      const teamName = teamNameInput?.value.trim() || '';
      const errorEl = document.getElementById('team-name-error');

      if (!teamName) {
        errorEl.style.display = 'block';
        teamNameInput.focus();
        return false;
      }

      errorEl.style.display = 'none';
      AppState.teamName = teamName;
      return true;
    }

    async function copyToClipboard() {
      // Validate team name first
      if (!validateAndSaveTeamName()) {
        return;
      }

      const text = buildExportText();

      try {
        await navigator.clipboard.writeText(text);
        alert(t('copied_success'));
        debugLog('Text copied to clipboard');
      } catch (error) {
        debugLog(`Clipboard error: ${error.message}`);
        // Fallback for older browsers
        const textarea = document.createElement('textarea');
        textarea.value = text;
        document.body.appendChild(textarea);
        textarea.select();
        document.execCommand('copy');
        document.body.removeChild(textarea);
        alert(t('copied_success'));
      }
    }

    function exportToPDF() {
      // Validate team name first
      if (!validateAndSaveTeamName()) {
        return;
      }

      debugLog('Generating PDF...');

      // Create a printable version
      const text = buildExportText();

      // Open print dialog with formatted content
      const printWindow = window.open('', '_blank');
      printWindow.document.write(`
        <!DOCTYPE html>
        <html>
        <head>
          <title>Tech Futures Explorer - Export</title>
          <style>
            body {
              font-family: 'Courier New', monospace;
              padding: 2rem;
              max-width: 800px;
              margin: 0 auto;
              font-size: 12px;
              line-height: 1.6;
            }
            pre {
              white-space: pre-wrap;
              word-wrap: break-word;
            }
            @media print {
              body { padding: 1rem; }
            }
          </style>
        </head>
        <body>
          <pre>${text.replace(/</g, '&lt;').replace(/>/g, '&gt;')}</pre>
          <scr` + `ipt>
            window.onload = function() {
              window.print();
            }
          </scr` + `ipt>
        </body>
        </html>
      `);
      printWindow.document.close();
    }

    async function saveSession() {
      // Validate team name first
      if (!validateAndSaveTeamName()) {
        document.getElementById('save-status').innerHTML =
          `<p class="status-message error">${t('team_name_required')}</p>`;
        return;
      }

      const statusEl = document.getElementById('save-status');
      const btnEl = document.getElementById('btn-save-session');

      btnEl.disabled = true;
      btnEl.innerHTML = `<span class="loading-spinner"></span>`;
      statusEl.innerHTML = '';

      try {
        const sessionData = {
          team_name: AppState.teamName,
          language: AppState.language,
          axis_a: AppState.archetypeContext?.axis_a || document.getElementById('select-resources')?.value,
          axis_b: AppState.archetypeContext?.axis_b || document.getElementById('select-system')?.value,
          axis_d: AppState.archetypeContext?.axis_d || document.getElementById('select-values')?.value,
          scenario_name: AppState.archetypeContext?.scenario_name,
          archetype_name: AppState.archetypeContext?.archetype,
          generated_scenario: AppState.scenario,
          technologies: AppState.selectedTechnologies,
          actor: AppState.selectedActor,
          trigger_event: AppState.selectedEvent,
          whatif_questions: AppState.whatIfQuestions,
          selected_whatif: AppState.selectedWhatIf,
          consequences: AppState.consequences,
          strategic_insights: AppState.strategicInsights
        };

        debugLog('Saving session data:', JSON.stringify(sessionData));

        const { data, error } = await supabaseClient
          .from('sessions')
          .insert([sessionData])
          .select();

        if (error) throw error;

        AppState.savedSessionId = data?.[0]?.id;

        statusEl.innerHTML = `<p class="status-message success">‚úì ${t('save_success')} (ID: ${AppState.savedSessionId || 'saved'})</p>`;
        debugLog(`Session saved with ID: ${AppState.savedSessionId}`);

      } catch (error) {
        debugLog(`Save error: ${error.message}`);
        statusEl.innerHTML = `<p class="status-message error">${t('save_error')}: ${error.message}</p>`;
      } finally {
        btnEl.disabled = false;
        btnEl.textContent = t('save_to_database');
      }
    }

    async function startNewSession() {
      // Cleanup realtime subscription and live session
      if (realtimeChannel) {
        supabaseClient.removeChannel(realtimeChannel);
        realtimeChannel = null;
      }

      // Delete live session if controller
      if (AppState.role === 'controller' && AppState.groupCode) {
        try {
          await supabaseClient
            .from('live_sessions')
            .delete()
            .eq('group_code', AppState.groupCode);
          debugLog('Live session deleted');
        } catch (error) {
          debugLog(`Error deleting live session: ${error.message}`);
        }
      }

      // Reset AppState including real-time fields
      AppState.role = null;
      AppState.groupCode = null;
      AppState.currentPhase = 1;
      AppState.archetype = null;
      AppState.archetypeContext = null;
      AppState.scenario = null;
      AppState.selectedTechnologies = [];
      AppState.selectedActor = null;
      AppState.selectedEvent = null;
      AppState.whatIfQuestions = [];
      AppState.selectedWhatIf = null;
      AppState.selectedWhatIfTechs = [];
      AppState.consequences = null;
      AppState.strategicInsights = [];
      AppState.teamName = '';
      AppState.savedSessionId = null;

      // Reset form elements
      document.getElementById('select-resources').value = '';
      document.getElementById('select-system').value = '';
      document.getElementById('select-values').value = '';
      document.getElementById('select-tech-2').value = '';
      document.getElementById('select-tech-3').value = '';
      document.getElementById('select-actor').value = '';
      document.getElementById('select-event').value = '';
      document.getElementById('input-custom-whatif').value = '';
      document.getElementById('insight-1').value = '';
      document.getElementById('insight-2').value = '';
      document.getElementById('insight-3').value = '';
      document.getElementById('input-team-name').value = '';
      document.getElementById('group-code-input').value = '';

      // Hide result sections
      document.getElementById('archetype-result').style.display = 'none';
      document.getElementById('scenario-result').style.display = 'none';
      document.getElementById('whatif-result').style.display = 'none';
      document.getElementById('save-status').innerHTML = '';
      document.getElementById('team-name-error').style.display = 'none';
      document.getElementById('phase4-error').style.display = 'none';

      // Reset start screen to role selection
      document.getElementById('role-selection').classList.add('active');
      document.getElementById('language-selection').classList.remove('active');
      document.getElementById('viewer-join').classList.remove('active');
      document.getElementById('controller-code-display').classList.remove('active');
      document.getElementById('viewer-error').style.display = 'none';

      // Hide header badges
      document.getElementById('group-code-badge').style.display = 'none';
      document.getElementById('viewer-badge').style.display = 'none';

      // Remove viewer mode class
      document.body.classList.remove('viewer-mode');

      // Show debug button again
      const debugBtn = document.querySelector('button[onclick="showDebugInfo()"]');
      if (debugBtn) debugBtn.style.display = '';

      // Hide insights viewer display
      const insightsViewerDisplay = document.getElementById('insights-viewer-display');
      if (insightsViewerDisplay) insightsViewerDisplay.style.display = 'none';

      // Go to start screen
      showScreen('screen-start');

      debugLog('New session started - state reset');
    }

    // ================================
    // Camera Functions
    // ================================

    let cameraStream = null;
    let currentCameraPhase = null;
    let capturedImageData = null;

    async function openCamera(phase) {
      currentCameraPhase = phase;
      capturedImageData = null;

      const modal = document.getElementById('camera-modal');
      const video = document.getElementById('camera-video');
      const errorEl = document.getElementById('camera-error');
      const liveView = document.getElementById('camera-live');
      const previewView = document.getElementById('camera-preview');
      const processingView = document.getElementById('camera-processing');

      // Reset UI state
      liveView.style.display = 'flex';
      previewView.style.display = 'none';
      processingView.style.display = 'none';
      errorEl.style.display = 'none';
      document.getElementById('btn-capture').style.display = 'inline-block';
      document.getElementById('btn-retake').style.display = 'none';
      document.getElementById('btn-use-photo').style.display = 'none';

      // Update title and hint based on phase
      if (phase === 'phase1') {
        document.getElementById('camera-title').textContent = 'üì∑ ' + (AppState.language === 'nl' ? 'Scan 3 Kaarten' : 'Scan 3 Cards');
        document.getElementById('camera-hint').textContent = AppState.language === 'nl'
          ? 'Plaats Resources, System en Values kaarten in beeld'
          : 'Position Resources, System and Values cards in frame';
      } else {
        document.getElementById('camera-title').textContent = 'üì∑ ' + (AppState.language === 'nl' ? 'Scan 5 Kaarten' : 'Scan 5 Cards');
        document.getElementById('camera-hint').textContent = AppState.language === 'nl'
          ? 'Plaats 3 Tech + 1 Actor + 1 Event kaarten in beeld'
          : 'Position 3 Tech + 1 Actor + 1 Event cards in frame';
      }

      modal.style.display = 'flex';

      try {
        // Request camera access
        cameraStream = await navigator.mediaDevices.getUserMedia({
          video: {
            facingMode: 'environment', // Prefer back camera on mobile
            width: { ideal: 1920 },
            height: { ideal: 1080 }
          }
        });

        video.srcObject = cameraStream;
        await video.play();
        debugLog('Camera opened successfully');

      } catch (error) {
        debugLog(`Camera error: ${error.message}`);
        errorEl.textContent = t('camera_error') + ': ' + error.message;
        errorEl.style.display = 'block';
        liveView.style.display = 'none';
      }
    }

    function closeCamera() {
      const modal = document.getElementById('camera-modal');
      const video = document.getElementById('camera-video');

      // Stop camera stream
      if (cameraStream) {
        cameraStream.getTracks().forEach(track => track.stop());
        cameraStream = null;
      }

      video.srcObject = null;
      modal.style.display = 'none';
      currentCameraPhase = null;
      capturedImageData = null;

      debugLog('Camera closed');
    }

    function capturePhoto() {
      const video = document.getElementById('camera-video');
      const canvas = document.getElementById('camera-canvas');
      const image = document.getElementById('camera-image');
      const liveView = document.getElementById('camera-live');
      const previewView = document.getElementById('camera-preview');

      // Set canvas size to video size
      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;

      // Draw video frame to canvas
      const ctx = canvas.getContext('2d');
      ctx.drawImage(video, 0, 0);

      // Get image data as base64
      capturedImageData = canvas.toDataURL('image/jpeg', 0.9);

      // Show preview
      image.src = capturedImageData;
      liveView.style.display = 'none';
      previewView.style.display = 'flex';

      // Update buttons
      document.getElementById('btn-capture').style.display = 'none';
      document.getElementById('btn-retake').style.display = 'inline-block';
      document.getElementById('btn-use-photo').style.display = 'inline-block';

      debugLog('Photo captured');
    }

    function retakePhoto() {
      const liveView = document.getElementById('camera-live');
      const previewView = document.getElementById('camera-preview');

      capturedImageData = null;

      // Show live view again
      liveView.style.display = 'flex';
      previewView.style.display = 'none';

      // Update buttons
      document.getElementById('btn-capture').style.display = 'inline-block';
      document.getElementById('btn-retake').style.display = 'none';
      document.getElementById('btn-use-photo').style.display = 'none';

      debugLog('Retaking photo');
    }

    async function usePhoto() {
      if (!capturedImageData) return;

      const previewView = document.getElementById('camera-preview');
      const processingView = document.getElementById('camera-processing');
      const errorEl = document.getElementById('camera-error');

      // Show processing state
      previewView.style.display = 'none';
      processingView.style.display = 'flex';
      document.getElementById('camera-processing-text').textContent = t('analyzing_cards');
      document.getElementById('btn-retake').style.display = 'none';
      document.getElementById('btn-use-photo').style.display = 'none';
      errorEl.style.display = 'none';

      try {
        // Extract base64 data (remove data:image/jpeg;base64, prefix)
        const base64Image = capturedImageData.split(',')[1];

        // Build prompt based on phase
        let prompt;
        if (currentCameraPhase === 'phase1') {
          prompt = `Analyze this image of cards from a futures workshop.
Identify the 3 binary choice cards shown:
1. RESOURCES axis: Look for a card showing either "Abundance" or "Limits"
2. SYSTEM axis: Look for a card showing either "Stable" or "Breaks"
3. VALUES axis: Look for a card showing either "Collective" or "Individual"

Respond in JSON format only:
{
  "resources": "Abundance" or "Limits",
  "system": "Stable" or "Breaks",
  "values": "Collective" or "Individual",
  "confidence": "high", "medium", or "low"
}

If you cannot identify a card clearly, use null for that value.`;
        } else {
          prompt = `Analyze this image of cards from a futures workshop.
Identify 5 cards shown:
1. QUANTUM TECHNOLOGY: Always "quantum" (this is fixed)
2. TECHNOLOGY 2: One of "AGI", "Neuro tech", "biotech", "Robotics", "Climate tech"
3. TECHNOLOGY 3: One of "AGI", "Neuro tech", "biotech", "Robotics", "Climate tech"
4. ACTOR: One of "criminal_networks", "foreign_states", "big_tech", "research_institutions", "ngos", "citizens", "journalists", "startups", "insurance_companies"
5. TRIGGER EVENT: One of "major_breakthrough", "security_breach", "regulatory_shift", "talent_exodus", "international_treaty", "maturity_tipping_point", "loss_of_control", "public_scandal", "market_collapse"

Respond in JSON format only:
{
  "quantum_tech": "quantum",
  "tech_2": one of "AGI", "Neuro tech", "biotech", "Robotics", "Climate tech",
  "tech_3": one of "AGI", "Neuro tech", "biotech", "Robotics", "Climate tech",
  "actor": one of the actor values,
  "event": one of the event values,
  "confidence": "high", "medium", or "low"
}

If you cannot identify a card clearly, use null for that value.`;
        }

        debugLog('Sending image to Gemini for analysis...');

        // Call Gemini with image
        const response = await callGemini(prompt, base64Image, 'vision');

        debugLog('Gemini response: ' + response);

        // Parse the response
        const result = parseCardScanResponse(response);

        if (result) {
          // Apply results to dropdowns
          applyCardScanResults(result);

          // Close camera and show success
          closeCamera();
          debugLog('Cards detected and applied successfully');
        } else {
          throw new Error(t('card_scan_failed'));
        }

      } catch (error) {
        debugLog(`Card scan error: ${error.message}`);
        processingView.style.display = 'none';
        previewView.style.display = 'flex';
        errorEl.textContent = error.message;
        errorEl.style.display = 'block';
        document.getElementById('btn-retake').style.display = 'inline-block';
        document.getElementById('btn-use-photo').style.display = 'inline-block';
      }
    }

    function parseCardScanResponse(response) {
      try {
        // Try to extract JSON from the response
        let jsonStr = response;

        // If response contains markdown code block, extract it
        const jsonMatch = response.match(/```(?:json)?\s*([\s\S]*?)\s*```/);
        if (jsonMatch) {
          jsonStr = jsonMatch[1];
        }

        // Try to find JSON object in the response
        const objectMatch = jsonStr.match(/\{[\s\S]*\}/);
        if (objectMatch) {
          jsonStr = objectMatch[0];
        }

        const parsed = JSON.parse(jsonStr);
        debugLog('Parsed card scan result: ' + JSON.stringify(parsed));
        return parsed;
      } catch (error) {
        debugLog('Failed to parse card scan response: ' + error.message);
        return null;
      }
    }

    function applyCardScanResults(result) {
      if (currentCameraPhase === 'phase1') {
        // Apply Phase 1 results (capitalized values match Supabase archetype_context)
        if (result.resources) {
          document.getElementById('select-resources').value = result.resources;
        }
        if (result.system) {
          document.getElementById('select-system').value = result.system;
        }
        if (result.values) {
          document.getElementById('select-values').value = result.values;
        }
        debugLog(`Phase 1 cards applied: resources=${result.resources}, system=${result.system}, values=${result.values}`);
      } else {
        // Apply Phase 2 results
        // Quantum is always "quantum"
        if (result.quantum_tech) {
          document.getElementById('select-tech-quantum').value = 'quantum';
        }
        // Tech 2 & 3 use exact case-sensitive values (match Supabase parent_tech)
        if (result.tech_2) {
          document.getElementById('select-tech-2').value = result.tech_2;
        }
        if (result.tech_3) {
          document.getElementById('select-tech-3').value = result.tech_3;
        }
        // Actor and event use lowercase values
        if (result.actor) {
          document.getElementById('select-actor').value = result.actor.toLowerCase();
          // Hide custom input if visible
          document.getElementById('input-actor-custom').style.display = 'none';
        }
        if (result.event) {
          document.getElementById('select-event').value = result.event.toLowerCase();
          // Hide custom input if visible
          document.getElementById('input-event-custom').style.display = 'none';
        }
        debugLog(`Phase 2 cards applied: quantum=${result.quantum_tech}, tech2=${result.tech_2}, tech3=${result.tech_3}, actor=${result.actor}, event=${result.event}`);
      }
    }

    // ================================
    // Connection Test
    // ================================
    async function testConnection() {
      const statusEl = document.getElementById('connection-status');

      try {
        // Test Supabase connection by fetching archetype context
        const { data, error } = await supabaseClient
          .from('archetype_context')
          .select('*')
          .limit(1);

        if (error) throw error;

        statusEl.className = 'status-message success';
        statusEl.innerHTML = `‚úì ${t('connected')}`;
        debugLog('Connection test successful');

        // Log table info
        debugLog(`Sample archetype context: ${JSON.stringify(data)}`);

      } catch (error) {
        statusEl.className = 'status-message error';
        statusEl.innerHTML = `‚úó ${t('connection_error')}: ${error.message}`;
        debugLog(`Connection test failed: ${error.message}`);
      }
    }

    // ================================
    // Initialize Application
    // ================================
    document.addEventListener('DOMContentLoaded', async () => {
      debugLog('Application initializing...');

      // Initialize Supabase
      if (initSupabase()) {
        // Test the connection
        await testConnection();
      }

      debugLog('Application ready');
    });
  </script>

</body>
</html>
