<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Tech Futures Explorer - Quantum Delta NL</title>

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Roboto+Mono:wght@400;500&display=swap" rel="stylesheet">

  <!-- Supabase Client -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    /* ================================
       QDNL Brand Colors & Variables
       ================================ */
    :root {
      /* Primary Colors */
      --black: #000000;
      --red: #FF0000;
      --blue: #0000FF;
      --white: #FFFFFF;
      --magenta: #FF00FF;

      /* Background Colors */
      --bg-grey: #EDF0F2;
      --bg-red: #FFEBEB;
      --bg-blue: #EBEBFF;
      --bg-magenta: #FFE4FF;

      /* Typography */
      --font-mono: 'Roboto Mono', monospace;
      --font-body: Arial, sans-serif; /* Fallback for Shape font */
    }

    /* ================================
       Reset & Base Styles
       ================================ */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: var(--font-body);
      background-color: var(--bg-grey);
      color: var(--black);
      min-height: 100vh;
    }

    /* ================================
       Typography Styles (QDNL)
       ================================ */
    .label {
      font-family: var(--font-mono);
      text-transform: uppercase;
      text-decoration: underline;
      letter-spacing: 0.1em;
      font-size: 0.75rem;
    }

    .headline {
      font-family: var(--font-body);
      font-weight: 100;
      font-size: 2.5rem;
      line-height: 1.2;
    }

    .sub-headline {
      font-family: var(--font-mono);
      font-weight: 400;
      font-size: 1.125rem;
    }

    .body-text {
      font-family: var(--font-body);
      font-weight: 400;
      font-size: 1rem;
      line-height: 1.6;
    }

    .small-label {
      font-family: var(--font-mono);
      text-transform: uppercase;
      letter-spacing: 0.1em;
      font-size: 0.625rem;
    }

    /* ================================
       Layout Components
       ================================ */
    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 2rem;
    }

    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 1rem 2rem;
      background: var(--white);
      border-bottom: 2px solid var(--black);
    }

    .logo {
      font-family: var(--font-mono);
      font-weight: 500;
      font-size: 1.25rem;
      letter-spacing: 0.05em;
    }

    .phase-indicator {
      display: flex;
      gap: 0.5rem;
    }

    .phase-dot {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      border: 2px solid var(--black);
      background: var(--white);
    }

    .phase-dot.active {
      background: var(--red);
    }

    .phase-dot.completed {
      background: var(--blue);
    }

    /* ================================
       Button Styles
       ================================ */
    .btn {
      font-family: var(--font-mono);
      text-transform: uppercase;
      letter-spacing: 0.1em;
      padding: 0.75rem 1.5rem;
      border: 2px solid var(--black);
      background: var(--white);
      cursor: pointer;
      transition: all 0.2s ease;
      font-size: 0.875rem;
    }

    .btn:hover {
      background: var(--black);
      color: var(--white);
    }

    .btn-primary {
      background: var(--red);
      color: var(--white);
      border-color: var(--red);
    }

    .btn-primary:hover {
      background: var(--black);
      border-color: var(--black);
    }

    .btn-secondary {
      background: var(--blue);
      color: var(--white);
      border-color: var(--blue);
    }

    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    /* ================================
       Card Styles
       ================================ */
    .card {
      background: var(--white);
      border: 2px solid var(--black);
      padding: 1.5rem;
      margin-bottom: 1rem;
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1rem;
      padding-bottom: 0.5rem;
      border-bottom: 1px solid var(--black);
    }

    /* ================================
       Screen/View Styles
       ================================ */
    .screen {
      display: none;
      min-height: calc(100vh - 80px);
    }

    .screen.active {
      display: block;
    }

    /* ================================
       Language Selection Screen
       ================================ */
    #screen-start {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
      background: var(--white);
    }

    .start-content {
      text-align: center;
      max-width: 600px;
    }

    .language-buttons {
      display: flex;
      gap: 1rem;
      margin-top: 2rem;
      justify-content: center;
    }

    .language-btn {
      padding: 1.5rem 3rem;
      font-size: 1.125rem;
    }

    /* ================================
       Status/Loading States
       ================================ */
    .status-message {
      padding: 1rem;
      margin: 1rem 0;
      border: 2px solid var(--black);
      font-family: var(--font-mono);
      font-size: 0.875rem;
    }

    .status-message.error {
      background: var(--bg-red);
      border-color: var(--red);
    }

    .status-message.success {
      background: var(--bg-blue);
      border-color: var(--blue);
    }

    .status-message.loading {
      background: var(--bg-grey);
    }

    .loading-spinner {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 2px solid var(--black);
      border-top-color: transparent;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* ================================
       Debug Panel (Development)
       ================================ */
    #debug-panel {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: var(--black);
      color: var(--white);
      padding: 1rem;
      font-family: var(--font-mono);
      font-size: 0.75rem;
      max-height: 200px;
      overflow-y: auto;
    }

    #debug-panel.hidden {
      display: none;
    }

    .debug-toggle {
      position: fixed;
      bottom: 1rem;
      right: 1rem;
      z-index: 1000;
    }
  </style>
</head>
<body>

  <!-- ================================
       Start Screen (Language Selection)
       ================================ -->
  <div id="screen-start" class="screen active">
    <div class="start-content">
      <p class="label">Quantum Delta NL</p>
      <h1 class="headline" style="margin: 1rem 0;">Tech Futures Explorer</h1>
      <p class="sub-headline" style="margin-bottom: 2rem;">
        Emerging Technologies Futures Exploration Tool
      </p>
      <p class="body-text" id="start-description">
        Verken hoe opkomende technologieën kunnen samenkomen en impact hebben op de samenleving.
      </p>
      <div class="language-buttons">
        <button class="btn language-btn" onclick="startSession('nl')">
          Nederlands
        </button>
        <button class="btn language-btn" onclick="startSession('en')">
          English
        </button>
      </div>

      <!-- Connection Status -->
      <div id="connection-status" class="status-message loading" style="margin-top: 2rem;">
        <span class="loading-spinner"></span>
        Verbinding maken met database...
      </div>
    </div>
  </div>

  <!-- ================================
       Main App Screen
       ================================ -->
  <div id="screen-main" class="screen">
    <header class="header">
      <div class="logo">TECH FUTURES</div>
      <div class="phase-indicator">
        <div class="phase-dot active" data-phase="1" title="Phase 1: Scenario"></div>
        <div class="phase-dot" data-phase="2" title="Phase 2: Disruption"></div>
        <div class="phase-dot" data-phase="3" title="Phase 3: Consequences"></div>
        <div class="phase-dot" data-phase="4" title="Phase 4: Strategy"></div>
        <div class="phase-dot" data-phase="5" title="Phase 5: Export"></div>
      </div>
      <button class="btn" onclick="showDebugInfo()" data-i18n="debug">Debug</button>
    </header>

    <main class="container">
      <!-- Phase 1: Scenario Foundation -->
      <section id="phase-1" class="phase-content active">
        <div class="card">
          <div class="card-header">
            <span class="label" data-i18n="phase1_title">Fase 1: Scenario Basis</span>
          </div>
          <p class="body-text" data-i18n="phase1_intro">
            Selecteer de 3 binaire keuzes om het basisscenario te bepalen.
          </p>

          <!-- Card Selection -->
          <div class="card" style="background: var(--bg-grey); margin-top: 1.5rem;">
            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 1.5rem;">
              <div>
                <label class="small-label" data-i18n="card_resources">Resources</label>
                <select id="select-resources" class="btn" style="width: 100%; margin-top: 0.5rem;">
                  <option value="" data-i18n="select_placeholder">-- Kies --</option>
                  <option value="abundance">Abundance</option>
                  <option value="limits">Limits</option>
                </select>
                <p class="small-label" style="margin-top: 0.5rem; font-size: 0.6rem; text-transform: none; opacity: 0.7;" id="resources-hint"></p>
              </div>
              <div>
                <label class="small-label" data-i18n="card_system">System</label>
                <select id="select-system" class="btn" style="width: 100%; margin-top: 0.5rem;">
                  <option value="" data-i18n="select_placeholder">-- Kies --</option>
                  <option value="stable">Stable</option>
                  <option value="breakdown">Breakdown</option>
                </select>
                <p class="small-label" style="margin-top: 0.5rem; font-size: 0.6rem; text-transform: none; opacity: 0.7;" id="system-hint"></p>
              </div>
              <div>
                <label class="small-label" data-i18n="card_values">Values</label>
                <select id="select-values" class="btn" style="width: 100%; margin-top: 0.5rem;">
                  <option value="" data-i18n="select_placeholder">-- Kies --</option>
                  <option value="collective">Collective</option>
                  <option value="individual">Individual</option>
                </select>
                <p class="small-label" style="margin-top: 0.5rem; font-size: 0.6rem; text-transform: none; opacity: 0.7;" id="values-hint"></p>
              </div>
            </div>
            <button class="btn btn-primary" style="margin-top: 1.5rem; width: 100%;" onclick="determineArchetype()" id="btn-determine" data-i18n="determine_archetype">
              Bepaal Archetype
            </button>
          </div>

          <!-- Archetype Result -->
          <div id="archetype-result" class="card" style="display: none; background: var(--bg-blue); margin-top: 1rem;">
            <p class="small-label" data-i18n="archetype">Archetype</p>
            <h2 class="headline" id="archetype-name" style="margin: 0.5rem 0;"></h2>
            <p class="sub-headline" id="archetype-nuance" style="color: var(--blue);"></p>
            <p class="body-text" id="archetype-summary" style="margin-top: 0.75rem;"></p>
          </div>

          <!-- Generated Scenario -->
          <div id="scenario-result" class="card" style="display: none; background: var(--bg-magenta); margin-top: 1rem;">
            <p class="small-label" data-i18n="generated_scenario">Gegenereerd Scenario</p>
            <div class="body-text" id="scenario-text" style="margin-top: 1rem; white-space: pre-line;"></div>
            <button class="btn btn-primary" style="margin-top: 1.5rem; width: 100%;" onclick="goToPhase(2)" data-i18n="continue_phase2">
              Verder naar Fase 2
            </button>
          </div>
        </div>
      </section>

      <!-- Phase 2: Disruption Introduction -->
      <section id="phase-2" class="phase-content" style="display: none;">
        <div class="card">
          <div class="card-header">
            <span class="label" data-i18n="phase2_title">Fase 2: Disruptie</span>
          </div>
          <p class="body-text" data-i18n="phase2_intro">
            Selecteer technologieën, een actor en een trigger om what-if vragen te genereren.
          </p>

          <!-- Technology Selection -->
          <div class="card" style="background: var(--bg-grey); margin-top: 1.5rem;">
            <p class="small-label" data-i18n="select_technologies">Technologieën (3, inclusief quantum)</p>
            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem; margin-top: 0.75rem;">
              <div>
                <label class="small-label">Quantum Tech</label>
                <select id="select-tech-quantum" class="btn" style="width: 100%; margin-top: 0.5rem;">
                  <option value="quantum_sensing">Quantum Sensing</option>
                  <option value="quantum_computing">Quantum Computing</option>
                  <option value="quantum_communication">Quantum Communication</option>
                </select>
              </div>
              <div>
                <label class="small-label">Technology 2</label>
                <select id="select-tech-2" class="btn" style="width: 100%; margin-top: 0.5rem;">
                  <option value="" data-i18n="select_placeholder">-- Kies --</option>
                  <option value="climate_tech">Climate Tech</option>
                  <option value="biotech">Biotech</option>
                  <option value="neurotech">Neurotech</option>
                  <option value="space_tech">Space Tech</option>
                  <option value="agi">AGI</option>
                  <option value="asi">ASI</option>
                  <option value="robotics">Robotics</option>
                </select>
              </div>
              <div>
                <label class="small-label">Technology 3</label>
                <select id="select-tech-3" class="btn" style="width: 100%; margin-top: 0.5rem;">
                  <option value="" data-i18n="select_placeholder">-- Kies --</option>
                  <option value="climate_tech">Climate Tech</option>
                  <option value="biotech">Biotech</option>
                  <option value="neurotech">Neurotech</option>
                  <option value="space_tech">Space Tech</option>
                  <option value="agi">AGI</option>
                  <option value="asi">ASI</option>
                  <option value="robotics">Robotics</option>
                </select>
              </div>
            </div>

            <!-- Actor and Event -->
            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem; margin-top: 1.5rem;">
              <div>
                <label class="small-label" data-i18n="select_actor">Actor</label>
                <select id="select-actor" class="btn" style="width: 100%; margin-top: 0.5rem;">
                  <option value="" data-i18n="select_placeholder">-- Kies --</option>
                  <option value="criminal_networks">Criminal networks</option>
                  <option value="foreign_states">Foreign states</option>
                  <option value="big_tech">Big Tech</option>
                  <option value="research_institutions">Research institutions</option>
                  <option value="ngos">NGOs</option>
                  <option value="citizens">Citizens</option>
                  <option value="journalists">Journalists</option>
                  <option value="startups">Startups</option>
                  <option value="insurance_companies">Insurance companies</option>
                  <option value="custom">Custom (enter below)</option>
                </select>
                <input type="text" id="input-actor-custom" class="btn" placeholder="Custom actor..." style="width: 100%; margin-top: 0.5rem; display: none;">
              </div>
              <div>
                <label class="small-label" data-i18n="select_event">Trigger Event</label>
                <select id="select-event" class="btn" style="width: 100%; margin-top: 0.5rem;">
                  <option value="" data-i18n="select_placeholder">-- Kies --</option>
                  <option value="major_breakthrough">Major breakthrough</option>
                  <option value="security_breach">Security breach</option>
                  <option value="regulatory_shift">Regulatory shift</option>
                  <option value="talent_exodus">Talent exodus</option>
                  <option value="international_treaty">International treaty</option>
                  <option value="maturity_tipping_point">Maturity tipping point</option>
                  <option value="loss_of_control">Loss of control</option>
                  <option value="public_scandal">Public scandal</option>
                  <option value="market_collapse">Market collapse</option>
                  <option value="custom">Custom (enter below)</option>
                </select>
                <input type="text" id="input-event-custom" class="btn" placeholder="Custom event..." style="width: 100%; margin-top: 0.5rem; display: none;">
              </div>
            </div>

            <button class="btn btn-primary" style="margin-top: 1.5rem; width: 100%;" onclick="generateWhatIfQuestions()" id="btn-generate-whatif" data-i18n="generate_whatif">
              Genereer What-If Vragen
            </button>
          </div>

          <!-- What-If Questions Result -->
          <div id="whatif-result" class="card" style="display: none; background: var(--bg-blue); margin-top: 1rem;">
            <p class="small-label" data-i18n="whatif_questions">What-If Vragen</p>
            <div id="whatif-questions-list" style="margin-top: 1rem;"></div>

            <!-- Custom What-If Input -->
            <div style="margin-top: 1.5rem; padding-top: 1rem; border-top: 1px solid var(--black);">
              <p class="small-label" data-i18n="or_custom_whatif">Of voer een eigen vraag in:</p>
              <textarea id="input-custom-whatif" class="btn" placeholder="What if..." style="width: 100%; height: 80px; margin-top: 0.5rem; resize: vertical; text-transform: none;"></textarea>
            </div>

            <button class="btn btn-primary" style="margin-top: 1rem; width: 100%;" onclick="proceedToPhase3()" id="btn-proceed-phase3" data-i18n="continue_phase3">
              Verder met geselecteerde vraag
            </button>
          </div>
        </div>
      </section>

      <!-- Phase 3: Consequences -->
      <section id="phase-3" class="phase-content" style="display: none;">
        <div class="card">
          <div class="card-header">
            <span class="label" data-i18n="phase3_title">Fase 3: Consequenties</span>
          </div>

          <!-- Selected What-If Display -->
          <div class="card" style="background: var(--bg-blue); margin-bottom: 1rem;">
            <p class="small-label" data-i18n="selected_whatif">Geselecteerde What-If Vraag</p>
            <p class="sub-headline" id="selected-whatif-display" style="margin-top: 0.5rem;"></p>
          </div>

          <!-- Consequences Result -->
          <div id="consequences-result" class="card" style="background: var(--bg-magenta);">
            <p class="small-label" data-i18n="consequences">Consequenties</p>
            <div class="body-text" id="consequences-text" style="margin-top: 1rem; white-space: pre-line;">
              <div style="text-align: center; padding: 2rem;">
                <span class="loading-spinner"></span><br><br>
                <span data-i18n="generating_consequences">Consequenties genereren...</span>
              </div>
            </div>
          </div>

          <button class="btn btn-primary" style="margin-top: 1rem; width: 100%;" onclick="goToPhase(4)" data-i18n="continue_phase4">
            Verder naar Fase 4
          </button>
        </div>
      </section>

      <!-- Phase 4: Strategic Focus -->
      <section id="phase-4" class="phase-content" style="display: none;">
        <div class="card">
          <div class="card-header">
            <span class="label" data-i18n="phase4_title">Fase 4: Strategische Focus</span>
          </div>
          <p class="body-text" data-i18n="phase4_intro">
            Selecteer de belangrijkste consequenties om strategisch te bespreken. Markeer items die aandacht vereisen.
          </p>

          <!-- Consequence Selection -->
          <div id="strategic-consequences" class="card" style="background: var(--bg-grey); margin-top: 1.5rem;">
            <p class="small-label" data-i18n="select_strategic">Selecteer strategische prioriteiten</p>
            <div id="consequence-items" style="margin-top: 1rem;">
              <!-- Populated dynamically -->
            </div>
          </div>

          <!-- Strategic Notes -->
          <div class="card" style="background: var(--bg-blue); margin-top: 1rem;">
            <p class="small-label" data-i18n="strategic_notes">Strategische Notities</p>
            <textarea id="input-strategic-notes" class="btn" placeholder="Notities voor de strategie discussie..." style="width: 100%; height: 120px; margin-top: 0.5rem; resize: vertical; text-transform: none;"></textarea>
          </div>

          <!-- Summary of selected items -->
          <div id="strategic-summary" class="card" style="background: var(--bg-magenta); margin-top: 1rem; display: none;">
            <p class="small-label" data-i18n="strategic_summary">Geselecteerde Prioriteiten</p>
            <div id="strategic-summary-list" style="margin-top: 0.5rem;"></div>
          </div>

          <button class="btn btn-primary" style="margin-top: 1rem; width: 100%;" onclick="goToPhase(5)" data-i18n="continue_phase5">
            Verder naar Export
          </button>
        </div>
      </section>

      <!-- Phase 5: Export -->
      <section id="phase-5" class="phase-content" style="display: none;">
        <div class="card">
          <div class="card-header">
            <span class="label" data-i18n="phase5_title">Fase 5: Export & Opslaan</span>
          </div>
          <p class="body-text" data-i18n="phase5_intro">
            Bekijk de volledige sessie samenvatting en exporteer of sla op voor later gebruik.
          </p>

          <!-- Session Summary -->
          <div id="session-summary" class="card" style="background: var(--bg-grey); margin-top: 1.5rem;">
            <p class="small-label" data-i18n="session_summary">Sessie Samenvatting</p>

            <!-- Archetype & Scenario -->
            <div style="margin-top: 1rem; padding: 1rem; background: var(--white); border: 1px solid var(--black);">
              <p class="small-label" style="color: var(--blue);">ARCHETYPE</p>
              <p class="sub-headline" id="summary-archetype"></p>
              <p class="body-text" id="summary-nuance" style="margin-top: 0.25rem; font-size: 0.875rem; opacity: 0.8;"></p>
            </div>

            <!-- Scenario Preview -->
            <div style="margin-top: 1rem; padding: 1rem; background: var(--white); border: 1px solid var(--black);">
              <p class="small-label" style="color: var(--magenta);">SCENARIO</p>
              <p class="body-text" id="summary-scenario" style="margin-top: 0.5rem; max-height: 150px; overflow-y: auto;"></p>
            </div>

            <!-- What-If Question -->
            <div style="margin-top: 1rem; padding: 1rem; background: var(--white); border: 1px solid var(--black);">
              <p class="small-label" style="color: var(--blue);">WHAT-IF</p>
              <p class="body-text" id="summary-whatif" style="margin-top: 0.5rem;"></p>
            </div>

            <!-- Technologies & Context -->
            <div style="margin-top: 1rem; padding: 1rem; background: var(--white); border: 1px solid var(--black);">
              <p class="small-label" style="color: var(--red);">CONTEXT</p>
              <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem; margin-top: 0.5rem;">
                <p class="body-text"><strong>Technologies:</strong> <span id="summary-techs"></span></p>
                <p class="body-text"><strong>Actor:</strong> <span id="summary-actor"></span></p>
                <p class="body-text"><strong>Trigger:</strong> <span id="summary-trigger"></span></p>
              </div>
            </div>

            <!-- Strategic Priorities -->
            <div style="margin-top: 1rem; padding: 1rem; background: var(--white); border: 1px solid var(--black);">
              <p class="small-label" style="color: var(--magenta);">STRATEGISCHE PRIORITEITEN</p>
              <div id="summary-priorities" style="margin-top: 0.5rem;"></div>
              <div id="summary-notes" style="margin-top: 0.5rem; font-style: italic;"></div>
            </div>
          </div>

          <!-- Export Options -->
          <div class="card" style="background: var(--bg-blue); margin-top: 1rem;">
            <p class="small-label" data-i18n="export_options">Export Opties</p>
            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem; margin-top: 1rem;">
              <button class="btn btn-secondary" onclick="exportToPDF()" data-i18n="export_pdf">
                Download PDF
              </button>
              <button class="btn btn-secondary" onclick="copyToClipboard()" data-i18n="copy_summary">
                Kopieer Tekst
              </button>
            </div>
          </div>

          <!-- Save to Database -->
          <div class="card" style="background: var(--bg-magenta); margin-top: 1rem;">
            <p class="small-label" data-i18n="save_session">Sessie Opslaan</p>
            <div style="margin-top: 0.75rem;">
              <label class="small-label" data-i18n="session_name">Sessie Naam</label>
              <input type="text" id="input-session-name" class="btn" placeholder="Geef een naam aan deze sessie..." style="width: 100%; margin-top: 0.5rem; text-transform: none;">
            </div>
            <button class="btn btn-primary" style="margin-top: 1rem; width: 100%;" onclick="saveSession()" id="btn-save-session" data-i18n="save_to_database">
              Opslaan in Database
            </button>
            <div id="save-status" style="margin-top: 0.75rem;"></div>
          </div>

          <!-- New Session Button -->
          <button class="btn" style="margin-top: 1.5rem; width: 100%;" onclick="startNewSession()" data-i18n="start_new">
            Start Nieuwe Sessie
          </button>
        </div>
      </section>
    </main>
  </div>

  <!-- Debug Toggle -->
  <button class="btn debug-toggle" onclick="toggleDebug()">DB</button>

  <!-- Debug Panel -->
  <div id="debug-panel" class="hidden">
    <strong>Debug Log:</strong>
    <pre id="debug-log"></pre>
  </div>

  <!-- ================================
       JavaScript Application
       ================================ -->
  <script>
    // ================================
    // Configuration
    // ================================
    const SUPABASE_URL = 'https://ccfyvpqtxypiawbbftgs.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNjZnl2cHF0eHlwaWF3YmJmdGdzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY4MzIzOTYsImV4cCI6MjA4MjQwODM5Nn0.C-_T4ZmhcB1rihlcnpwUC_APohAOGEE9nQREmsXBTVg';

    // ================================
    // Global State
    // ================================
    const AppState = {
      language: 'nl',
      currentPhase: 1,
      sessionId: null,
      archetype: null,
      archetypeMapping: null,
      archetypeDescription: null,
      scenario: null,
      selectedTechnologies: [],
      selectedActor: null,
      selectedEvent: null,
      whatIfQuestions: [],
      selectedWhatIf: null,
      consequences: null,
      strategicPriorities: [],
      strategicNotes: '',
      savedSessionId: null
    };

    // ================================
    // Supabase Client
    // ================================
    let supabaseClient = null;

    function initSupabase() {
      try {
        supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        debugLog('Supabase client initialized');
        return true;
      } catch (error) {
        debugLog('Supabase init error: ' + error.message);
        return false;
      }
    }

    // ================================
    // Language/i18n System
    // ================================
    const translations = {
      nl: {
        phase1_title: 'Fase 1: Scenario Basis',
        phase1_intro: 'Selecteer de 3 binaire keuzes om het basisscenario te bepalen.',
        card_resources: 'Resources',
        card_system: 'System',
        card_values: 'Values',
        select_placeholder: '-- Kies --',
        determine_archetype: 'Genereer Scenario',
        archetype: 'Archetype',
        generated_scenario: 'Gegenereerd Scenario',
        continue_phase2: 'Verder naar Fase 2',
        debug: 'Debug',
        connecting: 'Verbinding maken...',
        connected: 'Verbonden met database',
        connection_error: 'Kan geen verbinding maken met database',
        select_all_options: 'Selecteer alle drie de opties',
        generating_scenario: 'Scenario wordt gegenereerd...',
        determining_archetype: 'Archetype bepalen...',
        error_archetype: 'Fout bij ophalen archetype',
        // Phase 2
        phase2_title: 'Fase 2: Disruptie',
        phase2_intro: 'Selecteer technologieën, een actor en een trigger om what-if vragen te genereren.',
        select_technologies: 'Technologieën (3, inclusief quantum)',
        select_actor: 'Actor',
        select_event: 'Trigger Event',
        generate_whatif: 'Genereer What-If Vragen',
        generating_whatif: 'What-if vragen genereren...',
        whatif_questions: 'What-If Vragen',
        or_custom_whatif: 'Of voer een eigen vraag in:',
        continue_phase3: 'Verder met geselecteerde vraag',
        select_whatif_error: 'Selecteer een what-if vraag of voer een eigen vraag in',
        select_tech_actor_event: 'Selecteer alle technologieën, actor en event',
        // Phase 3
        phase3_title: 'Fase 3: Consequenties',
        selected_whatif: 'Geselecteerde What-If Vraag',
        consequences: 'Consequenties',
        generating_consequences: 'Consequenties genereren...',
        continue_phase4: 'Verder naar Fase 4',
        // Phase 4
        phase4_title: 'Fase 4: Strategische Focus',
        phase4_intro: 'Selecteer de belangrijkste consequenties om strategisch te bespreken. Markeer items die aandacht vereisen.',
        select_strategic: 'Selecteer strategische prioriteiten',
        strategic_notes: 'Strategische Notities',
        strategic_summary: 'Geselecteerde Prioriteiten',
        continue_phase5: 'Verder naar Export',
        no_consequences: 'Geen consequenties beschikbaar. Ga terug naar Fase 3.',
        // Phase 5
        phase5_title: 'Fase 5: Export & Opslaan',
        phase5_intro: 'Bekijk de volledige sessie samenvatting en exporteer of sla op voor later gebruik.',
        session_summary: 'Sessie Samenvatting',
        export_options: 'Export Opties',
        export_pdf: 'Download PDF',
        copy_summary: 'Kopieer Tekst',
        save_session: 'Sessie Opslaan',
        session_name: 'Sessie Naam',
        save_to_database: 'Opslaan in Database',
        start_new: 'Start Nieuwe Sessie',
        copied_success: 'Gekopieerd naar klembord!',
        save_success: 'Sessie opgeslagen!',
        save_error: 'Fout bij opslaan',
        no_priorities: 'Geen prioriteiten geselecteerd',
        pdf_generating: 'PDF genereren...'
      },
      en: {
        phase1_title: 'Phase 1: Scenario Foundation',
        phase1_intro: 'Select the 3 binary choices to determine the base scenario.',
        card_resources: 'Resources',
        card_system: 'System',
        card_values: 'Values',
        select_placeholder: '-- Select --',
        determine_archetype: 'Generate Scenario',
        archetype: 'Archetype',
        generated_scenario: 'Generated Scenario',
        continue_phase2: 'Continue to Phase 2',
        debug: 'Debug',
        connecting: 'Connecting...',
        connected: 'Connected to database',
        connection_error: 'Cannot connect to database',
        select_all_options: 'Please select all three options',
        generating_scenario: 'Generating scenario...',
        determining_archetype: 'Determining archetype...',
        error_archetype: 'Error fetching archetype',
        // Phase 2
        phase2_title: 'Phase 2: Disruption',
        phase2_intro: 'Select technologies, an actor, and a trigger to generate what-if questions.',
        select_technologies: 'Technologies (3, including quantum)',
        select_actor: 'Actor',
        select_event: 'Trigger Event',
        generate_whatif: 'Generate What-If Questions',
        generating_whatif: 'Generating what-if questions...',
        whatif_questions: 'What-If Questions',
        or_custom_whatif: 'Or enter your own question:',
        continue_phase3: 'Continue with selected question',
        select_whatif_error: 'Select a what-if question or enter your own',
        select_tech_actor_event: 'Select all technologies, actor, and event',
        // Phase 3
        phase3_title: 'Phase 3: Consequences',
        selected_whatif: 'Selected What-If Question',
        consequences: 'Consequences',
        generating_consequences: 'Generating consequences...',
        continue_phase4: 'Continue to Phase 4',
        // Phase 4
        phase4_title: 'Phase 4: Strategic Focus',
        phase4_intro: 'Select the key consequences for strategic discussion. Mark items requiring attention.',
        select_strategic: 'Select strategic priorities',
        strategic_notes: 'Strategic Notes',
        strategic_summary: 'Selected Priorities',
        continue_phase5: 'Continue to Export',
        no_consequences: 'No consequences available. Go back to Phase 3.',
        // Phase 5
        phase5_title: 'Phase 5: Export & Save',
        phase5_intro: 'Review the full session summary and export or save for later use.',
        session_summary: 'Session Summary',
        export_options: 'Export Options',
        export_pdf: 'Download PDF',
        copy_summary: 'Copy Text',
        save_session: 'Save Session',
        session_name: 'Session Name',
        save_to_database: 'Save to Database',
        start_new: 'Start New Session',
        copied_success: 'Copied to clipboard!',
        save_success: 'Session saved!',
        save_error: 'Error saving',
        no_priorities: 'No priorities selected',
        pdf_generating: 'Generating PDF...'
      }
    };

    function t(key) {
      return translations[AppState.language]?.[key] || translations['en']?.[key] || key;
    }

    function updateUILanguage() {
      document.querySelectorAll('[data-i18n]').forEach(el => {
        const key = el.getAttribute('data-i18n');
        el.textContent = t(key);
      });
      document.documentElement.lang = AppState.language;
    }

    // ================================
    // Debug Utilities
    // ================================
    function debugLog(message) {
      const timestamp = new Date().toLocaleTimeString();
      const logEl = document.getElementById('debug-log');
      if (logEl) {
        logEl.textContent += `[${timestamp}] ${message}\n`;
        logEl.scrollTop = logEl.scrollHeight;
      }
      console.log(`[Debug] ${message}`);
    }

    function toggleDebug() {
      document.getElementById('debug-panel').classList.toggle('hidden');
    }

    function showDebugInfo() {
      debugLog('Current State: ' + JSON.stringify(AppState, null, 2));
    }

    // ================================
    // Screen Navigation
    // ================================
    function showScreen(screenId) {
      document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
      document.getElementById(screenId)?.classList.add('active');
    }

    function goToPhase(phase) {
      AppState.currentPhase = phase;

      // Update phase indicators
      document.querySelectorAll('.phase-dot').forEach(dot => {
        const dotPhase = parseInt(dot.dataset.phase);
        dot.classList.remove('active', 'completed');
        if (dotPhase === phase) dot.classList.add('active');
        if (dotPhase < phase) dot.classList.add('completed');
      });

      // Show correct phase content
      document.querySelectorAll('.phase-content').forEach(p => p.style.display = 'none');
      document.getElementById(`phase-${phase}`).style.display = 'block';

      // Initialize phase-specific content
      if (phase === 4) initPhase4();
      if (phase === 5) initPhase5();

      debugLog(`Navigated to Phase ${phase}`);
    }

    // ================================
    // Session Management
    // ================================
    async function startSession(language) {
      AppState.language = language;
      updateUILanguage();
      showScreen('screen-main');
      debugLog(`Session started with language: ${language}`);
    }

    // ================================
    // Supabase Data Functions
    // ================================
    async function fetchArchetypeMapping(resources, system, values) {
      debugLog(`Fetching archetype for: ${resources}, ${system}, ${values}`);

      try {
        // Table uses axis_a (resources), axis_b (system), axis_c (values)
        const { data, error } = await supabaseClient
          .from('Archetype_mapping')
          .select('*')
          .ilike('axis_a', resources)
          .ilike('axis_b', system)
          .ilike('axis_c', values);

        if (error) throw error;

        debugLog(`Archetype mapping result: ${JSON.stringify(data)}`);
        return data?.[0] || null;
      } catch (error) {
        debugLog(`Error fetching archetype mapping: ${error.message}`);
        return null;
      }
    }

    async function fetchArchetypeDescription(archetypeId) {
      debugLog(`Fetching description for archetype: ${archetypeId}`);

      try {
        // Table uses 'id' column for archetype identifier
        const { data, error } = await supabaseClient
          .from('Archetype description')
          .select('*')
          .eq('id', archetypeId);

        if (error) throw error;

        debugLog(`Archetype description result: ${JSON.stringify(data)}`);
        return data?.[0] || null;
      } catch (error) {
        debugLog(`Error fetching archetype description: ${error.message}`);
        return null;
      }
    }

    async function fetchPrompt(promptId) {
      debugLog(`Fetching prompt: ${promptId}`);

      try {
        // Prompts table uses 'id' column (e.g., 'scenario_writing')
        const { data, error } = await supabaseClient
          .from('prompts')
          .select('*')
          .eq('id', promptId)
          .single();

        if (error) throw error;

        debugLog(`Prompt fetched: ${promptId}`);
        return data;
      } catch (error) {
        debugLog(`Error fetching prompt: ${error.message}`);
        return null;
      }
    }

    async function fetchSectorInfo() {
      debugLog('Fetching sector information');

      try {
        const { data, error } = await supabaseClient
          .from('Sector information: JenV')
          .select('*');

        if (error) throw error;

        debugLog(`Sector info fetched: ${data?.length} records`);
        return data;
      } catch (error) {
        debugLog(`Error fetching sector info: ${error.message}`);
        return null;
      }
    }

    // ================================
    // Gemini API Functions
    // ================================
    async function callGemini(prompt, image = null, type = 'text') {
      debugLog(`Calling Gemini API (type: ${type})`);

      try {
        const response = await fetch('/api/gemini', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ prompt, image, type })
        });

        const data = await response.json();

        if (data.error) {
          throw new Error(data.error);
        }

        debugLog('Gemini response received');
        return data.result;
      } catch (error) {
        debugLog(`Gemini API error: ${error.message}`);
        throw error;
      }
    }

    // ================================
    // Phase 1: Scenario Foundation
    // ================================
    async function determineArchetype() {
      const resources = document.getElementById('select-resources').value;
      const system = document.getElementById('select-system').value;
      const values = document.getElementById('select-values').value;

      if (!resources || !system || !values) {
        alert(t('select_all_options'));
        return;
      }

      debugLog(`Determining archetype for: ${resources}, ${system}, ${values}`);

      // Disable button and show loading
      const btnEl = document.getElementById('btn-determine');
      btnEl.disabled = true;
      btnEl.innerHTML = `<span class="loading-spinner"></span> ${t('determining_archetype')}`;

      // Show archetype result with loading state
      const resultEl = document.getElementById('archetype-result');
      resultEl.style.display = 'block';
      document.getElementById('archetype-name').textContent = '...';
      document.getElementById('archetype-nuance').textContent = '';
      document.getElementById('archetype-summary').textContent = t('connecting');

      try {
        // Get archetype mapping
        const mapping = await fetchArchetypeMapping(resources, system, values);

        if (!mapping) {
          throw new Error('No archetype mapping found');
        }

        // Mapping uses archetype_id and nuance_name/nuance_description
        const archetypeId = mapping.archetype_id;
        AppState.archetype = archetypeId;
        AppState.archetypeMapping = mapping;

        // Get archetype description from the description table
        const description = await fetchArchetypeDescription(archetypeId);
        AppState.archetypeDescription = description;

        // Display the archetype - simplified view
        const displayName = description?.name || archetypeId;
        const nuanceName = mapping.nuance_name;

        // Create a one-sentence summary from the nuance description
        const summary = getFirstSentence(mapping.nuance_description);

        document.getElementById('archetype-name').textContent = displayName;
        document.getElementById('archetype-nuance').textContent = nuanceName;
        document.getElementById('archetype-summary').textContent = summary;

        debugLog(`Archetype determined: ${archetypeId} (${nuanceName})`);

        // Generate scenario
        await generateScenario(archetypeId, description, mapping);

      } catch (error) {
        debugLog(`Error: ${error.message}`);
        document.getElementById('archetype-name').textContent = t('error_archetype');
        document.getElementById('archetype-summary').textContent = error.message;
      } finally {
        // Re-enable button
        btnEl.disabled = false;
        btnEl.textContent = t('determine_archetype');
      }
    }

    // Helper to extract first sentence
    function getFirstSentence(text) {
      if (!text) return '';
      // Split on period followed by space or end of string
      const match = text.match(/^[^.]+\./);
      return match ? match[0].trim() : text.substring(0, 150) + '...';
    }

    async function generateScenario(archetypeId, archetypeDescription, mapping) {
      debugLog('Generating scenario...');

      const scenarioEl = document.getElementById('scenario-result');
      const scenarioTextEl = document.getElementById('scenario-text');

      scenarioEl.style.display = 'block';
      scenarioTextEl.innerHTML = `<div style="text-align: center; padding: 2rem;"><span class="loading-spinner"></span><br><br>${t('generating_scenario')}</div>`;

      try {
        // Fetch required data from Supabase
        const [promptData, sectorData] = await Promise.all([
          fetchPrompt('scenario_writing'),
          fetchSectorInfo()
        ]);

        debugLog(`Prompt data: ${promptData ? 'loaded' : 'missing'}`);
        debugLog(`Sector data: ${sectorData?.length || 0} items`);

        // Build the prompt for Gemini
        const fullPrompt = buildScenarioPrompt(
          promptData,
          archetypeId,
          archetypeDescription,
          mapping,
          sectorData
        );

        debugLog('Sending prompt to Gemini...');
        debugLog(`Prompt length: ${fullPrompt.length} chars`);

        // Call Gemini API
        const scenario = await callGemini(fullPrompt, null, 'scenario');

        AppState.scenario = scenario;

        // Format the scenario for display (preserve markdown-like formatting)
        scenarioTextEl.innerHTML = formatScenarioOutput(scenario);

        debugLog('Scenario generated successfully');

      } catch (error) {
        debugLog(`Scenario generation error: ${error.message}`);
        scenarioTextEl.innerHTML = `<div class="status-message error">Error: ${error.message}</div>`;
      }
    }

    // Filter out quantum-related entries from sector data (for Phase 1)
    function filterOutQuantum(sectorData) {
      if (!sectorData) return [];
      const quantumKeywords = ['quantum', 'q-day', 'pqc', 'qkd', 'qutech'];
      return sectorData.filter(item => {
        const text = `${item.title} ${item.content}`.toLowerCase();
        return !quantumKeywords.some(keyword => text.includes(keyword));
      });
    }

    function buildScenarioPrompt(promptData, archetypeId, archetypeDescription, mapping, sectorData) {
      // Get the card choices for context
      const resources = document.getElementById('select-resources').value;
      const system = document.getElementById('select-system').value;
      const values = document.getElementById('select-values').value;

      // Filter out quantum content for Phase 1 scenarios
      const filteredSectorData = filterOutQuantum(sectorData);
      debugLog(`Sector data: ${sectorData?.length || 0} total, ${filteredSectorData.length} after quantum filter`);

      // Use the prompt from Supabase (column: prompt_text)
      const basePrompt = promptData?.prompt_text || `
Generate a future scenario for the Dutch Ministry of Justice and Security (JenV).
The scenario should be vivid, concrete, and thought-provoking.
Write in ${AppState.language === 'nl' ? 'Dutch' : 'English'}.
      `;

      // Build the context to inject into the prompt
      const context = `
═════════════════════════════════════════════════════════
INPUT DATA
═════════════════════════════════════════════════════════

CARD CHOICES:
- Resources: ${resources} (${mapping?.axis_a_label || ''})
- System: ${system} (${mapping?.axis_b_label || ''})
- Values: ${values} (${mapping?.axis_c_label || ''})

ARCHETYPE: ${archetypeDescription?.name || archetypeId}
${archetypeDescription?.description || ''}

SPECIFIC NUANCE: ${mapping?.nuance_name || ''}
${mapping?.nuance_description || ''}

WRITING GUIDANCE:
${archetypeDescription?.writing_guidance || ''}

KEY VOCABULARY:
${archetypeDescription?.key_vocabulary || ''}

SECTOR KNOWLEDGE (Dutch Ministry of Justice and Security - JenV):
${filteredSectorData.map(s => `- ${s.title}: ${s.content}`).join('\n') || 'Focus on justice, security, and law enforcement.'}

OUTPUT LANGUAGE: ${AppState.language === 'nl' ? 'Dutch (Nederlands)' : 'English'}
`;

      return `${basePrompt}\n\n${context}`;
    }

    function formatScenarioOutput(text) {
      if (!text) return '';

      // Convert markdown-style formatting to HTML
      let formatted = text
        // Bold: **text** -> <strong>text</strong>
        .replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>')
        // Italic: *text* -> <em>text</em>
        .replace(/\*([^*]+)\*/g, '<em>$1</em>')
        // Headers
        .replace(/^### (.+)$/gm, '<h4 style="margin-top: 1.5rem; margin-bottom: 0.5rem;">$1</h4>')
        .replace(/^## (.+)$/gm, '<h3 style="margin-top: 1.5rem; margin-bottom: 0.5rem;">$1</h3>')
        // Bullet points
        .replace(/^- (.+)$/gm, '<li>$1</li>')
        // Wrap consecutive <li> in <ul>
        .replace(/(<li>.*<\/li>\n?)+/g, '<ul style="margin: 0.5rem 0; padding-left: 1.5rem;">$&</ul>')
        // Line breaks
        .replace(/\n\n/g, '</p><p style="margin-top: 1rem;">')
        .replace(/\n/g, '<br>');

      return `<p>${formatted}</p>`;
    }

    // ================================
    // Phase 2: What-If Generation
    // ================================

    // Show/hide custom input fields based on dropdown selection
    document.addEventListener('DOMContentLoaded', () => {
      const actorSelect = document.getElementById('select-actor');
      const eventSelect = document.getElementById('select-event');

      if (actorSelect) {
        actorSelect.addEventListener('change', (e) => {
          const customInput = document.getElementById('input-actor-custom');
          customInput.style.display = e.target.value === 'custom' ? 'block' : 'none';
        });
      }

      if (eventSelect) {
        eventSelect.addEventListener('change', (e) => {
          const customInput = document.getElementById('input-event-custom');
          customInput.style.display = e.target.value === 'custom' ? 'block' : 'none';
        });
      }
    });

    async function fetchTechnologyKnowledge() {
      debugLog('Fetching technology knowledge');
      try {
        const { data, error } = await supabaseClient
          .from('technology_knowledge')
          .select('*');
        if (error) throw error;
        debugLog(`Technology knowledge fetched: ${data?.length || 0} items`);
        return data || [];
      } catch (error) {
        debugLog(`Error fetching technology knowledge: ${error.message}`);
        return [];
      }
    }

    async function generateWhatIfQuestions() {
      // Get selections
      const techQuantum = document.getElementById('select-tech-quantum').value;
      const tech2 = document.getElementById('select-tech-2').value;
      const tech3 = document.getElementById('select-tech-3').value;

      let actor = document.getElementById('select-actor').value;
      if (actor === 'custom') {
        actor = document.getElementById('input-actor-custom').value;
      }

      let event = document.getElementById('select-event').value;
      if (event === 'custom') {
        event = document.getElementById('input-event-custom').value;
      }

      // Validate
      if (!tech2 || !tech3 || !actor || !event) {
        alert(t('select_tech_actor_event'));
        return;
      }

      // Store in AppState
      AppState.selectedTechnologies = [techQuantum, tech2, tech3];
      AppState.selectedActor = actor;
      AppState.selectedEvent = event;

      debugLog(`Generating what-if questions for: ${techQuantum}, ${tech2}, ${tech3}, ${actor}, ${event}`);

      // Show loading
      const btnEl = document.getElementById('btn-generate-whatif');
      btnEl.disabled = true;
      btnEl.innerHTML = `<span class="loading-spinner"></span> ${t('generating_whatif')}`;

      const resultEl = document.getElementById('whatif-result');
      resultEl.style.display = 'block';
      document.getElementById('whatif-questions-list').innerHTML = `<div style="text-align: center; padding: 1rem;"><span class="loading-spinner"></span></div>`;

      try {
        // Fetch data from Supabase
        const [promptData, sectorData, techData] = await Promise.all([
          fetchPrompt('whatif_generation'),
          fetchSectorInfo(),
          fetchTechnologyKnowledge()
        ]);

        // Build prompt
        const fullPrompt = buildWhatIfPrompt(promptData, sectorData, techData);

        debugLog('Sending what-if prompt to Gemini...');

        // Call Gemini
        const response = await callGemini(fullPrompt, null, 'whatif');

        // Parse the response into questions
        const questions = parseWhatIfResponse(response);
        AppState.whatIfQuestions = questions;

        // Display questions with radio buttons
        displayWhatIfQuestions(questions);

        debugLog(`Generated ${questions.length} what-if questions`);

      } catch (error) {
        debugLog(`What-if generation error: ${error.message}`);
        document.getElementById('whatif-questions-list').innerHTML = `<div class="status-message error">Error: ${error.message}</div>`;
      } finally {
        btnEl.disabled = false;
        btnEl.textContent = t('generate_whatif');
      }
    }

    function buildWhatIfPrompt(promptData, sectorData, techData) {
      const [techQuantum, tech2, tech3] = AppState.selectedTechnologies;
      const actor = AppState.selectedActor;
      const event = AppState.selectedEvent;

      // Format technology names for display
      const formatTech = (t) => t.replace(/_/g, ' ').replace(/\b\w/g, c => c.toUpperCase());

      const basePrompt = promptData?.prompt_text || `
Generate 3 what-if questions based on the selected technologies, actor, and trigger event.
Each question should be provocative and challenge assumptions about the future.
Write in ${AppState.language === 'nl' ? 'Dutch' : 'English'}.
      `;

      // Replace placeholders in the prompt
      let prompt = basePrompt
        .replace(/\[TECH_1\]/g, formatTech(tech2))
        .replace(/\[TECH_2\]/g, formatTech(tech3))
        .replace(/\[ACTOR\]/g, formatTech(actor))
        .replace(/\[TRIGGER\]/g, formatTech(event));

      const context = `
═════════════════════════════════════════════════════════
INPUT DATA
═════════════════════════════════════════════════════════

SELECTED TECHNOLOGIES:
1. Quantum: ${formatTech(techQuantum)}
2. Technology 2: ${formatTech(tech2)}
3. Technology 3: ${formatTech(tech3)}

ACTOR: ${formatTech(actor)}

TRIGGER EVENT: ${formatTech(event)}

ARCHETYPE CONTEXT: ${AppState.archetypeDescription?.name || AppState.archetype}
${AppState.archetypeMapping?.nuance_description || ''}

TECHNOLOGY KNOWLEDGE:
${techData?.map(t => `- ${t.name || t.technology}: ${t.description || t.content || ''}`).join('\n') || 'Use general knowledge about the selected technologies.'}

SECTOR KNOWLEDGE (JenV):
${sectorData?.slice(0, 15).map(s => `- ${s.title}: ${s.content}`).join('\n') || 'Dutch Ministry of Justice and Security'}

OUTPUT LANGUAGE: ${AppState.language === 'nl' ? 'Dutch (Nederlands)' : 'English'}
`;

      return `${prompt}\n\n${context}`;
    }

    function parseWhatIfResponse(response) {
      // Try to extract questions from the response
      const questions = [];
      const lines = response.split('\n');

      let currentQuestion = null;
      let currentMeta = {};

      for (const line of lines) {
        const trimmed = line.trim();

        // Look for "Question X" or "What if" patterns
        if (trimmed.match(/^(Question\s*\d|What if)/i) || trimmed.startsWith('What if')) {
          if (currentQuestion) {
            questions.push({ text: currentQuestion, ...currentMeta });
          }
          currentQuestion = trimmed.replace(/^Question\s*\d[:\s]*/i, '');
          currentMeta = {};
        } else if (trimmed.startsWith('- Impact Domain:')) {
          currentMeta.impactDomain = trimmed.replace('- Impact Domain:', '').trim();
        } else if (trimmed.startsWith('- Value Tension:')) {
          currentMeta.valueTension = trimmed.replace('- Value Tension:', '').trim();
        } else if (currentQuestion && trimmed && !trimmed.startsWith('-') && !trimmed.startsWith('Impact') && !trimmed.startsWith('Value')) {
          // Continue the question if it spans multiple lines
          if (!currentQuestion.endsWith('?')) {
            currentQuestion += ' ' + trimmed;
          }
        }
      }

      // Add the last question
      if (currentQuestion) {
        questions.push({ text: currentQuestion, ...currentMeta });
      }

      // If parsing failed, just split by double newlines
      if (questions.length === 0) {
        const parts = response.split(/\n\n+/);
        parts.forEach((part, i) => {
          const cleaned = part.trim();
          if (cleaned.toLowerCase().includes('what if') || cleaned.includes('?')) {
            questions.push({ text: cleaned });
          }
        });
      }

      return questions.slice(0, 3); // Return max 3 questions
    }

    function displayWhatIfQuestions(questions) {
      const container = document.getElementById('whatif-questions-list');

      if (questions.length === 0) {
        container.innerHTML = '<p class="body-text">No questions generated. Try again or enter a custom question.</p>';
        return;
      }

      let html = '';
      questions.forEach((q, i) => {
        html += `
          <div class="card" style="background: var(--white); margin-bottom: 0.75rem; cursor: pointer;" onclick="selectWhatIf(${i})">
            <label style="display: flex; align-items: flex-start; gap: 0.75rem; cursor: pointer;">
              <input type="radio" name="whatif-selection" value="${i}" style="margin-top: 0.25rem;">
              <div>
                <p class="body-text" style="margin: 0;">${q.text}</p>
                ${q.impactDomain ? `<p class="small-label" style="margin-top: 0.5rem; opacity: 0.7;">Impact: ${q.impactDomain}</p>` : ''}
                ${q.valueTension ? `<p class="small-label" style="opacity: 0.7;">Tension: ${q.valueTension}</p>` : ''}
              </div>
            </label>
          </div>
        `;
      });

      container.innerHTML = html;
    }

    function selectWhatIf(index) {
      // Clear custom input when selecting a generated question
      document.getElementById('input-custom-whatif').value = '';

      // Select the radio button
      const radios = document.querySelectorAll('input[name="whatif-selection"]');
      if (radios[index]) {
        radios[index].checked = true;
      }
    }

    function proceedToPhase3() {
      // Get selected question
      const selectedRadio = document.querySelector('input[name="whatif-selection"]:checked');
      const customInput = document.getElementById('input-custom-whatif').value.trim();

      let selectedQuestion = null;

      if (customInput) {
        selectedQuestion = customInput;
      } else if (selectedRadio) {
        const index = parseInt(selectedRadio.value);
        selectedQuestion = AppState.whatIfQuestions[index]?.text;
      }

      if (!selectedQuestion) {
        alert(t('select_whatif_error'));
        return;
      }

      AppState.selectedWhatIf = selectedQuestion;
      debugLog(`Selected what-if: ${selectedQuestion}`);

      // Navigate to Phase 3 and generate consequences
      goToPhase(3);
      generateConsequences();
    }

    // ================================
    // Phase 3: Consequences
    // ================================

    async function generateConsequences() {
      debugLog('Generating consequences...');

      // Display selected what-if
      document.getElementById('selected-whatif-display').textContent = AppState.selectedWhatIf;

      const resultEl = document.getElementById('consequences-text');
      resultEl.innerHTML = `<div style="text-align: center; padding: 2rem;"><span class="loading-spinner"></span><br><br>${t('generating_consequences')}</div>`;

      try {
        // Fetch data from Supabase
        const [promptData, sectorData, techData] = await Promise.all([
          fetchPrompt('consequence_generation'),
          fetchSectorInfo(),
          fetchTechnologyKnowledge()
        ]);

        // Build prompt
        const fullPrompt = buildConsequencePrompt(promptData, sectorData, techData);

        debugLog('Sending consequence prompt to Gemini...');
        debugLog(`Prompt length: ${fullPrompt.length} chars`);

        // Call Gemini
        const response = await callGemini(fullPrompt, null, 'consequences');

        AppState.consequences = response;

        // Format and display
        resultEl.innerHTML = formatScenarioOutput(response);

        debugLog('Consequences generated successfully');

      } catch (error) {
        debugLog(`Consequence generation error: ${error.message}`);
        resultEl.innerHTML = `<div class="status-message error">Error: ${error.message}</div>`;
      }
    }

    function buildConsequencePrompt(promptData, sectorData, techData) {
      const [techQuantum, tech2, tech3] = AppState.selectedTechnologies;
      const formatTech = (t) => t.replace(/_/g, ' ').replace(/\b\w/g, c => c.toUpperCase());

      const basePrompt = promptData?.prompt_text || `
Generate consequences for the selected what-if question, including 2nd and 3rd order effects,
new technology applications, ELSA implications, and who wins/loses.
Write in ${AppState.language === 'nl' ? 'Dutch' : 'English'}.
      `;

      const context = `
═════════════════════════════════════════════════════════
INPUT DATA
═════════════════════════════════════════════════════════

SELECTED WHAT-IF QUESTION:
${AppState.selectedWhatIf}

PHASE 1 SCENARIO:
${AppState.scenario || 'No scenario available'}

ARCHETYPE: ${AppState.archetypeDescription?.name || AppState.archetype}
${AppState.archetypeDescription?.description || ''}

NUANCE: ${AppState.archetypeMapping?.nuance_name || ''}
${AppState.archetypeMapping?.nuance_description || ''}

SELECTED TECHNOLOGIES:
1. ${formatTech(techQuantum)}
2. ${formatTech(tech2)}
3. ${formatTech(tech3)}

ACTOR: ${formatTech(AppState.selectedActor)}
TRIGGER: ${formatTech(AppState.selectedEvent)}

TECHNOLOGY KNOWLEDGE:
${techData?.map(t => `- ${t.name || t.technology}: ${t.description || t.content || ''}`).join('\n') || 'Use general knowledge about the selected technologies.'}

SECTOR KNOWLEDGE (JenV):
${sectorData?.map(s => `- ${s.title}: ${s.content}`).join('\n') || 'Dutch Ministry of Justice and Security'}

OUTPUT LANGUAGE: ${AppState.language === 'nl' ? 'Dutch (Nederlands)' : 'English'}
`;

      return `${basePrompt}\n\n${context}`;
    }

    // ================================
    // Phase 4: Strategic Focus
    // ================================

    function initPhase4() {
      debugLog('Initializing Phase 4...');

      // Parse consequences into selectable items
      const consequences = AppState.consequences || '';
      const items = parseConsequencesForSelection(consequences);

      const container = document.getElementById('consequence-items');

      if (items.length === 0) {
        container.innerHTML = `<p class="body-text">${t('no_consequences')}</p>`;
        return;
      }

      let html = '';
      items.forEach((item, i) => {
        html += `
          <div class="card" style="background: var(--white); margin-bottom: 0.5rem; cursor: pointer;" onclick="togglePriority(${i})">
            <label style="display: flex; align-items: flex-start; gap: 0.75rem; cursor: pointer;">
              <input type="checkbox" id="priority-${i}" value="${i}" onchange="updateStrategicSummary()" style="margin-top: 0.25rem;">
              <span class="body-text" style="font-size: 0.9rem;">${item}</span>
            </label>
          </div>
        `;
      });

      container.innerHTML = html;

      // Store parsed items for later reference
      AppState.parsedConsequences = items;

      debugLog(`Phase 4 initialized with ${items.length} consequence items`);
    }

    function parseConsequencesForSelection(text) {
      if (!text) return [];

      const items = [];

      // Try to extract bullet points and numbered items
      const lines = text.split('\n');
      let currentItem = '';

      for (const line of lines) {
        const trimmed = line.trim();

        // Check for bullet points, numbered items, or headers
        if (trimmed.match(/^[-•*]\s+/) || trimmed.match(/^\d+[.)]\s+/)) {
          if (currentItem) items.push(currentItem.trim());
          currentItem = trimmed.replace(/^[-•*]\s+/, '').replace(/^\d+[.)]\s+/, '');
        } else if (trimmed.match(/^#{1,4}\s+/) || trimmed.match(/^\*\*[^*]+\*\*/)) {
          // Headers - skip as grouping titles
          if (currentItem) items.push(currentItem.trim());
          currentItem = '';
        } else if (trimmed && currentItem) {
          // Continuation of previous item
          currentItem += ' ' + trimmed;
        }
      }

      if (currentItem) items.push(currentItem.trim());

      // If no structured items found, split by sentences
      if (items.length === 0) {
        const sentences = text.match(/[^.!?]+[.!?]+/g) || [];
        sentences.forEach(s => {
          const cleaned = s.trim();
          if (cleaned.length > 20) items.push(cleaned);
        });
      }

      // Limit to reasonable number and filter short items
      return items.filter(item => item.length > 15).slice(0, 15);
    }

    function togglePriority(index) {
      const checkbox = document.getElementById(`priority-${index}`);
      if (checkbox) {
        checkbox.checked = !checkbox.checked;
        updateStrategicSummary();
      }
    }

    function updateStrategicSummary() {
      const selected = [];
      const checkboxes = document.querySelectorAll('#consequence-items input[type="checkbox"]:checked');

      checkboxes.forEach(cb => {
        const index = parseInt(cb.value);
        if (AppState.parsedConsequences && AppState.parsedConsequences[index]) {
          selected.push(AppState.parsedConsequences[index]);
        }
      });

      AppState.strategicPriorities = selected;

      const summaryEl = document.getElementById('strategic-summary');
      const summaryList = document.getElementById('strategic-summary-list');

      if (selected.length > 0) {
        summaryEl.style.display = 'block';
        summaryList.innerHTML = selected.map(s =>
          `<p class="body-text" style="margin-bottom: 0.5rem; padding-left: 1rem; border-left: 3px solid var(--magenta);">${s}</p>`
        ).join('');
      } else {
        summaryEl.style.display = 'none';
      }

      debugLog(`Strategic priorities updated: ${selected.length} items selected`);
    }

    // ================================
    // Phase 5: Export & Save
    // ================================

    function initPhase5() {
      debugLog('Initializing Phase 5...');

      // Save strategic notes
      AppState.strategicNotes = document.getElementById('input-strategic-notes')?.value || '';

      // Populate summary
      const formatTech = (t) => t?.replace(/_/g, ' ').replace(/\b\w/g, c => c.toUpperCase()) || '';

      document.getElementById('summary-archetype').textContent =
        AppState.archetypeDescription?.name || AppState.archetype || '-';

      document.getElementById('summary-nuance').textContent =
        AppState.archetypeMapping?.nuance_name || '';

      document.getElementById('summary-scenario').textContent =
        (AppState.scenario || '-').substring(0, 500) + (AppState.scenario?.length > 500 ? '...' : '');

      document.getElementById('summary-whatif').textContent =
        AppState.selectedWhatIf || '-';

      document.getElementById('summary-techs').textContent =
        AppState.selectedTechnologies.map(formatTech).join(', ') || '-';

      document.getElementById('summary-actor').textContent =
        formatTech(AppState.selectedActor) || '-';

      document.getElementById('summary-trigger').textContent =
        formatTech(AppState.selectedEvent) || '-';

      // Strategic priorities
      const prioritiesEl = document.getElementById('summary-priorities');
      if (AppState.strategicPriorities.length > 0) {
        prioritiesEl.innerHTML = AppState.strategicPriorities.map(p =>
          `<p class="body-text" style="margin-bottom: 0.25rem;">• ${p}</p>`
        ).join('');
      } else {
        prioritiesEl.innerHTML = `<p class="body-text" style="opacity: 0.7;">${t('no_priorities')}</p>`;
      }

      // Notes
      const notesEl = document.getElementById('summary-notes');
      if (AppState.strategicNotes) {
        notesEl.innerHTML = `<p class="body-text">"${AppState.strategicNotes}"</p>`;
      } else {
        notesEl.innerHTML = '';
      }

      debugLog('Phase 5 summary populated');
    }

    function buildExportText() {
      const formatTech = (t) => t?.replace(/_/g, ' ').replace(/\b\w/g, c => c.toUpperCase()) || '';
      const lang = AppState.language;

      let text = `
═══════════════════════════════════════════════════════════════
TECH FUTURES EXPLORER - ${lang === 'nl' ? 'SESSIE RAPPORT' : 'SESSION REPORT'}
═══════════════════════════════════════════════════════════════

${lang === 'nl' ? 'ARCHETYPE' : 'ARCHETYPE'}: ${AppState.archetypeDescription?.name || AppState.archetype}
${lang === 'nl' ? 'Nuance' : 'Nuance'}: ${AppState.archetypeMapping?.nuance_name || '-'}

───────────────────────────────────────────────────────────────
${lang === 'nl' ? 'SCENARIO' : 'SCENARIO'}
───────────────────────────────────────────────────────────────
${AppState.scenario || '-'}

───────────────────────────────────────────────────────────────
${lang === 'nl' ? 'TECHNOLOGIEËN & CONTEXT' : 'TECHNOLOGIES & CONTEXT'}
───────────────────────────────────────────────────────────────
${lang === 'nl' ? 'Technologieën' : 'Technologies'}: ${AppState.selectedTechnologies.map(formatTech).join(', ')}
Actor: ${formatTech(AppState.selectedActor)}
Trigger: ${formatTech(AppState.selectedEvent)}

───────────────────────────────────────────────────────────────
WHAT-IF
───────────────────────────────────────────────────────────────
${AppState.selectedWhatIf || '-'}

───────────────────────────────────────────────────────────────
${lang === 'nl' ? 'CONSEQUENTIES' : 'CONSEQUENCES'}
───────────────────────────────────────────────────────────────
${AppState.consequences || '-'}

───────────────────────────────────────────────────────────────
${lang === 'nl' ? 'STRATEGISCHE PRIORITEITEN' : 'STRATEGIC PRIORITIES'}
───────────────────────────────────────────────────────────────
${AppState.strategicPriorities.length > 0 ?
        AppState.strategicPriorities.map((p, i) => `${i + 1}. ${p}`).join('\n') :
        (lang === 'nl' ? 'Geen prioriteiten geselecteerd' : 'No priorities selected')}

${AppState.strategicNotes ? `
───────────────────────────────────────────────────────────────
${lang === 'nl' ? 'NOTITIES' : 'NOTES'}
───────────────────────────────────────────────────────────────
${AppState.strategicNotes}
` : ''}

═══════════════════════════════════════════════════════════════
${lang === 'nl' ? 'Gegenereerd op' : 'Generated on'}: ${new Date().toLocaleString(lang === 'nl' ? 'nl-NL' : 'en-US')}
Tech Futures Explorer - Quantum Delta NL
═══════════════════════════════════════════════════════════════
`;

      return text.trim();
    }

    async function copyToClipboard() {
      const text = buildExportText();

      try {
        await navigator.clipboard.writeText(text);
        alert(t('copied_success'));
        debugLog('Text copied to clipboard');
      } catch (error) {
        debugLog(`Clipboard error: ${error.message}`);
        // Fallback for older browsers
        const textarea = document.createElement('textarea');
        textarea.value = text;
        document.body.appendChild(textarea);
        textarea.select();
        document.execCommand('copy');
        document.body.removeChild(textarea);
        alert(t('copied_success'));
      }
    }

    function exportToPDF() {
      debugLog('Generating PDF...');

      // Create a printable version
      const text = buildExportText();

      // Open print dialog with formatted content
      const printWindow = window.open('', '_blank');
      printWindow.document.write(`
        <!DOCTYPE html>
        <html>
        <head>
          <title>Tech Futures Explorer - Export</title>
          <style>
            body {
              font-family: 'Courier New', monospace;
              padding: 2rem;
              max-width: 800px;
              margin: 0 auto;
              font-size: 12px;
              line-height: 1.6;
            }
            pre {
              white-space: pre-wrap;
              word-wrap: break-word;
            }
            @media print {
              body { padding: 1rem; }
            }
          </style>
        </head>
        <body>
          <pre>${text.replace(/</g, '&lt;').replace(/>/g, '&gt;')}</pre>
          <scr` + `ipt>
            window.onload = function() {
              window.print();
            }
          </scr` + `ipt>
        </body>
        </html>
      `);
      printWindow.document.close();
    }

    async function saveSession() {
      const sessionName = document.getElementById('input-session-name').value.trim();
      const statusEl = document.getElementById('save-status');
      const btnEl = document.getElementById('btn-save-session');

      if (!sessionName) {
        statusEl.innerHTML = `<p class="status-message error">${AppState.language === 'nl' ? 'Voer een sessie naam in' : 'Enter a session name'}</p>`;
        return;
      }

      btnEl.disabled = true;
      btnEl.innerHTML = `<span class="loading-spinner"></span>`;
      statusEl.innerHTML = '';

      try {
        const sessionData = {
          name: sessionName,
          language: AppState.language,
          archetype_id: AppState.archetype,
          archetype_name: AppState.archetypeDescription?.name,
          nuance_name: AppState.archetypeMapping?.nuance_name,
          scenario: AppState.scenario,
          technologies: AppState.selectedTechnologies,
          actor: AppState.selectedActor,
          trigger_event: AppState.selectedEvent,
          whatif_question: AppState.selectedWhatIf,
          consequences: AppState.consequences,
          strategic_priorities: AppState.strategicPriorities,
          strategic_notes: AppState.strategicNotes,
          created_at: new Date().toISOString()
        };

        const { data, error } = await supabaseClient
          .from('sessions')
          .insert([sessionData])
          .select();

        if (error) throw error;

        AppState.savedSessionId = data?.[0]?.id;

        statusEl.innerHTML = `<p class="status-message success">✓ ${t('save_success')} (ID: ${AppState.savedSessionId || 'saved'})</p>`;
        debugLog(`Session saved with ID: ${AppState.savedSessionId}`);

      } catch (error) {
        debugLog(`Save error: ${error.message}`);
        statusEl.innerHTML = `<p class="status-message error">${t('save_error')}: ${error.message}</p>`;
      } finally {
        btnEl.disabled = false;
        btnEl.textContent = t('save_to_database');
      }
    }

    function startNewSession() {
      // Reset AppState
      AppState.currentPhase = 1;
      AppState.archetype = null;
      AppState.archetypeMapping = null;
      AppState.archetypeDescription = null;
      AppState.scenario = null;
      AppState.selectedTechnologies = [];
      AppState.selectedActor = null;
      AppState.selectedEvent = null;
      AppState.whatIfQuestions = [];
      AppState.selectedWhatIf = null;
      AppState.consequences = null;
      AppState.strategicPriorities = [];
      AppState.strategicNotes = '';
      AppState.savedSessionId = null;

      // Reset form elements
      document.getElementById('select-resources').value = '';
      document.getElementById('select-system').value = '';
      document.getElementById('select-values').value = '';
      document.getElementById('select-tech-2').value = '';
      document.getElementById('select-tech-3').value = '';
      document.getElementById('select-actor').value = '';
      document.getElementById('select-event').value = '';
      document.getElementById('input-custom-whatif').value = '';
      document.getElementById('input-strategic-notes').value = '';
      document.getElementById('input-session-name').value = '';

      // Hide result sections
      document.getElementById('archetype-result').style.display = 'none';
      document.getElementById('scenario-result').style.display = 'none';
      document.getElementById('whatif-result').style.display = 'none';
      document.getElementById('strategic-summary').style.display = 'none';
      document.getElementById('save-status').innerHTML = '';

      // Go to start screen
      showScreen('screen-start');

      debugLog('New session started - state reset');
    }

    // ================================
    // Connection Test
    // ================================
    async function testConnection() {
      const statusEl = document.getElementById('connection-status');

      try {
        // Test Supabase connection by fetching archetype mappings
        const { data, error } = await supabaseClient
          .from('Archetype_mapping')
          .select('*')
          .limit(1);

        if (error) throw error;

        statusEl.className = 'status-message success';
        statusEl.innerHTML = `✓ ${t('connected')}`;
        debugLog('Connection test successful');

        // Log table info
        debugLog(`Sample archetype mapping: ${JSON.stringify(data)}`);

      } catch (error) {
        statusEl.className = 'status-message error';
        statusEl.innerHTML = `✗ ${t('connection_error')}: ${error.message}`;
        debugLog(`Connection test failed: ${error.message}`);
      }
    }

    // ================================
    // Initialize Application
    // ================================
    document.addEventListener('DOMContentLoaded', async () => {
      debugLog('Application initializing...');

      // Initialize Supabase
      if (initSupabase()) {
        // Test the connection
        await testConnection();
      }

      debugLog('Application ready');
    });
  </script>

</body>
</html>
