<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Tech Futures Explorer - Quantum Delta NL</title>

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Roboto+Mono:wght@400;500&display=swap" rel="stylesheet">

  <!-- Supabase Client -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    /* ================================
       Design System - Clean & Professional
       Quantum Superposition Theme
       ================================ */
    :root {
      /* Core Colors */
      --black: #000000;
      --blue: #0000FF;
      --red: #FF0000;
      --white: #FFFFFF;

      /* Background Colors */
      --bg-page: #F5F5F5;
      --bg-card: #FFFFFF;
      --bg-content: #F8FAFC;
      --bg-subtle: #FAFAFA;

      /* Shadows */
      --shadow-sm: 0 1px 3px rgba(0,0,0,0.08);
      --shadow-md: 0 2px 8px rgba(0,0,0,0.1);
      --shadow-lg: 0 4px 16px rgba(0,0,0,0.12);

      /* Border Radius */
      --radius-sm: 4px;
      --radius-md: 8px;
      --radius-lg: 12px;

      /* Typography */
      --font-mono: 'Roboto Mono', monospace;
      --font-body: Arial, sans-serif;

      /* Spacing */
      --space-xs: 0.5rem;
      --space-sm: 0.75rem;
      --space-md: 1rem;
      --space-lg: 1.5rem;
      --space-xl: 2rem;
    }

    /* ================================
       Reset & Base Styles
       ================================ */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent;
    }

    body {
      font-family: var(--font-body);
      background-color: var(--bg-page);
      color: var(--black);
      min-height: 100vh;
      font-size: 16px;
      line-height: 1.5;
    }

    /* ================================
       Superposition Background Effect
       ================================ */
    .superposition-bg {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      pointer-events: none;
      z-index: -1;
      overflow: hidden;
    }

    .superposition-bg::before,
    .superposition-bg::after {
      content: '';
      position: absolute;
      border-radius: 50%;
    }

    .superposition-bg::before {
      width: 220px;
      height: 220px;
      background: radial-gradient(circle, rgba(0, 0, 255, 0.35) 0%, rgba(0, 0, 255, 0.15) 50%, transparent 75%);
      top: -40px;
      right: -40px;
    }

    .superposition-bg::after {
      width: 200px;
      height: 200px;
      background: radial-gradient(circle, rgba(255, 0, 255, 0.35) 0%, rgba(255, 0, 255, 0.15) 50%, transparent 75%);
      bottom: -30px;
      left: -30px;
    }

    /* ================================
       Typography Styles
       ================================ */
    .label {
      font-family: var(--font-mono);
      text-transform: uppercase;
      letter-spacing: 0.08em;
      font-size: 0.8rem;
      font-weight: 500;
      color: var(--blue);
    }

    .headline {
      font-family: var(--font-body);
      font-weight: 300;
      font-size: 1.75rem;
      line-height: 1.3;
      color: var(--black);
    }

    .sub-headline {
      font-family: var(--font-mono);
      font-weight: 400;
      font-size: 1rem;
      line-height: 1.5;
      color: #333;
    }

    .body-text {
      font-family: var(--font-body);
      font-weight: 400;
      font-size: 1rem;
      line-height: 1.7;
      color: #222;
    }

    .small-label {
      font-family: var(--font-mono);
      text-transform: uppercase;
      letter-spacing: 0.08em;
      font-size: 0.7rem;
      font-weight: 500;
      color: #666;
    }

    @media (min-width: 768px) {
      .headline {
        font-size: 2rem;
      }
      .sub-headline {
        font-size: 1.125rem;
      }
    }

    /* ================================
       Layout Components
       ================================ */
    .container {
      max-width: 800px;
      margin: 0 auto;
      padding: var(--space-md);
    }

    @media (min-width: 768px) {
      .container {
        padding: var(--space-xl);
      }
    }

    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: var(--space-sm) var(--space-md);
      background: var(--white);
      box-shadow: var(--shadow-sm);
      gap: var(--space-sm);
    }

    @media (min-width: 768px) {
      .header {
        padding: var(--space-md) var(--space-xl);
      }
    }

    .logo {
      font-family: var(--font-mono);
      font-weight: 400;
      font-size: 0.85rem;
      letter-spacing: 0.05em;
      color: #333;
    }

    @media (min-width: 768px) {
      .logo {
        font-size: 1rem;
      }
    }

    .phase-indicator {
      display: flex;
      gap: 0.5rem;
      align-items: center;
    }

    .phase-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: #DDD;
      transition: all 0.2s ease;
    }

    @media (min-width: 768px) {
      .phase-dot {
        width: 10px;
        height: 10px;
      }
      .phase-indicator {
        gap: 0.6rem;
      }
    }

    .phase-dot.active {
      background: var(--blue);
      transform: scale(1.2);
    }

    .phase-dot.completed {
      background: var(--blue);
      opacity: 0.5;
    }

    /* ================================
       Button Styles
       ================================ */
    .btn {
      font-family: var(--font-mono);
      text-transform: uppercase;
      letter-spacing: 0.06em;
      padding: 0.875rem 1.25rem;
      border: none;
      border-radius: var(--radius-sm);
      background: var(--white);
      color: var(--black);
      cursor: pointer;
      transition: all 0.15s ease;
      font-size: 0.8rem;
      font-weight: 500;
      min-height: 48px;
      touch-action: manipulation;
      box-shadow: var(--shadow-sm);
    }

    @media (min-width: 768px) {
      .btn {
        padding: 0.75rem 1.5rem;
        min-height: 44px;
      }
    }

    .btn:hover {
      box-shadow: var(--shadow-md);
      transform: translateY(-1px);
    }

    .btn:active {
      transform: translateY(0);
      box-shadow: var(--shadow-sm);
    }

    .btn-primary {
      background: var(--blue);
      color: var(--white);
    }

    .btn-primary:hover {
      background: #0000DD;
    }

    .btn-secondary {
      background: var(--black);
      color: var(--white);
    }

    .btn-secondary:hover {
      background: #222;
    }

    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }

    /* ================================
       Card Styles
       ================================ */
    .card {
      background: var(--bg-card);
      border-radius: var(--radius-md);
      box-shadow: var(--shadow-md);
      padding: var(--space-lg);
      margin-bottom: var(--space-md);
    }

    @media (min-width: 768px) {
      .card {
        padding: var(--space-xl);
        margin-bottom: var(--space-lg);
      }
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: var(--space-md);
      padding-bottom: var(--space-sm);
      border-bottom: 1px solid #EEE;
    }

    @media (min-width: 768px) {
      .card-header {
        margin-bottom: var(--space-lg);
      }
    }

    /* Nested cards for content sections */
    .card .card {
      background: var(--bg-content);
      box-shadow: none;
      border: 1px solid #EEE;
    }

    /* ================================
       Screen/View Styles
       ================================ */
    .screen {
      display: none;
      min-height: calc(100vh - 80px);
    }

    .screen.active {
      display: block;
    }

    /* ================================
       Language Selection Screen
       ================================ */
    #screen-start {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
      background: var(--white);
      padding: var(--space-lg);
    }

    .start-content {
      text-align: center;
      max-width: 500px;
      width: 100%;
    }

    .start-content .headline {
      margin-bottom: var(--space-sm);
    }

    .start-content .sub-headline {
      color: #666;
    }

    .language-buttons {
      display: flex;
      flex-direction: column;
      gap: var(--space-md);
      margin-top: var(--space-xl);
    }

    @media (min-width: 480px) {
      .language-buttons {
        flex-direction: row;
        justify-content: center;
      }
    }

    .language-btn {
      padding: 1rem 2rem;
      font-size: 0.875rem;
      background: var(--blue);
      color: var(--white);
    }

    .language-btn:hover {
      background: #0000DD;
    }

    /* ================================
       Status/Loading States
       ================================ */
    .status-message {
      padding: var(--space-md);
      margin: var(--space-md) 0;
      border-radius: var(--radius-sm);
      font-family: var(--font-mono);
      font-size: 0.8rem;
    }

    .status-message.error {
      background: #FEF2F2;
      color: #991B1B;
    }

    .status-message.success {
      background: #F0FDF4;
      color: #166534;
    }

    .status-message.loading {
      background: var(--bg-content);
      color: #666;
    }

    .loading-spinner {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 2px solid #DDD;
      border-top-color: var(--blue);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* ================================
       Debug Panel (Development)
       ================================ */
    #debug-panel {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: var(--black);
      color: var(--white);
      padding: 1rem;
      font-family: var(--font-mono);
      font-size: 0.75rem;
      max-height: 200px;
      overflow-y: auto;
    }

    #debug-panel.hidden {
      display: none;
    }

    .debug-toggle {
      position: fixed;
      bottom: 1rem;
      right: 1rem;
      z-index: 1000;
    }

    /* ================================
       Camera Modal Styles
       ================================ */
    .camera-modal {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.85);
      z-index: 2000;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: var(--space-md);
    }

    .camera-modal-content {
      background: var(--white);
      border-radius: var(--radius-lg);
      max-width: 600px;
      width: 100%;
      max-height: 90vh;
      overflow: hidden;
      box-shadow: var(--shadow-lg);
    }

    .camera-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: var(--space-md);
      border-bottom: 1px solid #EEE;
      background: var(--white);
    }

    .camera-view {
      position: relative;
      background: #111;
      min-height: 300px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .camera-view video,
    .camera-view img {
      width: 100%;
      max-height: 400px;
      object-fit: contain;
    }

    .camera-hint {
      position: absolute;
      bottom: var(--space-md);
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0, 0, 0, 0.7);
      color: var(--white);
      padding: var(--space-xs) var(--space-md);
      border-radius: var(--radius-sm);
      font-family: var(--font-mono);
      font-size: 0.7rem;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    .camera-controls {
      display: flex;
      flex-direction: column;
      gap: var(--space-sm);
      padding: var(--space-md);
      background: var(--bg-subtle);
    }

    @media (min-width: 480px) {
      .camera-controls {
        flex-direction: row;
        justify-content: center;
      }
    }

    .camera-controls .btn {
      width: 100%;
    }

    @media (min-width: 480px) {
      .camera-controls .btn {
        width: auto;
        min-width: 140px;
      }
    }

    .scan-button {
      width: 100%;
      margin-bottom: var(--space-md);
      background: var(--white);
      color: var(--blue);
      font-size: 0.875rem;
      padding: var(--space-md);
      border: 1px dashed var(--blue);
      border-radius: var(--radius-md);
    }

    .scan-button:hover {
      background: var(--blue);
      color: var(--white);
      border-style: solid;
    }

    .scan-divider {
      display: flex;
      align-items: center;
      gap: var(--space-md);
      margin: var(--space-md) 0;
      color: #999;
    }

    .scan-divider::before,
    .scan-divider::after {
      content: '';
      flex: 1;
      height: 1px;
      background: #DDD;
    }

    .scan-divider span {
      font-family: var(--font-mono);
      font-size: 0.7rem;
      text-transform: uppercase;
    }

    /* ================================
       Back Button Styles
       ================================ */
    .back-button {
      font-family: var(--font-mono);
      font-size: 0.8rem;
      color: #666;
      background: none;
      border: none;
      cursor: pointer;
      padding: var(--space-xs) 0;
      margin-bottom: var(--space-md);
      display: inline-flex;
      align-items: center;
      gap: var(--space-xs);
      transition: color 0.15s ease;
    }

    .back-button:hover {
      color: var(--blue);
    }

    .phase-header {
      display: flex;
      align-items: center;
      gap: var(--space-md);
      margin-bottom: var(--space-sm);
    }

    /* ================================
       Mobile Responsive Grids
       ================================ */
    .mobile-grid-1 {
      display: grid;
      grid-template-columns: 1fr;
      gap: 1rem;
    }

    .mobile-grid-2 {
      display: grid;
      grid-template-columns: 1fr;
      gap: 1rem;
    }

    .mobile-grid-3 {
      display: grid;
      grid-template-columns: 1fr;
      gap: 1rem;
    }

    @media (min-width: 768px) {
      .mobile-grid-2 {
        grid-template-columns: repeat(2, 1fr);
      }
      .mobile-grid-3 {
        grid-template-columns: repeat(3, 1fr);
      }
    }

    /* ================================
       Form Elements (Mobile Optimized)
       ================================ */
    select.btn,
    input.btn,
    textarea.btn {
      width: 100%;
      font-size: 16px;
      min-height: 48px;
      padding: var(--space-sm) var(--space-md);
      appearance: none;
      -webkit-appearance: none;
      border-radius: var(--radius-sm);
      border: 1px solid #DDD;
      background: var(--white);
      box-shadow: none;
    }

    select.btn:focus,
    input.btn:focus,
    textarea.btn:focus {
      outline: none;
      border-color: var(--blue);
      box-shadow: 0 0 0 3px rgba(0, 0, 255, 0.1);
    }

    select.btn {
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%23666' d='M6 8L1 3h10z'/%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right var(--space-md) center;
      padding-right: 2.5rem;
    }

    textarea.btn {
      min-height: 100px;
      resize: vertical;
    }

    input[type="text"].btn,
    input[type="email"].btn {
      text-transform: none;
    }

    /* Form field labels */
    .field-label {
      display: block;
      font-family: var(--font-mono);
      font-size: 0.7rem;
      text-transform: uppercase;
      letter-spacing: 0.06em;
      margin-bottom: var(--space-xs);
      color: #555;
    }

    .field-group {
      margin-bottom: var(--space-md);
    }

    /* Radio/Checkbox touch targets */
    input[type="radio"],
    input[type="checkbox"] {
      width: 20px;
      height: 20px;
      margin: 0;
      cursor: pointer;
      accent-color: var(--blue);
    }

    /* Clickable card items */
    .selectable-item {
      padding: var(--space-md);
      margin-bottom: var(--space-sm);
      background: var(--white);
      border: 1px solid #DDD;
      border-radius: var(--radius-sm);
      cursor: pointer;
      transition: all 0.15s ease;
    }

    .selectable-item:active {
      background: var(--bg-content);
    }

    .selectable-item.selected {
      background: rgba(0, 0, 255, 0.05);
      border-color: var(--blue);
    }

    /* Mobile-specific visibility */
    .hide-mobile {
      display: none;
    }

    @media (min-width: 768px) {
      .hide-mobile {
        display: block;
      }
      .hide-desktop {
        display: none;
      }
    }

    /* ================================
       AI Generated Content Styling
       ================================ */

    /* Scenario Title */
    .scenario-title {
      font-size: 1.25rem;
      font-weight: 600;
      color: var(--black);
      margin-bottom: var(--space-lg);
      line-height: 1.4;
    }

    /* ================================
       AI Output Styling - Simple & Clean
       ================================ */

    /* Section Headers (h3.section-header) */
    h3.section-header,
    .section-header {
      font-size: 1rem;
      font-weight: 700;
      color: #0000FF;
      margin: 1.5rem 0 0.5rem 0;
      padding: 0;
    }

    .section-header:first-child,
    h3.section-header:first-child {
      margin-top: 0;
    }

    /* Narrative Vignette (italic blocks) */
    .narrative-vignette {
      background: #E8F4FC;
      border-left: 3px solid #0000FF;
      padding: 1rem;
      margin: 1rem 0;
      border-radius: 4px;
      font-style: italic;
    }

    .narrative-vignette p {
      line-height: 1.7;
      color: #333;
      margin: 0;
    }

    /* Styled Lists - clean single bullets */
    .styled-list {
      list-style: none;
      padding: 0;
      margin: 0.5rem 0 1rem 0;
    }

    .styled-list li {
      padding: 0.4rem 0 0.4rem 1.25rem;
      position: relative;
      line-height: 1.6;
      color: #333;
    }

    .styled-list li::before {
      content: '‚Ä¢';
      position: absolute;
      left: 0;
      color: #0000FF;
      font-weight: bold;
    }

    /* Body paragraphs in output */
    .formatted-content p,
    #scenario-text p,
    #consequences-text p {
      line-height: 1.7;
      margin: 0.75rem 0;
      color: #333;
    }

    /* What-If Question Cards */
    .whatif-card {
      background: var(--white);
      border: 1px solid #E0E0E0;
      border-radius: var(--radius-md);
      padding: var(--space-md);
      margin-bottom: var(--space-md);
      cursor: pointer;
      transition: all 0.15s ease;
    }

    .whatif-card:hover {
      border-color: var(--blue);
      box-shadow: var(--shadow-sm);
    }

    .whatif-card.selected {
      border-color: var(--blue);
      background: rgba(0, 0, 255, 0.03);
    }

    .whatif-question {
      font-size: 1.05rem;
      font-weight: 400;
      color: var(--black);
      margin-bottom: var(--space-sm);
      line-height: 1.5;
    }

    .whatif-meta {
      display: flex;
      flex-wrap: wrap;
      gap: var(--space-sm);
      margin-top: var(--space-sm);
    }

    .whatif-tag {
      font-family: var(--font-mono);
      font-size: 0.65rem;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      padding: 0.25rem 0.5rem;
      border-radius: 3px;
      background: #F0F0F0;
    }

    .whatif-tag.tech {
      background: rgba(0, 0, 255, 0.1);
      color: var(--blue);
    }

    .whatif-tag.domain {
      background: #F5F5F5;
      color: #666;
    }

    /* Strategic Priority Items */
    .priority-item {
      background: var(--white);
      border: 1px solid #E0E0E0;
      border-radius: var(--radius-sm);
      padding: var(--space-md);
      margin-bottom: var(--space-sm);
      cursor: pointer;
      transition: all 0.15s ease;
    }

    .priority-item:hover {
      border-color: #CCC;
    }

    .priority-item.selected {
      border-color: var(--blue);
      background: rgba(0, 0, 255, 0.03);
    }

    .priority-source {
      font-family: var(--font-mono);
      font-size: 0.6rem;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: #888;
      margin-bottom: var(--space-xs);
    }

    .priority-text {
      font-size: 0.95rem;
      line-height: 1.5;
      color: #333;
    }
  </style>
</head>
<body>
  <!-- Quantum Superposition Background -->
  <div class="superposition-bg"></div>

  <!-- ================================
       Start Screen (Language Selection)
       ================================ -->
  <div id="screen-start" class="screen active">
    <div class="start-content">
      <p class="label">Quantum Delta NL</p>
      <h1 class="headline" style="margin: 1rem 0;">Tech Futures Explorer</h1>
      <p class="sub-headline" style="margin-bottom: 2rem;">
        Emerging Technologies Futures Exploration Tool
      </p>
      <p class="body-text" id="start-description">
        Verken hoe opkomende technologie√´n kunnen samenkomen en impact hebben op de samenleving.
      </p>
      <div class="language-buttons">
        <button class="btn language-btn" onclick="startSession('nl')">
          Nederlands
        </button>
        <button class="btn language-btn" onclick="startSession('en')">
          English
        </button>
      </div>

      <!-- Connection Status -->
      <div id="connection-status" class="status-message loading" style="margin-top: 2rem;">
        <span class="loading-spinner"></span>
        Verbinding maken met database...
      </div>
    </div>
  </div>

  <!-- ================================
       Main App Screen
       ================================ -->
  <div id="screen-main" class="screen">
    <header class="header">
      <div class="logo">TECH FUTURES</div>
      <div class="phase-indicator">
        <div class="phase-dot active" data-phase="1" title="Phase 1: Scenario"></div>
        <div class="phase-dot" data-phase="2" title="Phase 2: Disruption"></div>
        <div class="phase-dot" data-phase="3" title="Phase 3: Consequences"></div>
        <div class="phase-dot" data-phase="4" title="Phase 4: Strategy"></div>
        <div class="phase-dot" data-phase="5" title="Phase 5: Export"></div>
      </div>
      <button class="btn" onclick="showDebugInfo()" data-i18n="debug">Debug</button>
    </header>

    <main class="container">
      <!-- Phase 1: Scenario Foundation -->
      <section id="phase-1" class="phase-content active">
        <div class="card">
          <div class="card-header">
            <span class="label" data-i18n="phase1_title">Fase 1: Scenario Basis</span>
          </div>
          <p class="body-text" data-i18n="phase1_intro">
            Selecteer de 3 binaire keuzes om het basisscenario te bepalen.
          </p>

          <!-- Card Selection -->
          <div class="card" style="background: var(--bg-grey); margin-top: 1.5rem;">
            <!-- Scan Cards Button -->
            <button class="btn scan-button" onclick="openCamera('phase1')" data-i18n="scan_cards_phase1">
              üì∑ Scan Cards
            </button>
            <div class="scan-divider"><span data-i18n="or_manual">or select manually</span></div>

            <div class="mobile-grid-3">
              <div class="field-group">
                <label class="field-label" data-i18n="card_resources">Resources</label>
                <select id="select-resources" class="btn">
                  <option value="" data-i18n="select_placeholder">-- Kies --</option>
                  <option value="Abundance">Abundance</option>
                  <option value="Limits">Limits</option>
                </select>
              </div>
              <div class="field-group">
                <label class="field-label" data-i18n="card_system">System</label>
                <select id="select-system" class="btn">
                  <option value="" data-i18n="select_placeholder">-- Kies --</option>
                  <option value="Stable">Stable</option>
                  <option value="Breaks">Breaks</option>
                </select>
              </div>
              <div class="field-group">
                <label class="field-label" data-i18n="card_values">Values</label>
                <select id="select-values" class="btn">
                  <option value="" data-i18n="select_placeholder">-- Kies --</option>
                  <option value="Collective">Collective</option>
                  <option value="Individual">Individual</option>
                </select>
              </div>
            </div>
            <button class="btn btn-primary" style="margin-top: 1.5rem; width: 100%;" onclick="determineArchetype()" id="btn-determine" data-i18n="determine_archetype">
              Bepaal Archetype
            </button>
          </div>

          <!-- Archetype Result -->
          <div id="archetype-result" class="card" style="display: none; background: var(--bg-blue); margin-top: 1rem;">
            <p class="small-label" data-i18n="archetype">Archetype</p>
            <h2 class="headline" id="archetype-name" style="margin: 0.5rem 0;"></h2>
            <p class="sub-headline" id="archetype-nuance" style="color: var(--blue);"></p>
            <p class="body-text" id="archetype-summary" style="margin-top: 0.75rem;"></p>
          </div>

          <!-- Generated Scenario -->
          <div id="scenario-result" class="card" style="display: none; background: var(--bg-magenta); margin-top: 1rem;">
            <p class="small-label" data-i18n="generated_scenario">Gegenereerd Scenario</p>
            <div class="body-text" id="scenario-text" style="margin-top: 1rem; white-space: pre-line;"></div>
            <button class="btn btn-primary" style="margin-top: 1.5rem; width: 100%;" onclick="goToPhase(2)" data-i18n="continue_phase2">
              Verder naar Fase 2
            </button>
          </div>
        </div>
      </section>

      <!-- Phase 2: Disruption Introduction -->
      <section id="phase-2" class="phase-content" style="display: none;">
        <div class="card">
          <button class="back-button" onclick="goToPhase(1)">‚Üê Back</button>
          <div class="card-header">
            <span class="label" data-i18n="phase2_title">Fase 2: Disruptie</span>
          </div>
          <p class="body-text" data-i18n="phase2_intro">
            Selecteer technologie√´n, een actor en een trigger om what-if vragen te genereren.
          </p>

          <!-- Technology Selection -->
          <div class="card" style="background: var(--bg-grey); margin-top: 1.5rem;">
            <!-- Scan Cards Button -->
            <button class="btn scan-button" onclick="openCamera('phase2')" data-i18n="scan_cards_phase2">
              üì∑ Scan All Cards (Tech + Actor + Event)
            </button>
            <div class="scan-divider"><span data-i18n="or_manual">or select manually</span></div>

            <p class="small-label" style="margin-bottom: 0.75rem;" data-i18n="select_technologies">Technologie√´n (3, inclusief quantum)</p>
            <div class="mobile-grid-3">
              <div class="field-group">
                <label class="field-label">Quantum Tech</label>
                <select id="select-tech-quantum" class="btn">
                  <option value="quantum">Quantum</option>
                </select>
              </div>
              <div class="field-group">
                <label class="field-label">Technology 2</label>
                <select id="select-tech-2" class="btn">
                  <option value="" data-i18n="select_placeholder">-- Kies --</option>
                  <option value="Neuro tech">Neuro tech</option>
                  <option value="AGI">AGI</option>
                  <option value="Climate tech">Climate tech</option>
                  <option value="Robotics">Robotics</option>
                  <option value="Space tech">Space tech</option>
                </select>
              </div>
              <div class="field-group">
                <label class="field-label">Technology 3</label>
                <select id="select-tech-3" class="btn">
                  <option value="" data-i18n="select_placeholder">-- Kies --</option>
                  <option value="Neuro tech">Neuro tech</option>
                  <option value="AGI">AGI</option>
                  <option value="Climate tech">Climate tech</option>
                  <option value="Robotics">Robotics</option>
                  <option value="Space tech">Space tech</option>
                </select>
              </div>
            </div>

            <!-- Actor and Event -->
            <div class="mobile-grid-2" style="margin-top: 1.5rem;">
              <div class="field-group">
                <label class="field-label" data-i18n="select_actor">Actor</label>
                <select id="select-actor" class="btn">
                  <option value="" data-i18n="select_placeholder">-- Kies --</option>
                  <option value="criminal_networks">Criminal networks</option>
                  <option value="foreign_states">Foreign states</option>
                  <option value="big_tech">Big Tech</option>
                  <option value="research_institutions">Research institutions</option>
                  <option value="ngos">NGOs</option>
                  <option value="citizens">Citizens</option>
                  <option value="journalists">Journalists</option>
                  <option value="startups">Startups</option>
                  <option value="insurance_companies">Insurance companies</option>
                  <option value="custom">Custom (enter below)</option>
                </select>
                <input type="text" id="input-actor-custom" class="btn" placeholder="Custom actor..." style="margin-top: 0.5rem; display: none;">
              </div>
              <div class="field-group">
                <label class="field-label" data-i18n="select_event">Trigger Event</label>
                <select id="select-event" class="btn">
                  <option value="" data-i18n="select_placeholder">-- Kies --</option>
                  <option value="major_breakthrough">Major breakthrough</option>
                  <option value="security_breach">Security breach</option>
                  <option value="regulatory_shift">Regulatory shift</option>
                  <option value="talent_exodus">Talent exodus</option>
                  <option value="international_treaty">International treaty</option>
                  <option value="maturity_tipping_point">Maturity tipping point</option>
                  <option value="loss_of_control">Loss of control</option>
                  <option value="public_scandal">Public scandal</option>
                  <option value="market_collapse">Market collapse</option>
                  <option value="custom">Custom (enter below)</option>
                </select>
                <input type="text" id="input-event-custom" class="btn" placeholder="Custom event..." style="margin-top: 0.5rem; display: none;">
              </div>
            </div>

            <button class="btn btn-primary" style="margin-top: 1.5rem; width: 100%;" onclick="generateWhatIfQuestions()" id="btn-generate-whatif" data-i18n="generate_whatif">
              Genereer What-If Vragen
            </button>
          </div>

          <!-- What-If Questions Result -->
          <div id="whatif-result" class="card" style="display: none; background: var(--bg-blue); margin-top: 1rem;">
            <p class="small-label" data-i18n="whatif_questions">What-If Vragen</p>
            <div id="whatif-questions-list" style="margin-top: 1rem;"></div>

            <!-- Custom What-If Input -->
            <div style="margin-top: 1.5rem; padding-top: 1rem; border-top: 1px solid var(--black);">
              <p class="small-label" data-i18n="or_custom_whatif">Of voer een eigen vraag in:</p>
              <textarea id="input-custom-whatif" class="btn" placeholder="What if..." style="width: 100%; height: 80px; margin-top: 0.5rem; resize: vertical; text-transform: none;"></textarea>
            </div>

            <button class="btn btn-primary" style="margin-top: 1rem; width: 100%;" onclick="proceedToPhase3()" id="btn-proceed-phase3" data-i18n="continue_phase3">
              Verder met geselecteerde vraag
            </button>
          </div>
        </div>
      </section>

      <!-- Phase 3: Consequences -->
      <section id="phase-3" class="phase-content" style="display: none;">
        <div class="card">
          <button class="back-button" onclick="goToPhase(2)">‚Üê Back</button>
          <div class="card-header">
            <span class="label" data-i18n="phase3_title">Fase 3: Consequenties</span>
          </div>

          <!-- Selected What-If Display -->
          <div class="card" style="background: var(--bg-blue); margin-bottom: 1rem;">
            <p class="small-label" data-i18n="selected_whatif">Geselecteerde What-If Vraag</p>
            <p class="sub-headline" id="selected-whatif-display" style="margin-top: 0.5rem;"></p>
          </div>

          <!-- Consequences Result -->
          <div id="consequences-result" class="card" style="background: var(--bg-magenta);">
            <p class="small-label" data-i18n="consequences">Consequenties</p>
            <div class="body-text" id="consequences-text" style="margin-top: 1rem; white-space: pre-line;">
              <div style="text-align: center; padding: 2rem;">
                <span class="loading-spinner"></span><br><br>
                <span data-i18n="generating_consequences">Consequenties genereren...</span>
              </div>
            </div>
          </div>

          <button class="btn btn-primary" style="margin-top: 1rem; width: 100%;" onclick="goToPhase(4)" data-i18n="continue_phase4">
            Verder naar Fase 4
          </button>
        </div>
      </section>

      <!-- Phase 4: Strategic Focus -->
      <section id="phase-4" class="phase-content" style="display: none;">
        <div class="card">
          <button class="back-button" onclick="goToPhase(3)">‚Üê Back</button>
          <div class="card-header">
            <span class="label" data-i18n="phase4_title">Fase 4: Strategische Focus</span>
          </div>
          <p class="body-text" data-i18n="phase4_intro">
            Selecteer de belangrijkste consequenties om strategisch te bespreken. Markeer items die aandacht vereisen.
          </p>

          <!-- Consequence Selection -->
          <div id="strategic-consequences" class="card" style="background: var(--bg-grey); margin-top: 1.5rem;">
            <p class="small-label" data-i18n="select_strategic">Selecteer strategische focuspunten</p>
            <div id="consequence-items" style="margin-top: 1rem;">
              <!-- Populated dynamically -->
            </div>
          </div>

          <!-- Strategic Notes - shown after selection -->
          <div id="strategic-notes-section" class="card" style="background: var(--bg-blue); margin-top: 1rem; display: none;">
            <p class="small-label" data-i18n="strategic_notes">Strategische Notities</p>
            <textarea id="input-strategic-notes" class="btn" placeholder="Notities voor de strategie discussie..." style="width: 100%; height: 120px; margin-top: 0.5rem; resize: vertical; text-transform: none;"></textarea>
          </div>

          <!-- Summary of selected items -->
          <div id="strategic-summary" class="card" style="background: var(--bg-magenta); margin-top: 1rem; display: none;">
            <p class="small-label" data-i18n="strategic_summary">Geselecteerde Prioriteiten</p>
            <div id="strategic-summary-list" style="margin-top: 0.5rem;"></div>
          </div>

          <!-- Prompt to select - shown when no selection -->
          <p id="phase4-select-prompt" class="body-text" style="text-align: center; color: #666; margin-top: 1.5rem;" data-i18n="select_focus_prompt">
            Klik op de items hierboven om strategische focuspunten te selecteren
          </p>

          <!-- Continue button - hidden until selection -->
          <button id="phase4-continue-btn" class="btn btn-primary" style="margin-top: 1rem; width: 100%; display: none;" onclick="goToPhase(5)" data-i18n="continue_phase5">
            Verder naar Export
          </button>
        </div>
      </section>

      <!-- Phase 5: Export -->
      <section id="phase-5" class="phase-content" style="display: none;">
        <div class="card">
          <button class="back-button" onclick="goToPhase(4)">‚Üê Back</button>
          <div class="card-header">
            <span class="label" data-i18n="phase5_title">Fase 5: Export & Opslaan</span>
          </div>
          <p class="body-text" data-i18n="phase5_intro">
            Bekijk de volledige sessie samenvatting en exporteer of sla op voor later gebruik.
          </p>

          <!-- Session Summary -->
          <div id="session-summary" class="card" style="background: var(--bg-grey); margin-top: 1.5rem;">
            <p class="small-label" data-i18n="session_summary">Sessie Samenvatting</p>

            <!-- Archetype & Scenario -->
            <div style="margin-top: 1rem; padding: 1rem; background: var(--white); border: 1px solid var(--black);">
              <p class="small-label" style="color: var(--blue);">ARCHETYPE</p>
              <p class="sub-headline" id="summary-archetype"></p>
              <p class="body-text" id="summary-nuance" style="margin-top: 0.25rem; font-size: 0.875rem; opacity: 0.8;"></p>
            </div>

            <!-- Scenario Preview -->
            <div style="margin-top: 1rem; padding: 1rem; background: var(--white); border: 1px solid var(--black);">
              <p class="small-label" style="color: var(--magenta);">SCENARIO</p>
              <p class="body-text" id="summary-scenario" style="margin-top: 0.5rem; max-height: 150px; overflow-y: auto;"></p>
            </div>

            <!-- What-If Question -->
            <div style="margin-top: 1rem; padding: 1rem; background: var(--white); border: 1px solid var(--black);">
              <p class="small-label" style="color: var(--blue);">WHAT-IF</p>
              <p class="body-text" id="summary-whatif" style="margin-top: 0.5rem;"></p>
            </div>

            <!-- Technologies & Context -->
            <div style="margin-top: 1rem; padding: 1rem; background: var(--white); border: 1px solid var(--black);">
              <p class="small-label" style="color: var(--red);">CONTEXT</p>
              <div style="margin-top: 0.5rem;">
                <p class="body-text" style="margin-bottom: 0.25rem;"><strong>Technologies:</strong> <span id="summary-techs"></span></p>
                <p class="body-text" style="margin-bottom: 0.25rem;"><strong>Actor:</strong> <span id="summary-actor"></span></p>
                <p class="body-text"><strong>Trigger:</strong> <span id="summary-trigger"></span></p>
              </div>
            </div>

            <!-- Strategic Priorities -->
            <div style="margin-top: 1rem; padding: 1rem; background: var(--white); border: 1px solid var(--black);">
              <p class="small-label" style="color: var(--magenta);">STRATEGISCHE PRIORITEITEN</p>
              <div id="summary-priorities" style="margin-top: 0.5rem;"></div>
              <div id="summary-notes" style="margin-top: 0.5rem; font-style: italic;"></div>
            </div>
          </div>

          <!-- Export Options -->
          <div class="card" style="background: var(--bg-blue); margin-top: 1rem;">
            <p class="small-label" data-i18n="export_options">Export Opties</p>
            <div class="mobile-grid-2" style="margin-top: 1rem;">
              <button class="btn btn-secondary" onclick="exportToPDF()" data-i18n="export_pdf">
                Download PDF
              </button>
              <button class="btn btn-secondary" onclick="copyToClipboard()" data-i18n="copy_summary">
                Kopieer Tekst
              </button>
            </div>
          </div>

          <!-- Save to Database -->
          <div class="card" style="background: var(--bg-magenta); margin-top: 1rem;">
            <p class="small-label" data-i18n="save_session">Sessie Opslaan</p>
            <div style="margin-top: 0.75rem;">
              <label class="small-label" data-i18n="session_name">Sessie Naam</label>
              <input type="text" id="input-session-name" class="btn" placeholder="Geef een naam aan deze sessie..." style="width: 100%; margin-top: 0.5rem; text-transform: none;">
            </div>
            <button class="btn btn-primary" style="margin-top: 1rem; width: 100%;" onclick="saveSession()" id="btn-save-session" data-i18n="save_to_database">
              Opslaan in Database
            </button>
            <div id="save-status" style="margin-top: 0.75rem;"></div>
          </div>

          <!-- New Session Button -->
          <button class="btn" style="margin-top: 1.5rem; width: 100%;" onclick="startNewSession()" data-i18n="start_new">
            Start Nieuwe Sessie
          </button>
        </div>
      </section>
    </main>
  </div>

  <!-- Camera Modal -->
  <div id="camera-modal" class="camera-modal" style="display: none;">
    <div class="camera-modal-content">
      <div class="camera-header">
        <span class="label" id="camera-title">üì∑ Scan Cards</span>
        <button class="btn" onclick="closeCamera()">‚úï</button>
      </div>

      <!-- Live Camera View -->
      <div id="camera-live" class="camera-view">
        <video id="camera-video" autoplay playsinline></video>
        <p class="camera-hint" id="camera-hint">Position all cards in frame</p>
      </div>

      <!-- Captured Image Preview -->
      <div id="camera-preview" class="camera-view" style="display: none;">
        <img id="camera-image" alt="Captured cards">
        <canvas id="camera-canvas" style="display: none;"></canvas>
      </div>

      <!-- Processing State -->
      <div id="camera-processing" class="camera-view" style="display: none;">
        <div style="text-align: center; padding: 3rem;">
          <span class="loading-spinner" style="width: 40px; height: 40px;"></span>
          <p class="body-text" style="margin-top: 1rem;" id="camera-processing-text">Analyzing cards...</p>
        </div>
      </div>

      <!-- Camera Controls -->
      <div class="camera-controls">
        <button id="btn-capture" class="btn btn-primary" onclick="capturePhoto()">
          üì∏ Capture
        </button>
        <button id="btn-retake" class="btn" onclick="retakePhoto()" style="display: none;">
          ‚Üª Retake
        </button>
        <button id="btn-use-photo" class="btn btn-primary" onclick="usePhoto()" style="display: none;">
          ‚úì Use This Photo
        </button>
      </div>

      <!-- Error Message -->
      <div id="camera-error" class="status-message error" style="display: none; margin-top: 1rem;"></div>
    </div>
  </div>

  <!-- Debug Toggle -->
  <button class="btn debug-toggle" onclick="toggleDebug()">DB</button>

  <!-- Debug Panel -->
  <div id="debug-panel" class="hidden">
    <strong>Debug Log:</strong>
    <pre id="debug-log"></pre>
  </div>

  <!-- ================================
       JavaScript Application
       ================================ -->
  <script>
    // ================================
    // Configuration
    // ================================
    const SUPABASE_URL = 'https://ccfyvpqtxypiawbbftgs.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNjZnl2cHF0eHlwaWF3YmJmdGdzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY4MzIzOTYsImV4cCI6MjA4MjQwODM5Nn0.C-_T4ZmhcB1rihlcnpwUC_APohAOGEE9nQREmsXBTVg';

    // ================================
    // Global State
    // ================================
    const AppState = {
      language: 'nl',
      currentPhase: 1,
      sessionId: null,
      archetype: null,
      archetypeContext: null,
      scenario: null,
      selectedTechnologies: [],
      selectedActor: null,
      selectedEvent: null,
      whatIfQuestions: [],
      selectedWhatIf: null,
      consequences: null,
      strategicPriorities: [],
      strategicNotes: '',
      savedSessionId: null
    };

    // ================================
    // Supabase Client
    // ================================
    let supabaseClient = null;

    function initSupabase() {
      try {
        supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        debugLog('Supabase client initialized');
        return true;
      } catch (error) {
        debugLog('Supabase init error: ' + error.message);
        return false;
      }
    }

    // ================================
    // Language/i18n System
    // ================================
    const translations = {
      nl: {
        phase1_title: 'Fase 1: Scenario Basis',
        phase1_intro: 'Selecteer de 3 binaire keuzes om het basisscenario te bepalen.',
        card_resources: 'Resources',
        card_system: 'System',
        card_values: 'Values',
        select_placeholder: '-- Kies --',
        determine_archetype: 'Genereer Scenario',
        archetype: 'Archetype',
        generated_scenario: 'Gegenereerd Scenario',
        continue_phase2: 'Verder naar Fase 2',
        debug: 'Debug',
        connecting: 'Verbinding maken...',
        connected: 'Verbonden met database',
        connection_error: 'Kan geen verbinding maken met database',
        select_all_options: 'Selecteer alle drie de opties',
        generating_scenario: 'Scenario wordt gegenereerd...',
        determining_archetype: 'Archetype bepalen...',
        error_archetype: 'Fout bij ophalen archetype',
        // Phase 2
        phase2_title: 'Fase 2: Disruptie',
        phase2_intro: 'Selecteer technologie√´n, een actor en een trigger om what-if vragen te genereren.',
        select_technologies: 'Technologie√´n (3, inclusief quantum)',
        select_actor: 'Actor',
        select_event: 'Trigger Event',
        generate_whatif: 'Genereer What-If Vragen',
        generating_whatif: 'What-if vragen genereren...',
        whatif_questions: 'What-If Vragen',
        or_custom_whatif: 'Of voer een eigen vraag in:',
        continue_phase3: 'Verder met geselecteerde vraag',
        select_whatif_error: 'Selecteer een what-if vraag of voer een eigen vraag in',
        select_tech_actor_event: 'Selecteer alle technologie√´n, actor en event',
        // Phase 3
        phase3_title: 'Fase 3: Consequenties',
        selected_whatif: 'Geselecteerde What-If Vraag',
        consequences: 'Consequenties',
        generating_consequences: 'Consequenties genereren...',
        continue_phase4: 'Verder naar Fase 4',
        // Phase 4
        phase4_title: 'Fase 4: Strategische Focus',
        phase4_intro: 'Selecteer de belangrijkste consequenties om strategisch te bespreken. Markeer items die aandacht vereisen.',
        select_strategic: 'Selecteer strategische focuspunten',
        select_focus_prompt: 'Klik op de items hierboven om strategische focuspunten te selecteren',
        strategic_notes: 'Strategische Notities',
        strategic_summary: 'Geselecteerde Prioriteiten',
        continue_phase5: 'Verder naar Export',
        no_consequences: 'Geen consequenties beschikbaar. Ga terug naar Fase 3.',
        // Phase 5
        phase5_title: 'Fase 5: Export & Opslaan',
        phase5_intro: 'Bekijk de volledige sessie samenvatting en exporteer of sla op voor later gebruik.',
        session_summary: 'Sessie Samenvatting',
        export_options: 'Export Opties',
        export_pdf: 'Download PDF',
        copy_summary: 'Kopieer Tekst',
        save_session: 'Sessie Opslaan',
        session_name: 'Sessie Naam',
        save_to_database: 'Opslaan in Database',
        start_new: 'Start Nieuwe Sessie',
        copied_success: 'Gekopieerd naar klembord!',
        save_success: 'Sessie opgeslagen!',
        save_error: 'Fout bij opslaan',
        no_priorities: 'Geen prioriteiten geselecteerd',
        pdf_generating: 'PDF genereren...',
        // Camera
        scan_cards_phase1: 'üì∑ Scan Kaarten',
        scan_cards_phase2: 'üì∑ Scan Alle Kaarten (Tech + Actor + Event)',
        or_manual: 'of selecteer handmatig',
        camera_error: 'Camera niet beschikbaar',
        analyzing_cards: 'Kaarten analyseren...',
        card_scan_failed: 'Kaarten niet herkend, probeer opnieuw',
        cards_detected: 'Kaarten gedetecteerd!'
      },
      en: {
        phase1_title: 'Phase 1: Scenario Foundation',
        phase1_intro: 'Select the 3 binary choices to determine the base scenario.',
        card_resources: 'Resources',
        card_system: 'System',
        card_values: 'Values',
        select_placeholder: '-- Select --',
        determine_archetype: 'Generate Scenario',
        archetype: 'Archetype',
        generated_scenario: 'Generated Scenario',
        continue_phase2: 'Continue to Phase 2',
        debug: 'Debug',
        connecting: 'Connecting...',
        connected: 'Connected to database',
        connection_error: 'Cannot connect to database',
        select_all_options: 'Please select all three options',
        generating_scenario: 'Generating scenario...',
        determining_archetype: 'Determining archetype...',
        error_archetype: 'Error fetching archetype',
        // Phase 2
        phase2_title: 'Phase 2: Disruption',
        phase2_intro: 'Select technologies, an actor, and a trigger to generate what-if questions.',
        select_technologies: 'Technologies (3, including quantum)',
        select_actor: 'Actor',
        select_event: 'Trigger Event',
        generate_whatif: 'Generate What-If Questions',
        generating_whatif: 'Generating what-if questions...',
        whatif_questions: 'What-If Questions',
        or_custom_whatif: 'Or enter your own question:',
        continue_phase3: 'Continue with selected question',
        select_whatif_error: 'Select a what-if question or enter your own',
        select_tech_actor_event: 'Select all technologies, actor, and event',
        // Phase 3
        phase3_title: 'Phase 3: Consequences',
        selected_whatif: 'Selected What-If Question',
        consequences: 'Consequences',
        generating_consequences: 'Generating consequences...',
        continue_phase4: 'Continue to Phase 4',
        // Phase 4
        phase4_title: 'Phase 4: Strategic Focus',
        phase4_intro: 'Select the key consequences for strategic discussion. Mark items requiring attention.',
        select_strategic: 'Select strategic focus points',
        select_focus_prompt: 'Click on items above to select strategic focus points',
        strategic_notes: 'Strategic Notes',
        strategic_summary: 'Selected Priorities',
        continue_phase5: 'Continue to Export',
        no_consequences: 'No consequences available. Go back to Phase 3.',
        // Phase 5
        phase5_title: 'Phase 5: Export & Save',
        phase5_intro: 'Review the full session summary and export or save for later use.',
        session_summary: 'Session Summary',
        export_options: 'Export Options',
        export_pdf: 'Download PDF',
        copy_summary: 'Copy Text',
        save_session: 'Save Session',
        session_name: 'Session Name',
        save_to_database: 'Save to Database',
        start_new: 'Start New Session',
        copied_success: 'Copied to clipboard!',
        save_success: 'Session saved!',
        save_error: 'Error saving',
        no_priorities: 'No priorities selected',
        pdf_generating: 'Generating PDF...',
        // Camera
        scan_cards_phase1: 'üì∑ Scan Cards',
        scan_cards_phase2: 'üì∑ Scan All Cards (Tech + Actor + Event)',
        or_manual: 'or select manually',
        camera_error: 'Camera not available',
        analyzing_cards: 'Analyzing cards...',
        card_scan_failed: 'Cards not recognized, please try again',
        cards_detected: 'Cards detected!'
      }
    };

    function t(key) {
      return translations[AppState.language]?.[key] || translations['en']?.[key] || key;
    }

    function updateUILanguage() {
      document.querySelectorAll('[data-i18n]').forEach(el => {
        const key = el.getAttribute('data-i18n');
        el.textContent = t(key);
      });
      document.documentElement.lang = AppState.language;
    }

    // ================================
    // Debug Utilities
    // ================================
    function debugLog(message) {
      const timestamp = new Date().toLocaleTimeString();
      const logEl = document.getElementById('debug-log');
      if (logEl) {
        logEl.textContent += `[${timestamp}] ${message}\n`;
        logEl.scrollTop = logEl.scrollHeight;
      }
      console.log(`[Debug] ${message}`);
    }

    function toggleDebug() {
      document.getElementById('debug-panel').classList.toggle('hidden');
    }

    function showDebugInfo() {
      debugLog('Current State: ' + JSON.stringify(AppState, null, 2));
    }

    // ================================
    // Screen Navigation
    // ================================
    function showScreen(screenId) {
      document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
      document.getElementById(screenId)?.classList.add('active');
    }

    function goToPhase(phase) {
      AppState.currentPhase = phase;

      // Update phase indicators
      document.querySelectorAll('.phase-dot').forEach(dot => {
        const dotPhase = parseInt(dot.dataset.phase);
        dot.classList.remove('active', 'completed');
        if (dotPhase === phase) dot.classList.add('active');
        if (dotPhase < phase) dot.classList.add('completed');
      });

      // Show correct phase content
      document.querySelectorAll('.phase-content').forEach(p => p.style.display = 'none');
      document.getElementById(`phase-${phase}`).style.display = 'block';

      // Restore previously generated content when navigating back
      if (phase === 1) {
        // Show archetype and scenario if they exist
        if (AppState.archetype) {
          document.getElementById('archetype-result').style.display = 'block';
        }
        if (AppState.scenario) {
          document.getElementById('scenario-result').style.display = 'block';
        }
      } else if (phase === 2) {
        // Show what-if questions if they exist
        if (AppState.whatIfQuestions.length > 0) {
          document.getElementById('whatif-result').style.display = 'block';
        }
      } else if (phase === 3) {
        // Show consequences if they exist
        if (AppState.consequences) {
          document.getElementById('consequences-text').innerHTML = formatConsequencesOutput(AppState.consequences);
        }
      }

      // Initialize phase-specific content
      if (phase === 4) initPhase4();
      if (phase === 5) initPhase5();

      debugLog(`Navigated to Phase ${phase}`);
    }

    // ================================
    // Session Management
    // ================================
    async function startSession(language) {
      AppState.language = language;
      updateUILanguage();
      showScreen('screen-main');
      debugLog(`Session started with language: ${language}`);
    }

    // ================================
    // Supabase Data Functions
    // ================================
    async function fetchArchetypeContext(resources, system, values) {
      debugLog(`Fetching archetype context for: ${resources}, ${system}, ${values}`);

      try {
        // New combined table: archetype_context
        // Columns: id, scenario_name, axis_a, axis_b, axis_d, archetype, key_vocabulary (JSONB), description, opportunity, risk
        const { data, error } = await supabaseClient
          .from('archetype_context')
          .select('*')
          .eq('axis_a', resources)
          .eq('axis_b', system)
          .eq('axis_d', values);

        if (error) throw error;

        debugLog(`Archetype context result: ${JSON.stringify(data)}`);
        return data?.[0] || null;
      } catch (error) {
        debugLog(`Error fetching archetype context: ${error.message}`);
        return null;
      }
    }

    async function fetchPrompt(promptId) {
      debugLog(`Fetching prompt: ${promptId}`);

      try {
        // Prompts table uses 'id' column (e.g., 'scenario_writing')
        const { data, error } = await supabaseClient
          .from('prompts')
          .select('*')
          .eq('id', promptId)
          .single();

        if (error) throw error;

        debugLog(`Prompt fetched: ${promptId}`);
        return data;
      } catch (error) {
        debugLog(`Error fetching prompt: ${error.message}`);
        return null;
      }
    }

    async function fetchSectorInfo() {
      debugLog('Fetching sector information');

      try {
        const { data, error } = await supabaseClient
          .from('Sector information: JenV')
          .select('*');

        if (error) throw error;

        debugLog(`Sector info fetched: ${data?.length} records`);
        return data;
      } catch (error) {
        debugLog(`Error fetching sector info: ${error.message}`);
        return null;
      }
    }

    // ================================
    // Gemini API Functions
    // ================================
    async function callGemini(prompt, image = null, type = 'text') {
      debugLog(`Calling Gemini API (type: ${type})`);

      try {
        const response = await fetch('/api/gemini', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ prompt, image, type })
        });

        const data = await response.json();

        if (data.error) {
          throw new Error(data.error);
        }

        debugLog('Gemini response received');
        return data.result;
      } catch (error) {
        debugLog(`Gemini API error: ${error.message}`);
        throw error;
      }
    }

    // ================================
    // Phase 1: Scenario Foundation
    // ================================
    async function determineArchetype() {
      const resources = document.getElementById('select-resources').value;
      const system = document.getElementById('select-system').value;
      const values = document.getElementById('select-values').value;

      if (!resources || !system || !values) {
        alert(t('select_all_options'));
        return;
      }

      debugLog(`Determining archetype for: ${resources}, ${system}, ${values}`);

      // Disable button and show loading
      const btnEl = document.getElementById('btn-determine');
      btnEl.disabled = true;
      btnEl.innerHTML = `<span class="loading-spinner"></span> ${t('determining_archetype')}`;

      // Show archetype result with loading state
      const resultEl = document.getElementById('archetype-result');
      resultEl.style.display = 'block';
      document.getElementById('archetype-name').textContent = '...';
      document.getElementById('archetype-nuance').textContent = '';
      document.getElementById('archetype-summary').textContent = t('connecting');

      try {
        // Get archetype context from combined table
        const archetypeContext = await fetchArchetypeContext(resources, system, values);

        if (!archetypeContext) {
          throw new Error('No archetype context found for this combination');
        }

        // Store in AppState for use in prompts
        AppState.archetype = archetypeContext.archetype;
        AppState.archetypeContext = archetypeContext;

        // Display the archetype - using new column names
        const displayName = archetypeContext.scenario_name || archetypeContext.archetype;
        const summary = getFirstSentence(archetypeContext.description);

        document.getElementById('archetype-name').textContent = displayName;
        document.getElementById('archetype-nuance').textContent = archetypeContext.archetype;
        document.getElementById('archetype-summary').textContent = summary;

        debugLog(`Archetype determined: ${archetypeContext.archetype} (${archetypeContext.scenario_name})`);

        // Generate scenario
        await generateScenario(archetypeContext);

      } catch (error) {
        debugLog(`Error: ${error.message}`);
        document.getElementById('archetype-name').textContent = t('error_archetype');
        document.getElementById('archetype-summary').textContent = error.message;
      } finally {
        // Re-enable button
        btnEl.disabled = false;
        btnEl.textContent = t('determine_archetype');
      }
    }

    // Helper to extract first sentence
    function getFirstSentence(text) {
      if (!text) return '';
      // Split on period followed by space or end of string
      const match = text.match(/^[^.]+\./);
      return match ? match[0].trim() : text.substring(0, 150) + '...';
    }

    async function generateScenario(archetypeContext) {
      debugLog('Generating scenario...');

      const scenarioEl = document.getElementById('scenario-result');
      const scenarioTextEl = document.getElementById('scenario-text');

      scenarioEl.style.display = 'block';
      scenarioTextEl.innerHTML = `<div style="text-align: center; padding: 2rem;"><span class="loading-spinner"></span><br><br>${t('generating_scenario')}</div>`;

      try {
        // Fetch required data from Supabase
        const [promptData, sectorData] = await Promise.all([
          fetchPrompt('scenario_writing'),
          fetchSectorInfo()
        ]);

        debugLog(`Prompt data: ${promptData ? 'loaded' : 'missing'}`);
        debugLog(`Sector data: ${sectorData?.length || 0} items`);

        // Build the prompt for Gemini
        const fullPrompt = buildScenarioPrompt(promptData, archetypeContext, sectorData);

        debugLog('Sending prompt to Gemini...');
        debugLog(`Prompt length: ${fullPrompt.length} chars`);

        // Call Gemini API
        const scenario = await callGemini(fullPrompt, null, 'scenario');

        AppState.scenario = scenario;

        // Format the scenario for display with styled sections
        scenarioTextEl.innerHTML = formatScenarioWithSections(scenario);

        debugLog('Scenario generated successfully');

      } catch (error) {
        debugLog(`Scenario generation error: ${error.message}`);
        scenarioTextEl.innerHTML = `<div class="status-message error">Error: ${error.message}</div>`;
      }
    }

    // Filter out quantum-related entries from sector data (for Phase 1)
    function filterOutQuantum(sectorData) {
      if (!sectorData) return [];
      const quantumKeywords = ['quantum', 'q-day', 'pqc', 'qkd', 'qutech'];
      return sectorData.filter(item => {
        const text = `${item.title} ${item.content}`.toLowerCase();
        return !quantumKeywords.some(keyword => text.includes(keyword));
      });
    }

    function buildScenarioPrompt(promptData, archetypeContext, sectorData) {
      // Get the card choices for context
      const resources = document.getElementById('select-resources').value;
      const system = document.getElementById('select-system').value;
      const values = document.getElementById('select-values').value;

      // Filter out quantum content for Phase 1 scenarios
      const filteredSectorData = filterOutQuantum(sectorData);
      debugLog(`Sector data: ${sectorData?.length || 0} total, ${filteredSectorData.length} after quantum filter`);

      // Format key_vocabulary (JSONB array) as comma-separated string
      const vocabulary = Array.isArray(archetypeContext?.key_vocabulary)
        ? archetypeContext.key_vocabulary.join(', ')
        : archetypeContext?.key_vocabulary || '';

      // Use the prompt from Supabase (column: prompt_text)
      const basePrompt = promptData?.prompt_text || `
Generate a future scenario for the Dutch Ministry of Justice and Security (JenV).
The scenario should be vivid, concrete, and thought-provoking.
Write in ${AppState.language === 'nl' ? 'Dutch' : 'English'}.
      `;

      // Build the context to inject into the prompt
      const context = `
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
INPUT DATA
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

CARD CHOICES:
- Resources: ${resources}
- System: ${system}
- Values: ${values}

SCENARIO: ${archetypeContext?.scenario_name || ''}
ARCHETYPE: ${archetypeContext?.archetype || ''}

ARCHETYPE DESCRIPTION:
${archetypeContext?.description || ''}

KEY VOCABULARY:
${vocabulary}

OPPORTUNITY:
${archetypeContext?.opportunity || ''}

RISK/TENSION:
${archetypeContext?.risk || ''}

SECTOR KNOWLEDGE (Dutch Ministry of Justice and Security - JenV):
${filteredSectorData.map(s => `- ${s.title}: ${s.content}`).join('\n') || 'Focus on justice, security, and law enforcement.'}

OUTPUT LANGUAGE: ${AppState.language === 'nl' ? 'Dutch (Nederlands)' : 'English'}
`;

      return `${basePrompt}\n\n${context}`;
    }

    // ================================
    // SIMPLE MARKDOWN PARSER
    // ================================

    function parseMarkdown(text) {
      if (!text) return '';

      const lines = text.split('\n');
      let html = '';
      let inList = false;
      let inVignette = false;
      let vignetteContent = '';

      for (let i = 0; i < lines.length; i++) {
        let line = lines[i];
        const trimmed = line.trim();

        // Skip empty lines (but close list if open)
        if (!trimmed) {
          if (inList) {
            html += '</ul>';
            inList = false;
          }
          html += '<br>';
          continue;
        }

        // Detect italic block start/end (vignette)
        if (trimmed.startsWith('*') && !trimmed.startsWith('**')) {
          // Check if this is a multi-line italic block
          if (trimmed.endsWith('*') && trimmed.length > 2) {
            // Single line italic - treat as vignette
            const content = trimmed.slice(1, -1);
            html += `<div class="narrative-vignette"><p>${formatInlineMarkdown(content)}</p></div>`;
            continue;
          }
        }

        // Headers: ### or ## or lines that are ALL CAPS or end with :
        if (trimmed.startsWith('###')) {
          if (inList) { html += '</ul>'; inList = false; }
          const headerText = trimmed.replace(/^#{1,4}\s*/, '').replace(/\*\*/g, '');
          html += `<h3 class="section-header">${headerText}</h3>`;
          continue;
        }
        if (trimmed.startsWith('##')) {
          if (inList) { html += '</ul>'; inList = false; }
          const headerText = trimmed.replace(/^#{1,4}\s*/, '').replace(/\*\*/g, '');
          html += `<h3 class="section-header">${headerText}</h3>`;
          continue;
        }

        // ALL CAPS lines or **Header** lines or lines ending with : ‚Üí section header
        const isAllCaps = trimmed === trimmed.toUpperCase() && trimmed.length > 3 && /[A-Z]/.test(trimmed);
        const isBoldHeader = trimmed.startsWith('**') && trimmed.endsWith('**');
        const endsWithColon = trimmed.endsWith(':') && trimmed.length > 5;

        if (isAllCaps || isBoldHeader || endsWithColon) {
          if (inList) { html += '</ul>'; inList = false; }
          const headerText = trimmed.replace(/\*\*/g, '').replace(/:$/, '');
          html += `<h3 class="section-header">${headerText}</h3>`;
          continue;
        }

        // Bullet points: - or ‚Ä¢ or *  (but not *italic*)
        if (trimmed.match(/^[-‚Ä¢]\s/) || (trimmed.startsWith('* ') && !trimmed.endsWith('*'))) {
          if (!inList) {
            html += '<ul class="styled-list">';
            inList = true;
          }
          const content = trimmed.replace(/^[-‚Ä¢*]\s*/, '');
          html += `<li>${formatInlineMarkdown(content)}</li>`;
          continue;
        }

        // Numbered lists: 1. or 1)
        if (trimmed.match(/^\d+[.)]\s/)) {
          if (!inList) {
            html += '<ul class="styled-list">';
            inList = true;
          }
          const content = trimmed.replace(/^\d+[.)]\s*/, '');
          html += `<li>${formatInlineMarkdown(content)}</li>`;
          continue;
        }

        // Regular paragraph
        if (inList) { html += '</ul>'; inList = false; }
        html += `<p>${formatInlineMarkdown(trimmed)}</p>`;
      }

      // Close any open list
      if (inList) html += '</ul>';

      return html;
    }

    function formatInlineMarkdown(text) {
      if (!text) return '';
      return text
        // Bold: **text**
        .replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>')
        // Italic: *text* (but not inside bold)
        .replace(/(?<!\*)\*([^*]+)\*(?!\*)/g, '<em>$1</em>');
    }

    // ================================
    // PHASE 1: SCENARIO OUTPUT
    // ================================

    function formatScenarioOutput(text) {
      return parseMarkdown(text);
    }

    function formatScenarioWithSections(text) {
      return parseMarkdown(text);
    }

    // ================================
    // PHASE 3: CONSEQUENCES OUTPUT
    // ================================

    function formatConsequencesOutput(text) {
      return parseMarkdown(text);
    }

    // ================================
    // Phase 2: What-If Generation
    // ================================

    // Show/hide custom input fields based on dropdown selection
    document.addEventListener('DOMContentLoaded', () => {
      const actorSelect = document.getElementById('select-actor');
      const eventSelect = document.getElementById('select-event');

      if (actorSelect) {
        actorSelect.addEventListener('change', (e) => {
          const customInput = document.getElementById('input-actor-custom');
          customInput.style.display = e.target.value === 'custom' ? 'block' : 'none';
        });
      }

      if (eventSelect) {
        eventSelect.addEventListener('change', (e) => {
          const customInput = document.getElementById('input-event-custom');
          customInput.style.display = e.target.value === 'custom' ? 'block' : 'none';
        });
      }
    });

    async function fetchTechnologyKnowledge(parentTechs = []) {
      debugLog(`Fetching technology knowledge for: ${parentTechs.join(', ')}`);
      try {
        // Filter out empty values
        const validTechs = parentTechs.filter(t => t && t.trim());

        if (validTechs.length === 0) {
          debugLog('No technologies selected, returning empty array');
          return [];
        }

        const { data, error } = await supabaseClient
          .from('technology_knowledge')
          .select('*')
          .in('parent_tech', validTechs);

        if (error) throw error;
        debugLog(`Technology knowledge fetched: ${data?.length || 0} items for ${validTechs.length} parent_techs`);
        return data || [];
      } catch (error) {
        debugLog(`Error fetching technology knowledge: ${error.message}`);
        return [];
      }
    }

    async function generateWhatIfQuestions() {
      // Get selections
      const techQuantum = document.getElementById('select-tech-quantum').value;
      const tech2 = document.getElementById('select-tech-2').value;
      const tech3 = document.getElementById('select-tech-3').value;

      let actor = document.getElementById('select-actor').value;
      if (actor === 'custom') {
        actor = document.getElementById('input-actor-custom').value;
      }

      let event = document.getElementById('select-event').value;
      if (event === 'custom') {
        event = document.getElementById('input-event-custom').value;
      }

      // Validate
      if (!tech2 || !tech3 || !actor || !event) {
        alert(t('select_tech_actor_event'));
        return;
      }

      // Store in AppState
      AppState.selectedTechnologies = [techQuantum, tech2, tech3];
      AppState.selectedActor = actor;
      AppState.selectedEvent = event;

      debugLog(`Generating what-if questions for: ${techQuantum}, ${tech2}, ${tech3}, ${actor}, ${event}`);

      // Show loading
      const btnEl = document.getElementById('btn-generate-whatif');
      btnEl.disabled = true;
      btnEl.innerHTML = `<span class="loading-spinner"></span> ${t('generating_whatif')}`;

      const resultEl = document.getElementById('whatif-result');
      resultEl.style.display = 'block';
      document.getElementById('whatif-questions-list').innerHTML = `<div style="text-align: center; padding: 1rem;"><span class="loading-spinner"></span></div>`;

      try {
        // Fetch data from Supabase (filter tech knowledge by selected parent_techs)
        const selectedTechs = [techQuantum, tech2, tech3];
        const [promptData, sectorData, techData] = await Promise.all([
          fetchPrompt('whatif_generation'),
          fetchSectorInfo(),
          fetchTechnologyKnowledge(selectedTechs)
        ]);

        // Build prompt
        const fullPrompt = buildWhatIfPrompt(promptData, sectorData, techData);

        debugLog('Sending what-if prompt to Gemini...');

        // Call Gemini
        const response = await callGemini(fullPrompt, null, 'whatif');

        // Parse the response into questions
        const questions = parseWhatIfResponse(response);
        AppState.whatIfQuestions = questions;

        // Display questions with radio buttons
        displayWhatIfQuestions(questions);

        debugLog(`Generated ${questions.length} what-if questions`);

      } catch (error) {
        debugLog(`What-if generation error: ${error.message}`);
        document.getElementById('whatif-questions-list').innerHTML = `<div class="status-message error">Error: ${error.message}</div>`;
      } finally {
        btnEl.disabled = false;
        btnEl.textContent = t('generate_whatif');
      }
    }

    // Format technology knowledge data for prompts (grouped by parent_tech)
    function formatTechDataForPrompt(techData) {
      if (!techData || techData.length === 0) {
        return '‚ö†Ô∏è WARNING: Technology knowledge data unavailable. Output may be less specific.';
      }

      // Group by parent_tech
      const grouped = {};
      for (const item of techData) {
        const parent = item.parent_tech || 'Other';
        if (!grouped[parent]) grouped[parent] = [];
        grouped[parent].push(item);
      }

      // Format each group
      let result = '';
      for (const [parent, items] of Object.entries(grouped)) {
        result += `\n${parent.toUpperCase()}:\n`;
        for (const item of items) {
          const subUse = item.sub_use ? `[${item.sub_use}]` : '';
          const category = item.category ? `(${item.category})` : '';
          const title = item.title || '';
          const desc = item.description || '';
          result += `- ${subUse} ${title} ${category}: ${desc}\n`;
        }
      }
      return result.trim();
    }

    function buildWhatIfPrompt(promptData, sectorData, techData) {
      const [techQuantum, tech2, tech3] = AppState.selectedTechnologies;
      const actor = AppState.selectedActor;
      const event = AppState.selectedEvent;

      // Format technology names for display
      const formatTech = (t) => t.replace(/_/g, ' ').replace(/\b\w/g, c => c.toUpperCase());

      const basePrompt = promptData?.prompt_text || `
Generate 3 what-if questions based on the selected technologies, actor, and trigger event.
Each question should be provocative and challenge assumptions about the future.
Write in ${AppState.language === 'nl' ? 'Dutch' : 'English'}.
      `;

      // Replace placeholders in the prompt
      let prompt = basePrompt
        .replace(/\[TECH_1\]/g, formatTech(tech2))
        .replace(/\[TECH_2\]/g, formatTech(tech3))
        .replace(/\[ACTOR\]/g, formatTech(actor))
        .replace(/\[TRIGGER\]/g, formatTech(event));

      const context = `
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
INPUT DATA
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

SELECTED TECHNOLOGIES:
1. Quantum: ${formatTech(techQuantum)}
2. Technology 2: ${formatTech(tech2)}
3. Technology 3: ${formatTech(tech3)}

ACTOR: ${formatTech(actor)}

TRIGGER EVENT: ${formatTech(event)}

ARCHETYPE CONTEXT: ${AppState.archetypeContext?.scenario_name || AppState.archetype}
${AppState.archetypeContext?.description || ''}

‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
‚ö†Ô∏è CRITICAL: TECHNOLOGY KNOWLEDGE BASE
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
The following contains verified, curated information about the selected
technologies. Your response MUST be grounded in this data.

DO NOT use general knowledge or assumptions.
DO reference specific applications, ELSA implications, and key concepts listed below.

${formatTechDataForPrompt(techData)}

‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
‚úì VERIFICATION: Your response must reference at least 1 specific
  item from EACH technology category listed above.
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

SECTOR KNOWLEDGE (JenV):
${sectorData?.slice(0, 15).map(s => `- ${s.title}: ${s.content}`).join('\n') || 'Dutch Ministry of Justice and Security'}

OUTPUT LANGUAGE: ${AppState.language === 'nl' ? 'Dutch (Nederlands)' : 'English'}
`;

      return `${prompt}\n\n${context}`;
    }

    function parseWhatIfResponse(response) {
      debugLog('Parsing what-if response...');

      // Get selected technologies for tech headers
      const [techQuantum, tech2, tech3] = AppState.selectedTechnologies || ['Quantum', '', ''];
      const formatTech = (t) => t ? t.replace(/_/g, ' ').replace(/\b\w/g, c => c.toUpperCase()) : '';

      // Define tech combinations for each question position
      const techCombinations = [
        ['Quantum', formatTech(tech2)],           // Q1: Quantum + Tech 2
        ['Quantum', formatTech(tech3)],           // Q2: Quantum + Tech 3
        ['Quantum', formatTech(tech2) || formatTech(tech3)]  // Q3: Quantum + one of them
      ];

      let extractedTexts = [];

      // Method 1: Split on numbered patterns (1. / 2. / 3. or 1) / 2) / 3))
      const numberedPattern = /(?:^|\n)\s*(?:\*\*)?(\d)[.)]\*?\*?\s*/g;
      const parts = response.split(/(?:^|\n)\s*(?:\*\*)?[1-3][.)]\*?\*?\s*/);

      // Filter out empty parts and take only parts that look like questions
      for (let i = 1; i < parts.length && extractedTexts.length < 3; i++) {
        let text = parts[i].trim();
        // Remove markdown formatting
        text = text.replace(/\*\*/g, '');
        // Take up to the first question mark or first line if no question mark
        const questionMatch = text.match(/^[^?]+\?/);
        if (questionMatch) {
          extractedTexts.push(questionMatch[0].trim());
        } else {
          const firstLine = text.split('\n')[0].trim();
          if (firstLine.length > 10) {
            extractedTexts.push(firstLine);
          }
        }
      }

      // Method 2: Fallback - look for "What if" or "Wat als" patterns
      if (extractedTexts.length === 0) {
        debugLog('Using What-if pattern fallback...');
        const whatIfPattern = /(?:What if|Wat als)[^?]*\?/gi;
        const matches = response.match(whatIfPattern);
        if (matches) {
          extractedTexts = matches.slice(0, 3).map(m => m.trim());
        }
      }

      // Method 3: Last resort - split by double newlines
      if (extractedTexts.length === 0) {
        debugLog('Using double-newline fallback...');
        const parts = response.split(/\n\n+/);
        for (const part of parts) {
          const cleaned = part.trim();
          if (cleaned.includes('?') && cleaned.length > 20) {
            extractedTexts.push(cleaned.split('?')[0] + '?');
            if (extractedTexts.length >= 3) break;
          }
        }
      }

      // Build final questions array with exactly 3 questions
      const questions = [];
      for (let i = 0; i < 3; i++) {
        questions.push({
          id: i + 1,
          text: extractedTexts[i] || `Question ${i + 1} could not be parsed from response.`,
          techs: techCombinations[i].filter(t => t)
        });
      }

      debugLog(`parseWhatIfResponse: extracted ${extractedTexts.length} questions`);
      return questions;
    }

    function displayWhatIfQuestions(questions) {
      const container = document.getElementById('whatif-questions-list');

      if (questions.length === 0) {
        container.innerHTML = '<p class="body-text">No questions generated. Try again or enter a custom question.</p>';
        return;
      }

      let html = '';
      questions.forEach((q, i) => {
        // Build tech header from question's techs array
        const techHeader = (q.techs || []).join(' + ');

        // Clean question text - remove markdown
        let questionText = (q.text || '')
          .replace(/\*\*/g, '')
          .replace(/(?<!\*)\*([^*]+)\*(?!\*)/g, '$1');

        // Make technology names bold in the question text
        (q.techs || []).forEach(tech => {
          if (tech) {
            const regex = new RegExp(`(${tech})`, 'gi');
            questionText = questionText.replace(regex, '<strong>$1</strong>');
          }
        });

        html += `
          <div class="whatif-card" onclick="selectWhatIf(${i})">
            <label style="display: flex; align-items: flex-start; gap: 0.75rem; cursor: pointer;">
              <input type="radio" name="whatif-selection" value="${i}" style="margin-top: 0.35rem; flex-shrink: 0;">
              <div style="flex: 1;">
                <div class="whatif-tech-header" style="font-weight: 700; color: #0000FF; margin-bottom: 0.5rem; font-size: 0.9rem;">${techHeader}</div>
                <div class="whatif-question">${questionText}</div>
              </div>
            </label>
          </div>
        `;
      });

      container.innerHTML = html;
    }

    function selectWhatIf(index) {
      // Clear custom input when selecting a generated question
      document.getElementById('input-custom-whatif').value = '';

      // Select the radio button
      const radios = document.querySelectorAll('input[name="whatif-selection"]');
      if (radios[index]) {
        radios[index].checked = true;
      }
    }

    function proceedToPhase3() {
      // Get selected question
      const selectedRadio = document.querySelector('input[name="whatif-selection"]:checked');
      const customInput = document.getElementById('input-custom-whatif').value.trim();

      let selectedQuestion = null;

      if (customInput) {
        selectedQuestion = customInput;
      } else if (selectedRadio) {
        const index = parseInt(selectedRadio.value);
        selectedQuestion = AppState.whatIfQuestions[index]?.text;
      }

      if (!selectedQuestion) {
        alert(t('select_whatif_error'));
        return;
      }

      AppState.selectedWhatIf = selectedQuestion;
      debugLog(`Selected what-if: ${selectedQuestion}`);

      // Navigate to Phase 3 and generate consequences
      goToPhase(3);
      generateConsequences();
    }

    // ================================
    // Phase 3: Consequences
    // ================================

    async function generateConsequences() {
      debugLog('Generating consequences...');

      // Display selected what-if (parse markdown to remove **)
      const whatIfDisplay = (AppState.selectedWhatIf || '')
        .replace(/\*\*([^*]+)\*\*/g, '$1')
        .replace(/\*([^*]+)\*/g, '$1');
      document.getElementById('selected-whatif-display').textContent = whatIfDisplay;

      const resultEl = document.getElementById('consequences-text');
      resultEl.innerHTML = `<div style="text-align: center; padding: 2rem;"><span class="loading-spinner"></span><br><br>${t('generating_consequences')}</div>`;

      try {
        // Fetch data from Supabase (filter tech knowledge by selected parent_techs)
        const [promptData, sectorData, techData] = await Promise.all([
          fetchPrompt('consequence_generation'),
          fetchSectorInfo(),
          fetchTechnologyKnowledge(AppState.selectedTechnologies || [])
        ]);

        // Build prompt
        const fullPrompt = buildConsequencePrompt(promptData, sectorData, techData);

        debugLog('Sending consequence prompt to Gemini...');
        debugLog(`Prompt length: ${fullPrompt.length} chars`);

        // Call Gemini
        const response = await callGemini(fullPrompt, null, 'consequences');

        AppState.consequences = response;

        // Format and display with styled sections
        resultEl.innerHTML = formatConsequencesOutput(response);

        debugLog('Consequences generated successfully');

      } catch (error) {
        debugLog(`Consequence generation error: ${error.message}`);
        resultEl.innerHTML = `<div class="status-message error">Error: ${error.message}</div>`;
      }
    }

    function buildConsequencePrompt(promptData, sectorData, techData) {
      const [techQuantum, tech2, tech3] = AppState.selectedTechnologies;
      const formatTech = (t) => t.replace(/_/g, ' ').replace(/\b\w/g, c => c.toUpperCase());

      const basePrompt = promptData?.prompt_text || `
Generate consequences for the selected what-if question, including 2nd and 3rd order effects,
new technology applications, ELSA implications, and who wins/loses.
Write in ${AppState.language === 'nl' ? 'Dutch' : 'English'}.
      `;

      const context = `
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
INPUT DATA
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

SELECTED WHAT-IF QUESTION:
${AppState.selectedWhatIf}

PHASE 1 SCENARIO:
${AppState.scenario || 'No scenario available'}

ARCHETYPE: ${AppState.archetypeContext?.scenario_name || AppState.archetype}
${AppState.archetypeContext?.description || ''}

SELECTED TECHNOLOGIES:
1. ${formatTech(techQuantum)}
2. ${formatTech(tech2)}
3. ${formatTech(tech3)}

ACTOR: ${formatTech(AppState.selectedActor)}
TRIGGER: ${formatTech(AppState.selectedEvent)}

‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
‚ö†Ô∏è CRITICAL: TECHNOLOGY KNOWLEDGE BASE
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
The following contains verified, curated information about the selected
technologies. Your response MUST be grounded in this data.

DO NOT use general knowledge or assumptions.
DO reference specific applications, ELSA implications, and key concepts listed below.

${formatTechDataForPrompt(techData)}

‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
‚úì VERIFICATION: Your response must reference at least 1 specific
  item from EACH technology category listed above.
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

SECTOR KNOWLEDGE (JenV):
${sectorData?.map(s => `- ${s.title}: ${s.content}`).join('\n') || 'Dutch Ministry of Justice and Security'}

OUTPUT LANGUAGE: ${AppState.language === 'nl' ? 'Dutch (Nederlands)' : 'English'}
`;

      return `${basePrompt}\n\n${context}`;
    }

    // ================================
    // Phase 4: Strategic Focus
    // ================================

    function initPhase4() {
      debugLog('Initializing Phase 4...');

      // Parse consequences into selectable items with source sections
      const consequences = AppState.consequences || '';
      const items = parseConsequencesForSelection(consequences);

      const container = document.getElementById('consequence-items');

      if (items.length === 0) {
        container.innerHTML = `<p class="body-text">${t('no_consequences')}</p>`;
        return;
      }

      let html = '';
      items.forEach((item, i) => {
        html += `
          <div class="priority-item" onclick="togglePriority(${i})">
            <label style="display: flex; align-items: flex-start; gap: 0.75rem; cursor: pointer;">
              <input type="checkbox" id="priority-${i}" value="${i}" onchange="updateStrategicSummary()" style="margin-top: 0.25rem; flex-shrink: 0;">
              <div class="priority-text">${item.text || item}</div>
            </label>
          </div>
        `;
      });

      container.innerHTML = html;

      // Store parsed items for later reference
      AppState.parsedConsequences = items;

      debugLog(`Phase 4 initialized with ${items.length} consequence items`);
    }

    function parseConsequencesForSelection(text) {
      if (!text) return [];

      const items = [];
      const lines = text.split('\n');

      for (const line of lines) {
        const trimmed = line.trim();

        // Skip empty lines and headers
        if (!trimmed) continue;
        if (trimmed.startsWith('#')) continue;
        if (trimmed.startsWith('**') && trimmed.endsWith('**')) continue;
        if (trimmed === trimmed.toUpperCase() && trimmed.length > 3) continue;
        if (trimmed.endsWith(':')) continue;

        // Extract bullet points and numbered items
        if (trimmed.match(/^[-‚Ä¢]\s/) || trimmed.match(/^\d+[.)]\s/) || trimmed.startsWith('* ')) {
          const content = trimmed
            .replace(/^[-‚Ä¢*]\s*/, '')
            .replace(/^\d+[.)]\s*/, '')
            .replace(/\*\*([^*]+)\*\*/g, '$1')
            .replace(/\*([^*]+)\*/g, '$1')
            .trim();

          if (content.length > 15) {
            items.push({ text: content });
          }
        }
      }

      return items.slice(0, 15);
    }

    function togglePriority(index) {
      const checkbox = document.getElementById(`priority-${index}`);
      if (checkbox) {
        checkbox.checked = !checkbox.checked;
        updateStrategicSummary();
      }
    }

    function updateStrategicSummary() {
      const selected = [];
      const checkboxes = document.querySelectorAll('#consequence-items input[type="checkbox"]:checked');

      checkboxes.forEach(cb => {
        const index = parseInt(cb.value);
        if (AppState.parsedConsequences && AppState.parsedConsequences[index]) {
          selected.push(AppState.parsedConsequences[index]);
        }
      });

      AppState.strategicPriorities = selected;

      const summaryEl = document.getElementById('strategic-summary');
      const summaryList = document.getElementById('strategic-summary-list');
      const notesSection = document.getElementById('strategic-notes-section');
      const selectPrompt = document.getElementById('phase4-select-prompt');
      const continueBtn = document.getElementById('phase4-continue-btn');

      if (selected.length > 0) {
        // Show summary, notes, and continue button
        summaryEl.style.display = 'block';
        summaryList.innerHTML = selected.map(s => {
          const text = s.text || s;
          return `<p class="body-text" style="margin-bottom: 0.5rem; padding-left: 1rem; border-left: 3px solid var(--blue);">${text}</p>`;
        }).join('');

        if (notesSection) notesSection.style.display = 'block';
        if (selectPrompt) selectPrompt.style.display = 'none';
        if (continueBtn) continueBtn.style.display = 'block';

        // Update priority item visual state
        document.querySelectorAll('.priority-item').forEach((item, i) => {
          const checkbox = item.querySelector('input[type="checkbox"]');
          if (checkbox?.checked) {
            item.classList.add('selected');
          } else {
            item.classList.remove('selected');
          }
        });
      } else {
        // Hide summary, notes, and continue button
        summaryEl.style.display = 'none';
        if (notesSection) notesSection.style.display = 'none';
        if (selectPrompt) selectPrompt.style.display = 'block';
        if (continueBtn) continueBtn.style.display = 'none';

        document.querySelectorAll('.priority-item').forEach(item => {
          item.classList.remove('selected');
        });
      }

      debugLog(`Strategic priorities updated: ${selected.length} items selected`);
    }

    // ================================
    // Phase 5: Export & Save
    // ================================

    function initPhase5() {
      debugLog('Initializing Phase 5...');

      // Save strategic notes
      AppState.strategicNotes = document.getElementById('input-strategic-notes')?.value || '';

      // Populate summary
      const formatTech = (t) => t?.replace(/_/g, ' ').replace(/\b\w/g, c => c.toUpperCase()) || '';

      document.getElementById('summary-archetype').textContent =
        AppState.archetypeContext?.scenario_name || AppState.archetype || '-';

      document.getElementById('summary-nuance').textContent =
        AppState.archetypeContext?.archetype || '';

      document.getElementById('summary-scenario').textContent =
        (AppState.scenario || '-').substring(0, 500) + (AppState.scenario?.length > 500 ? '...' : '');

      document.getElementById('summary-whatif').textContent =
        AppState.selectedWhatIf || '-';

      document.getElementById('summary-techs').textContent =
        AppState.selectedTechnologies.map(formatTech).join(', ') || '-';

      document.getElementById('summary-actor').textContent =
        formatTech(AppState.selectedActor) || '-';

      document.getElementById('summary-trigger').textContent =
        formatTech(AppState.selectedEvent) || '-';

      // Strategic priorities
      const prioritiesEl = document.getElementById('summary-priorities');
      if (AppState.strategicPriorities.length > 0) {
        prioritiesEl.innerHTML = AppState.strategicPriorities.map(p =>
          `<p class="body-text" style="margin-bottom: 0.25rem;">‚Ä¢ ${p}</p>`
        ).join('');
      } else {
        prioritiesEl.innerHTML = `<p class="body-text" style="opacity: 0.7;">${t('no_priorities')}</p>`;
      }

      // Notes
      const notesEl = document.getElementById('summary-notes');
      if (AppState.strategicNotes) {
        notesEl.innerHTML = `<p class="body-text">"${AppState.strategicNotes}"</p>`;
      } else {
        notesEl.innerHTML = '';
      }

      debugLog('Phase 5 summary populated');
    }

    function buildExportText() {
      const formatTech = (t) => t?.replace(/_/g, ' ').replace(/\b\w/g, c => c.toUpperCase()) || '';
      const lang = AppState.language;

      let text = `
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
TECH FUTURES EXPLORER - ${lang === 'nl' ? 'SESSIE RAPPORT' : 'SESSION REPORT'}
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

${lang === 'nl' ? 'SCENARIO' : 'SCENARIO'}: ${AppState.archetypeContext?.scenario_name || '-'}
${lang === 'nl' ? 'ARCHETYPE' : 'ARCHETYPE'}: ${AppState.archetypeContext?.archetype || AppState.archetype || '-'}

‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
${lang === 'nl' ? 'SCENARIO' : 'SCENARIO'}
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
${AppState.scenario || '-'}

‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
${lang === 'nl' ? 'TECHNOLOGIE√ãN & CONTEXT' : 'TECHNOLOGIES & CONTEXT'}
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
${lang === 'nl' ? 'Technologie√´n' : 'Technologies'}: ${AppState.selectedTechnologies.map(formatTech).join(', ')}
Actor: ${formatTech(AppState.selectedActor)}
Trigger: ${formatTech(AppState.selectedEvent)}

‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
WHAT-IF
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
${AppState.selectedWhatIf || '-'}

‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
${lang === 'nl' ? 'CONSEQUENTIES' : 'CONSEQUENCES'}
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
${AppState.consequences || '-'}

‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
${lang === 'nl' ? 'STRATEGISCHE PRIORITEITEN' : 'STRATEGIC PRIORITIES'}
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
${AppState.strategicPriorities.length > 0 ?
        AppState.strategicPriorities.map((p, i) => `${i + 1}. ${p}`).join('\n') :
        (lang === 'nl' ? 'Geen prioriteiten geselecteerd' : 'No priorities selected')}

${AppState.strategicNotes ? `
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
${lang === 'nl' ? 'NOTITIES' : 'NOTES'}
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
${AppState.strategicNotes}
` : ''}

‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
${lang === 'nl' ? 'Gegenereerd op' : 'Generated on'}: ${new Date().toLocaleString(lang === 'nl' ? 'nl-NL' : 'en-US')}
Tech Futures Explorer - Quantum Delta NL
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
`;

      return text.trim();
    }

    async function copyToClipboard() {
      const text = buildExportText();

      try {
        await navigator.clipboard.writeText(text);
        alert(t('copied_success'));
        debugLog('Text copied to clipboard');
      } catch (error) {
        debugLog(`Clipboard error: ${error.message}`);
        // Fallback for older browsers
        const textarea = document.createElement('textarea');
        textarea.value = text;
        document.body.appendChild(textarea);
        textarea.select();
        document.execCommand('copy');
        document.body.removeChild(textarea);
        alert(t('copied_success'));
      }
    }

    function exportToPDF() {
      debugLog('Generating PDF...');

      // Create a printable version
      const text = buildExportText();

      // Open print dialog with formatted content
      const printWindow = window.open('', '_blank');
      printWindow.document.write(`
        <!DOCTYPE html>
        <html>
        <head>
          <title>Tech Futures Explorer - Export</title>
          <style>
            body {
              font-family: 'Courier New', monospace;
              padding: 2rem;
              max-width: 800px;
              margin: 0 auto;
              font-size: 12px;
              line-height: 1.6;
            }
            pre {
              white-space: pre-wrap;
              word-wrap: break-word;
            }
            @media print {
              body { padding: 1rem; }
            }
          </style>
        </head>
        <body>
          <pre>${text.replace(/</g, '&lt;').replace(/>/g, '&gt;')}</pre>
          <scr` + `ipt>
            window.onload = function() {
              window.print();
            }
          </scr` + `ipt>
        </body>
        </html>
      `);
      printWindow.document.close();
    }

    async function saveSession() {
      const sessionName = document.getElementById('input-session-name').value.trim();
      const statusEl = document.getElementById('save-status');
      const btnEl = document.getElementById('btn-save-session');

      if (!sessionName) {
        statusEl.innerHTML = `<p class="status-message error">${AppState.language === 'nl' ? 'Voer een sessie naam in' : 'Enter a session name'}</p>`;
        return;
      }

      btnEl.disabled = true;
      btnEl.innerHTML = `<span class="loading-spinner"></span>`;
      statusEl.innerHTML = '';

      try {
        const sessionData = {
          name: sessionName,
          language: AppState.language,
          archetype_id: AppState.archetype,
          scenario_name: AppState.archetypeContext?.scenario_name,
          archetype_name: AppState.archetypeContext?.archetype,
          scenario: AppState.scenario,
          technologies: AppState.selectedTechnologies,
          actor: AppState.selectedActor,
          trigger_event: AppState.selectedEvent,
          whatif_question: AppState.selectedWhatIf,
          consequences: AppState.consequences,
          strategic_priorities: AppState.strategicPriorities,
          strategic_notes: AppState.strategicNotes,
          created_at: new Date().toISOString()
        };

        const { data, error } = await supabaseClient
          .from('sessions')
          .insert([sessionData])
          .select();

        if (error) throw error;

        AppState.savedSessionId = data?.[0]?.id;

        statusEl.innerHTML = `<p class="status-message success">‚úì ${t('save_success')} (ID: ${AppState.savedSessionId || 'saved'})</p>`;
        debugLog(`Session saved with ID: ${AppState.savedSessionId}`);

      } catch (error) {
        debugLog(`Save error: ${error.message}`);
        statusEl.innerHTML = `<p class="status-message error">${t('save_error')}: ${error.message}</p>`;
      } finally {
        btnEl.disabled = false;
        btnEl.textContent = t('save_to_database');
      }
    }

    function startNewSession() {
      // Reset AppState
      AppState.currentPhase = 1;
      AppState.archetype = null;
      AppState.archetypeContext = null;
      AppState.scenario = null;
      AppState.selectedTechnologies = [];
      AppState.selectedActor = null;
      AppState.selectedEvent = null;
      AppState.whatIfQuestions = [];
      AppState.selectedWhatIf = null;
      AppState.consequences = null;
      AppState.strategicPriorities = [];
      AppState.strategicNotes = '';
      AppState.savedSessionId = null;

      // Reset form elements
      document.getElementById('select-resources').value = '';
      document.getElementById('select-system').value = '';
      document.getElementById('select-values').value = '';
      document.getElementById('select-tech-2').value = '';
      document.getElementById('select-tech-3').value = '';
      document.getElementById('select-actor').value = '';
      document.getElementById('select-event').value = '';
      document.getElementById('input-custom-whatif').value = '';
      document.getElementById('input-strategic-notes').value = '';
      document.getElementById('input-session-name').value = '';

      // Hide result sections
      document.getElementById('archetype-result').style.display = 'none';
      document.getElementById('scenario-result').style.display = 'none';
      document.getElementById('whatif-result').style.display = 'none';
      document.getElementById('strategic-summary').style.display = 'none';
      document.getElementById('save-status').innerHTML = '';

      // Go to start screen
      showScreen('screen-start');

      debugLog('New session started - state reset');
    }

    // ================================
    // Camera Functions
    // ================================

    let cameraStream = null;
    let currentCameraPhase = null;
    let capturedImageData = null;

    async function openCamera(phase) {
      currentCameraPhase = phase;
      capturedImageData = null;

      const modal = document.getElementById('camera-modal');
      const video = document.getElementById('camera-video');
      const errorEl = document.getElementById('camera-error');
      const liveView = document.getElementById('camera-live');
      const previewView = document.getElementById('camera-preview');
      const processingView = document.getElementById('camera-processing');

      // Reset UI state
      liveView.style.display = 'flex';
      previewView.style.display = 'none';
      processingView.style.display = 'none';
      errorEl.style.display = 'none';
      document.getElementById('btn-capture').style.display = 'inline-block';
      document.getElementById('btn-retake').style.display = 'none';
      document.getElementById('btn-use-photo').style.display = 'none';

      // Update title and hint based on phase
      if (phase === 'phase1') {
        document.getElementById('camera-title').textContent = 'üì∑ ' + (AppState.language === 'nl' ? 'Scan 3 Kaarten' : 'Scan 3 Cards');
        document.getElementById('camera-hint').textContent = AppState.language === 'nl'
          ? 'Plaats Resources, System en Values kaarten in beeld'
          : 'Position Resources, System and Values cards in frame';
      } else {
        document.getElementById('camera-title').textContent = 'üì∑ ' + (AppState.language === 'nl' ? 'Scan 5 Kaarten' : 'Scan 5 Cards');
        document.getElementById('camera-hint').textContent = AppState.language === 'nl'
          ? 'Plaats 3 Tech + 1 Actor + 1 Event kaarten in beeld'
          : 'Position 3 Tech + 1 Actor + 1 Event cards in frame';
      }

      modal.style.display = 'flex';

      try {
        // Request camera access
        cameraStream = await navigator.mediaDevices.getUserMedia({
          video: {
            facingMode: 'environment', // Prefer back camera on mobile
            width: { ideal: 1920 },
            height: { ideal: 1080 }
          }
        });

        video.srcObject = cameraStream;
        await video.play();
        debugLog('Camera opened successfully');

      } catch (error) {
        debugLog(`Camera error: ${error.message}`);
        errorEl.textContent = t('camera_error') + ': ' + error.message;
        errorEl.style.display = 'block';
        liveView.style.display = 'none';
      }
    }

    function closeCamera() {
      const modal = document.getElementById('camera-modal');
      const video = document.getElementById('camera-video');

      // Stop camera stream
      if (cameraStream) {
        cameraStream.getTracks().forEach(track => track.stop());
        cameraStream = null;
      }

      video.srcObject = null;
      modal.style.display = 'none';
      currentCameraPhase = null;
      capturedImageData = null;

      debugLog('Camera closed');
    }

    function capturePhoto() {
      const video = document.getElementById('camera-video');
      const canvas = document.getElementById('camera-canvas');
      const image = document.getElementById('camera-image');
      const liveView = document.getElementById('camera-live');
      const previewView = document.getElementById('camera-preview');

      // Set canvas size to video size
      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;

      // Draw video frame to canvas
      const ctx = canvas.getContext('2d');
      ctx.drawImage(video, 0, 0);

      // Get image data as base64
      capturedImageData = canvas.toDataURL('image/jpeg', 0.9);

      // Show preview
      image.src = capturedImageData;
      liveView.style.display = 'none';
      previewView.style.display = 'flex';

      // Update buttons
      document.getElementById('btn-capture').style.display = 'none';
      document.getElementById('btn-retake').style.display = 'inline-block';
      document.getElementById('btn-use-photo').style.display = 'inline-block';

      debugLog('Photo captured');
    }

    function retakePhoto() {
      const liveView = document.getElementById('camera-live');
      const previewView = document.getElementById('camera-preview');

      capturedImageData = null;

      // Show live view again
      liveView.style.display = 'flex';
      previewView.style.display = 'none';

      // Update buttons
      document.getElementById('btn-capture').style.display = 'inline-block';
      document.getElementById('btn-retake').style.display = 'none';
      document.getElementById('btn-use-photo').style.display = 'none';

      debugLog('Retaking photo');
    }

    async function usePhoto() {
      if (!capturedImageData) return;

      const previewView = document.getElementById('camera-preview');
      const processingView = document.getElementById('camera-processing');
      const errorEl = document.getElementById('camera-error');

      // Show processing state
      previewView.style.display = 'none';
      processingView.style.display = 'flex';
      document.getElementById('camera-processing-text').textContent = t('analyzing_cards');
      document.getElementById('btn-retake').style.display = 'none';
      document.getElementById('btn-use-photo').style.display = 'none';
      errorEl.style.display = 'none';

      try {
        // Extract base64 data (remove data:image/jpeg;base64, prefix)
        const base64Image = capturedImageData.split(',')[1];

        // Build prompt based on phase
        let prompt;
        if (currentCameraPhase === 'phase1') {
          prompt = `Analyze this image of cards from a futures workshop.
Identify the 3 binary choice cards shown:
1. RESOURCES axis: Look for a card showing either "Abundance" or "Limits"
2. SYSTEM axis: Look for a card showing either "Stable" or "Breaks"
3. VALUES axis: Look for a card showing either "Collective" or "Individual"

Respond in JSON format only:
{
  "resources": "Abundance" or "Limits",
  "system": "Stable" or "Breaks",
  "values": "Collective" or "Individual",
  "confidence": "high", "medium", or "low"
}

If you cannot identify a card clearly, use null for that value.`;
        } else {
          prompt = `Analyze this image of cards from a futures workshop.
Identify 5 cards shown:
1. QUANTUM TECHNOLOGY: Always "quantum" (this is fixed)
2. TECHNOLOGY 2: One of "Neuro tech", "AGI", "Climate tech", "Robotics", "Space tech"
3. TECHNOLOGY 3: One of "Neuro tech", "AGI", "Climate tech", "Robotics", "Space tech"
4. ACTOR: One of "criminal_networks", "foreign_states", "big_tech", "research_institutions", "ngos", "citizens", "journalists", "startups", "insurance_companies"
5. TRIGGER EVENT: One of "major_breakthrough", "security_breach", "regulatory_shift", "talent_exodus", "international_treaty", "maturity_tipping_point", "loss_of_control", "public_scandal", "market_collapse"

Respond in JSON format only:
{
  "quantum_tech": "quantum",
  "tech_2": one of "Neuro tech", "AGI", "Climate tech", "Robotics", "Space tech",
  "tech_3": one of "Neuro tech", "AGI", "Climate tech", "Robotics", "Space tech",
  "actor": one of the actor values,
  "event": one of the event values,
  "confidence": "high", "medium", or "low"
}

If you cannot identify a card clearly, use null for that value.`;
        }

        debugLog('Sending image to Gemini for analysis...');

        // Call Gemini with image
        const response = await callGemini(prompt, base64Image, 'vision');

        debugLog('Gemini response: ' + response);

        // Parse the response
        const result = parseCardScanResponse(response);

        if (result) {
          // Apply results to dropdowns
          applyCardScanResults(result);

          // Close camera and show success
          closeCamera();
          debugLog('Cards detected and applied successfully');
        } else {
          throw new Error(t('card_scan_failed'));
        }

      } catch (error) {
        debugLog(`Card scan error: ${error.message}`);
        processingView.style.display = 'none';
        previewView.style.display = 'flex';
        errorEl.textContent = error.message;
        errorEl.style.display = 'block';
        document.getElementById('btn-retake').style.display = 'inline-block';
        document.getElementById('btn-use-photo').style.display = 'inline-block';
      }
    }

    function parseCardScanResponse(response) {
      try {
        // Try to extract JSON from the response
        let jsonStr = response;

        // If response contains markdown code block, extract it
        const jsonMatch = response.match(/```(?:json)?\s*([\s\S]*?)\s*```/);
        if (jsonMatch) {
          jsonStr = jsonMatch[1];
        }

        // Try to find JSON object in the response
        const objectMatch = jsonStr.match(/\{[\s\S]*\}/);
        if (objectMatch) {
          jsonStr = objectMatch[0];
        }

        const parsed = JSON.parse(jsonStr);
        debugLog('Parsed card scan result: ' + JSON.stringify(parsed));
        return parsed;
      } catch (error) {
        debugLog('Failed to parse card scan response: ' + error.message);
        return null;
      }
    }

    function applyCardScanResults(result) {
      if (currentCameraPhase === 'phase1') {
        // Apply Phase 1 results (capitalized values match Supabase archetype_context)
        if (result.resources) {
          document.getElementById('select-resources').value = result.resources;
        }
        if (result.system) {
          document.getElementById('select-system').value = result.system;
        }
        if (result.values) {
          document.getElementById('select-values').value = result.values;
        }
        debugLog(`Phase 1 cards applied: resources=${result.resources}, system=${result.system}, values=${result.values}`);
      } else {
        // Apply Phase 2 results
        // Quantum is always "quantum"
        if (result.quantum_tech) {
          document.getElementById('select-tech-quantum').value = 'quantum';
        }
        // Tech 2 & 3 use exact case-sensitive values (match Supabase parent_tech)
        if (result.tech_2) {
          document.getElementById('select-tech-2').value = result.tech_2;
        }
        if (result.tech_3) {
          document.getElementById('select-tech-3').value = result.tech_3;
        }
        // Actor and event use lowercase values
        if (result.actor) {
          document.getElementById('select-actor').value = result.actor.toLowerCase();
          // Hide custom input if visible
          document.getElementById('input-actor-custom').style.display = 'none';
        }
        if (result.event) {
          document.getElementById('select-event').value = result.event.toLowerCase();
          // Hide custom input if visible
          document.getElementById('input-event-custom').style.display = 'none';
        }
        debugLog(`Phase 2 cards applied: quantum=${result.quantum_tech}, tech2=${result.tech_2}, tech3=${result.tech_3}, actor=${result.actor}, event=${result.event}`);
      }
    }

    // ================================
    // Connection Test
    // ================================
    async function testConnection() {
      const statusEl = document.getElementById('connection-status');

      try {
        // Test Supabase connection by fetching archetype context
        const { data, error } = await supabaseClient
          .from('archetype_context')
          .select('*')
          .limit(1);

        if (error) throw error;

        statusEl.className = 'status-message success';
        statusEl.innerHTML = `‚úì ${t('connected')}`;
        debugLog('Connection test successful');

        // Log table info
        debugLog(`Sample archetype context: ${JSON.stringify(data)}`);

      } catch (error) {
        statusEl.className = 'status-message error';
        statusEl.innerHTML = `‚úó ${t('connection_error')}: ${error.message}`;
        debugLog(`Connection test failed: ${error.message}`);
      }
    }

    // ================================
    // Initialize Application
    // ================================
    document.addEventListener('DOMContentLoaded', async () => {
      debugLog('Application initializing...');

      // Initialize Supabase
      if (initSupabase()) {
        // Test the connection
        await testConnection();
      }

      debugLog('Application ready');
    });
  </script>

</body>
</html>
