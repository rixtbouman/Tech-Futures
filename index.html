<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Tech Futures Explorer - Quantum Delta NL</title>

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Roboto+Mono:wght@400;500&display=swap" rel="stylesheet">

  <!-- Supabase Client -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    /* ================================
       Design System - Clean & Professional
       Quantum Superposition Theme
       ================================ */
    :root {
      /* Core Colors */
      --black: #000000;
      --blue: #0000FF;
      --red: #FF0000;
      --white: #FFFFFF;

      /* Background Colors */
      --bg-page: #F5F5F5;
      --bg-card: #FFFFFF;
      --bg-content: #F8FAFC;
      --bg-subtle: #FAFAFA;

      /* Shadows */
      --shadow-sm: 0 1px 3px rgba(0,0,0,0.08);
      --shadow-md: 0 2px 8px rgba(0,0,0,0.1);
      --shadow-lg: 0 4px 16px rgba(0,0,0,0.12);

      /* Border Radius */
      --radius-sm: 4px;
      --radius-md: 8px;
      --radius-lg: 12px;

      /* Typography */
      --font-mono: 'Roboto Mono', monospace;
      --font-body: Arial, sans-serif;

      /* Spacing */
      --space-xs: 0.5rem;
      --space-sm: 0.75rem;
      --space-md: 1rem;
      --space-lg: 1.5rem;
      --space-xl: 2rem;
    }

    /* ================================
       Reset & Base Styles
       ================================ */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent;
    }

    body {
      font-family: var(--font-body);
      background-color: var(--bg-page);
      color: var(--black);
      min-height: 100vh;
      font-size: 16px;
      line-height: 1.5;
    }

    /* ================================
       Superposition Background Effect
       ================================ */
    .superposition-bg {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      pointer-events: none;
      z-index: -1;
      overflow: hidden;
    }

    .superposition-bg::before,
    .superposition-bg::after {
      content: '';
      position: absolute;
      border-radius: 50%;
    }

    .superposition-bg::before {
      width: 220px;
      height: 220px;
      background: radial-gradient(circle, rgba(0, 0, 255, 0.35) 0%, rgba(0, 0, 255, 0.15) 50%, transparent 75%);
      top: -40px;
      right: -40px;
    }

    .superposition-bg::after {
      width: 200px;
      height: 200px;
      background: radial-gradient(circle, rgba(255, 0, 255, 0.35) 0%, rgba(255, 0, 255, 0.15) 50%, transparent 75%);
      bottom: -30px;
      left: -30px;
    }

    /* ================================
       Typography Styles
       ================================ */
    .label {
      font-family: var(--font-mono);
      text-transform: uppercase;
      letter-spacing: 0.08em;
      font-size: 0.8rem;
      font-weight: 500;
      color: var(--blue);
    }

    .headline {
      font-family: var(--font-body);
      font-weight: 300;
      font-size: 1.75rem;
      line-height: 1.3;
      color: var(--black);
    }

    .sub-headline {
      font-family: var(--font-mono);
      font-weight: 400;
      font-size: 1rem;
      line-height: 1.5;
      color: #333;
    }

    .body-text {
      font-family: var(--font-body);
      font-weight: 400;
      font-size: 1rem;
      line-height: 1.7;
      color: #222;
    }

    .small-label {
      font-family: var(--font-mono);
      text-transform: uppercase;
      letter-spacing: 0.08em;
      font-size: 0.7rem;
      font-weight: 500;
      color: #666;
    }

    @media (min-width: 768px) {
      .headline {
        font-size: 2rem;
      }
      .sub-headline {
        font-size: 1.125rem;
      }
    }

    /* ================================
       Layout Components
       ================================ */
    .container {
      max-width: 800px;
      margin: 0 auto;
      padding: var(--space-md);
    }

    @media (min-width: 768px) {
      .container {
        padding: var(--space-xl);
      }
    }

    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: var(--space-sm) var(--space-md);
      background: var(--white);
      box-shadow: var(--shadow-sm);
      gap: var(--space-sm);
    }

    @media (min-width: 768px) {
      .header {
        padding: var(--space-md) var(--space-xl);
      }
    }

    .logo {
      font-family: var(--font-mono);
      font-weight: 400;
      font-size: 0.85rem;
      letter-spacing: 0.05em;
      color: #333;
    }

    @media (min-width: 768px) {
      .logo {
        font-size: 1rem;
      }
    }

    .phase-indicator {
      display: flex;
      gap: 0.5rem;
      align-items: center;
    }

    .phase-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: #DDD;
      transition: all 0.2s ease;
    }

    @media (min-width: 768px) {
      .phase-dot {
        width: 10px;
        height: 10px;
      }
      .phase-indicator {
        gap: 0.6rem;
      }
    }

    .phase-dot.active {
      background: var(--blue);
      transform: scale(1.2);
    }

    .phase-dot.completed {
      background: var(--blue);
      opacity: 0.5;
    }

    /* ================================
       Button Styles
       ================================ */
    .btn {
      font-family: var(--font-mono);
      text-transform: uppercase;
      letter-spacing: 0.06em;
      padding: 0.875rem 1.25rem;
      border: none;
      border-radius: var(--radius-sm);
      background: var(--white);
      color: var(--black);
      cursor: pointer;
      transition: all 0.15s ease;
      font-size: 0.8rem;
      font-weight: 500;
      min-height: 48px;
      touch-action: manipulation;
      box-shadow: var(--shadow-sm);
    }

    @media (min-width: 768px) {
      .btn {
        padding: 0.75rem 1.5rem;
        min-height: 44px;
      }
    }

    .btn:hover {
      box-shadow: var(--shadow-md);
      transform: translateY(-1px);
    }

    .btn:active {
      transform: translateY(0);
      box-shadow: var(--shadow-sm);
    }

    .btn-primary {
      background: var(--blue);
      color: var(--white);
    }

    .btn-primary:hover {
      background: #0000DD;
    }

    .btn-secondary {
      background: var(--black);
      color: var(--white);
    }

    .btn-secondary:hover {
      background: #222;
    }

    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }

    /* ================================
       Card Styles
       ================================ */
    .card {
      background: var(--bg-card);
      border-radius: var(--radius-md);
      box-shadow: var(--shadow-md);
      padding: var(--space-lg);
      margin-bottom: var(--space-md);
    }

    @media (min-width: 768px) {
      .card {
        padding: var(--space-xl);
        margin-bottom: var(--space-lg);
      }
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: var(--space-md);
      padding-bottom: var(--space-sm);
      border-bottom: 1px solid #EEE;
    }

    @media (min-width: 768px) {
      .card-header {
        margin-bottom: var(--space-lg);
      }
    }

    /* Nested cards for content sections */
    .card .card {
      background: var(--bg-content);
      box-shadow: none;
      border: 1px solid #EEE;
    }

    /* ================================
       Screen/View Styles
       ================================ */
    .screen {
      display: none;
      min-height: calc(100vh - 80px);
    }

    .screen.active {
      display: block;
    }

    /* ================================
       Language Selection Screen
       ================================ */
    #screen-start {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
      background: var(--white);
      padding: var(--space-lg);
    }

    .start-content {
      text-align: center;
      max-width: 500px;
      width: 100%;
    }

    .start-content .headline {
      margin-bottom: var(--space-sm);
    }

    .start-content .sub-headline {
      color: #666;
    }

    .language-buttons {
      display: flex;
      flex-direction: column;
      gap: var(--space-md);
      margin-top: var(--space-xl);
    }

    @media (min-width: 480px) {
      .language-buttons {
        flex-direction: row;
        justify-content: center;
      }
    }

    .language-btn {
      padding: 1rem 2rem;
      font-size: 0.875rem;
      background: var(--blue);
      color: var(--white);
    }

    .language-btn:hover {
      background: #0000DD;
    }

    /* ================================
       Status/Loading States
       ================================ */
    .status-message {
      padding: var(--space-md);
      margin: var(--space-md) 0;
      border-radius: var(--radius-sm);
      font-family: var(--font-mono);
      font-size: 0.8rem;
    }

    .status-message.error {
      background: #FEF2F2;
      color: #991B1B;
    }

    .status-message.success {
      background: #F0FDF4;
      color: #166534;
    }

    .status-message.loading {
      background: var(--bg-content);
      color: #666;
    }

    .loading-spinner {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 2px solid #DDD;
      border-top-color: var(--blue);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* ================================
       Debug Panel (Development)
       ================================ */
    #debug-panel {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: var(--black);
      color: var(--white);
      padding: 1rem;
      font-family: var(--font-mono);
      font-size: 0.75rem;
      max-height: 200px;
      overflow-y: auto;
    }

    #debug-panel.hidden {
      display: none;
    }

    .debug-toggle {
      position: fixed;
      bottom: 1rem;
      right: 1rem;
      z-index: 1000;
    }

    /* ================================
       Camera Modal Styles
       ================================ */
    .camera-modal {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.85);
      z-index: 2000;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: var(--space-md);
    }

    .camera-modal-content {
      background: var(--white);
      border-radius: var(--radius-lg);
      max-width: 600px;
      width: 100%;
      max-height: 90vh;
      overflow: hidden;
      box-shadow: var(--shadow-lg);
    }

    .camera-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: var(--space-md);
      border-bottom: 1px solid #EEE;
      background: var(--white);
    }

    .camera-view {
      position: relative;
      background: #111;
      min-height: 300px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .camera-view video,
    .camera-view img {
      width: 100%;
      max-height: 400px;
      object-fit: contain;
    }

    .camera-hint {
      position: absolute;
      bottom: var(--space-md);
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0, 0, 0, 0.7);
      color: var(--white);
      padding: var(--space-xs) var(--space-md);
      border-radius: var(--radius-sm);
      font-family: var(--font-mono);
      font-size: 0.7rem;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    .camera-controls {
      display: flex;
      flex-direction: column;
      gap: var(--space-sm);
      padding: var(--space-md);
      background: var(--bg-subtle);
    }

    @media (min-width: 480px) {
      .camera-controls {
        flex-direction: row;
        justify-content: center;
      }
    }

    .camera-controls .btn {
      width: 100%;
    }

    @media (min-width: 480px) {
      .camera-controls .btn {
        width: auto;
        min-width: 140px;
      }
    }

    .scan-button {
      width: 100%;
      margin-bottom: var(--space-md);
      background: var(--white);
      color: var(--blue);
      font-size: 0.875rem;
      padding: var(--space-md);
      border: 1px dashed var(--blue);
      border-radius: var(--radius-md);
    }

    .scan-button:hover {
      background: var(--blue);
      color: var(--white);
      border-style: solid;
    }

    .scan-divider {
      display: flex;
      align-items: center;
      gap: var(--space-md);
      margin: var(--space-md) 0;
      color: #999;
    }

    .scan-divider::before,
    .scan-divider::after {
      content: '';
      flex: 1;
      height: 1px;
      background: #DDD;
    }

    .scan-divider span {
      font-family: var(--font-mono);
      font-size: 0.7rem;
      text-transform: uppercase;
    }

    /* ================================
       Back Button Styles
       ================================ */
    .back-button {
      font-family: var(--font-mono);
      font-size: 0.8rem;
      color: #666;
      background: none;
      border: none;
      cursor: pointer;
      padding: var(--space-xs) 0;
      margin-bottom: var(--space-md);
      display: inline-flex;
      align-items: center;
      gap: var(--space-xs);
      transition: color 0.15s ease;
    }

    .back-button:hover {
      color: var(--blue);
    }

    .phase-header {
      display: flex;
      align-items: center;
      gap: var(--space-md);
      margin-bottom: var(--space-sm);
    }

    /* ================================
       Mobile Responsive Grids
       ================================ */
    .mobile-grid-1 {
      display: grid;
      grid-template-columns: 1fr;
      gap: 1rem;
    }

    .mobile-grid-2 {
      display: grid;
      grid-template-columns: 1fr;
      gap: 1rem;
    }

    .mobile-grid-3 {
      display: grid;
      grid-template-columns: 1fr;
      gap: 1rem;
    }

    @media (min-width: 768px) {
      .mobile-grid-2 {
        grid-template-columns: repeat(2, 1fr);
      }
      .mobile-grid-3 {
        grid-template-columns: repeat(3, 1fr);
      }
    }

    /* ================================
       Form Elements (Mobile Optimized)
       ================================ */
    select.btn,
    input.btn,
    textarea.btn {
      width: 100%;
      font-size: 16px;
      min-height: 48px;
      padding: var(--space-sm) var(--space-md);
      appearance: none;
      -webkit-appearance: none;
      border-radius: var(--radius-sm);
      border: 1px solid #DDD;
      background: var(--white);
      box-shadow: none;
    }

    select.btn:focus,
    input.btn:focus,
    textarea.btn:focus {
      outline: none;
      border-color: var(--blue);
      box-shadow: 0 0 0 3px rgba(0, 0, 255, 0.1);
    }

    select.btn {
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%23666' d='M6 8L1 3h10z'/%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right var(--space-md) center;
      padding-right: 2.5rem;
    }

    textarea.btn {
      min-height: 100px;
      resize: vertical;
    }

    input[type="text"].btn,
    input[type="email"].btn {
      text-transform: none;
    }

    /* Form field labels */
    .field-label {
      display: block;
      font-family: var(--font-mono);
      font-size: 0.7rem;
      text-transform: uppercase;
      letter-spacing: 0.06em;
      margin-bottom: var(--space-xs);
      color: #555;
    }

    .field-group {
      margin-bottom: var(--space-md);
    }

    /* Radio/Checkbox touch targets */
    input[type="radio"],
    input[type="checkbox"] {
      width: 20px;
      height: 20px;
      margin: 0;
      cursor: pointer;
      accent-color: var(--blue);
    }

    /* Clickable card items */
    .selectable-item {
      padding: var(--space-md);
      margin-bottom: var(--space-sm);
      background: var(--white);
      border: 1px solid #DDD;
      border-radius: var(--radius-sm);
      cursor: pointer;
      transition: all 0.15s ease;
    }

    .selectable-item:active {
      background: var(--bg-content);
    }

    .selectable-item.selected {
      background: rgba(0, 0, 255, 0.05);
      border-color: var(--blue);
    }

    /* Mobile-specific visibility */
    .hide-mobile {
      display: none;
    }

    @media (min-width: 768px) {
      .hide-mobile {
        display: block;
      }
      .hide-desktop {
        display: none;
      }
    }

    /* ================================
       AI Generated Content Styling
       ================================ */

    /* Scenario Title */
    .scenario-title {
      font-size: 1.25rem;
      font-weight: 600;
      color: var(--black);
      margin-bottom: var(--space-lg);
      line-height: 1.4;
    }

    /* Narrative Vignette */
    .narrative-vignette {
      background: #E8F4FC;
      padding: var(--space-md);
      border-radius: 6px;
      margin-bottom: var(--space-lg);
    }

    .narrative-label {
      font-family: var(--font-mono);
      font-size: 0.65rem;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: #666;
      margin-bottom: var(--space-sm);
      display: block;
    }

    .narrative-vignette p {
      font-style: italic;
      line-height: 1.7;
      color: #333;
      margin: 0;
    }

    /* Opportunities & Risks */
    .opportunities-section,
    .risks-section {
      padding: var(--space-md);
      border-radius: 6px;
      margin-bottom: var(--space-md);
    }

    .opportunities-section {
      background: rgba(0, 0, 255, 0.05);
      border-left: 3px solid var(--blue);
    }

    .risks-section {
      background: rgba(255, 0, 0, 0.05);
      border-left: 3px solid var(--red);
    }

    .section-header {
      background: #F0F0F0;
      padding: var(--space-sm) var(--space-md);
      margin: var(--space-lg) calc(-1 * var(--space-md)) var(--space-md);
      font-family: var(--font-mono);
      font-size: 0.7rem;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: #555;
      font-weight: 500;
    }

    .section-header:first-child {
      margin-top: 0;
    }

    /* What-If Question Cards */
    .whatif-card {
      background: var(--white);
      border: 1px solid #E0E0E0;
      border-radius: var(--radius-md);
      padding: var(--space-md);
      margin-bottom: var(--space-md);
      cursor: pointer;
      transition: all 0.15s ease;
    }

    .whatif-card:hover {
      border-color: var(--blue);
      box-shadow: var(--shadow-sm);
    }

    .whatif-card.selected {
      border-color: var(--blue);
      background: rgba(0, 0, 255, 0.03);
    }

    .whatif-question {
      font-size: 1.05rem;
      font-weight: 600;
      color: var(--black);
      margin-bottom: var(--space-sm);
      line-height: 1.5;
    }

    .whatif-meta {
      display: flex;
      flex-wrap: wrap;
      gap: var(--space-sm);
      margin-top: var(--space-sm);
    }

    .whatif-tag {
      font-family: var(--font-mono);
      font-size: 0.65rem;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      padding: 0.25rem 0.5rem;
      border-radius: 3px;
      background: #F0F0F0;
    }

    .whatif-tag.tech {
      background: rgba(0, 0, 255, 0.1);
      color: var(--blue);
    }

    .whatif-tag.domain {
      background: #F5F5F5;
      color: #666;
    }

    /* Consequences Sections */
    .consequence-section {
      margin-bottom: var(--space-lg);
    }

    .consequence-section ul {
      list-style: none;
      padding: 0;
      margin: 0;
    }

    .consequence-section li {
      padding: var(--space-sm) 0;
      padding-left: var(--space-md);
      position: relative;
      line-height: 1.6;
      border-bottom: 1px solid #F0F0F0;
    }

    .consequence-section li:last-child {
      border-bottom: none;
    }

    .consequence-section li::before {
      content: '‚Ä¢';
      position: absolute;
      left: 0;
      color: var(--blue);
      font-weight: bold;
    }

    /* ELSA Labels */
    .elsa-label {
      font-weight: 600;
      color: var(--black);
    }

    /* Winners/Losers */
    .winners-section {
      background: rgba(0, 0, 255, 0.05);
      padding: var(--space-md);
      border-radius: 6px;
      margin-bottom: var(--space-sm);
    }

    .losers-section {
      background: rgba(255, 0, 0, 0.05);
      padding: var(--space-md);
      border-radius: 6px;
    }

    /* Strategic Priority Items */
    .priority-item {
      background: var(--white);
      border: 1px solid #E0E0E0;
      border-radius: var(--radius-sm);
      padding: var(--space-md);
      margin-bottom: var(--space-sm);
      cursor: pointer;
      transition: all 0.15s ease;
    }

    .priority-item:hover {
      border-color: #CCC;
    }

    .priority-item.selected {
      border-color: var(--blue);
      background: rgba(0, 0, 255, 0.03);
    }

    .priority-source {
      font-family: var(--font-mono);
      font-size: 0.6rem;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: #888;
      margin-bottom: var(--space-xs);
    }

    .priority-text {
      font-size: 0.95rem;
      line-height: 1.5;
      color: #333;
    }
  </style>
</head>
<body>
  <!-- Quantum Superposition Background -->
  <div class="superposition-bg"></div>

  <!-- ================================
       Start Screen (Language Selection)
       ================================ -->
  <div id="screen-start" class="screen active">
    <div class="start-content">
      <p class="label">Quantum Delta NL</p>
      <h1 class="headline" style="margin: 1rem 0;">Tech Futures Explorer</h1>
      <p class="sub-headline" style="margin-bottom: 2rem;">
        Emerging Technologies Futures Exploration Tool
      </p>
      <p class="body-text" id="start-description">
        Verken hoe opkomende technologie√´n kunnen samenkomen en impact hebben op de samenleving.
      </p>
      <div class="language-buttons">
        <button class="btn language-btn" onclick="startSession('nl')">
          Nederlands
        </button>
        <button class="btn language-btn" onclick="startSession('en')">
          English
        </button>
      </div>

      <!-- Connection Status -->
      <div id="connection-status" class="status-message loading" style="margin-top: 2rem;">
        <span class="loading-spinner"></span>
        Verbinding maken met database...
      </div>
    </div>
  </div>

  <!-- ================================
       Main App Screen
       ================================ -->
  <div id="screen-main" class="screen">
    <header class="header">
      <div class="logo">TECH FUTURES</div>
      <div class="phase-indicator">
        <div class="phase-dot active" data-phase="1" title="Phase 1: Scenario"></div>
        <div class="phase-dot" data-phase="2" title="Phase 2: Disruption"></div>
        <div class="phase-dot" data-phase="3" title="Phase 3: Consequences"></div>
        <div class="phase-dot" data-phase="4" title="Phase 4: Strategy"></div>
        <div class="phase-dot" data-phase="5" title="Phase 5: Export"></div>
      </div>
      <button class="btn" onclick="showDebugInfo()" data-i18n="debug">Debug</button>
    </header>

    <main class="container">
      <!-- Phase 1: Scenario Foundation -->
      <section id="phase-1" class="phase-content active">
        <div class="card">
          <div class="card-header">
            <span class="label" data-i18n="phase1_title">Fase 1: Scenario Basis</span>
          </div>
          <p class="body-text" data-i18n="phase1_intro">
            Selecteer de 3 binaire keuzes om het basisscenario te bepalen.
          </p>

          <!-- Card Selection -->
          <div class="card" style="background: var(--bg-grey); margin-top: 1.5rem;">
            <!-- Scan Cards Button -->
            <button class="btn scan-button" onclick="openCamera('phase1')" data-i18n="scan_cards_phase1">
              üì∑ Scan Cards
            </button>
            <div class="scan-divider"><span data-i18n="or_manual">or select manually</span></div>

            <div class="mobile-grid-3">
              <div class="field-group">
                <label class="field-label" data-i18n="card_resources">Resources</label>
                <select id="select-resources" class="btn">
                  <option value="" data-i18n="select_placeholder">-- Kies --</option>
                  <option value="abundance">Abundance</option>
                  <option value="limits">Limits</option>
                </select>
              </div>
              <div class="field-group">
                <label class="field-label" data-i18n="card_system">System</label>
                <select id="select-system" class="btn">
                  <option value="" data-i18n="select_placeholder">-- Kies --</option>
                  <option value="stable">Stable</option>
                  <option value="breakdown">Breakdown</option>
                </select>
              </div>
              <div class="field-group">
                <label class="field-label" data-i18n="card_values">Values</label>
                <select id="select-values" class="btn">
                  <option value="" data-i18n="select_placeholder">-- Kies --</option>
                  <option value="collective">Collective</option>
                  <option value="individual">Individual</option>
                </select>
              </div>
            </div>
            <button class="btn btn-primary" style="margin-top: 1.5rem; width: 100%;" onclick="determineArchetype()" id="btn-determine" data-i18n="determine_archetype">
              Bepaal Archetype
            </button>
          </div>

          <!-- Archetype Result -->
          <div id="archetype-result" class="card" style="display: none; background: var(--bg-blue); margin-top: 1rem;">
            <p class="small-label" data-i18n="archetype">Archetype</p>
            <h2 class="headline" id="archetype-name" style="margin: 0.5rem 0;"></h2>
            <p class="sub-headline" id="archetype-nuance" style="color: var(--blue);"></p>
            <p class="body-text" id="archetype-summary" style="margin-top: 0.75rem;"></p>
          </div>

          <!-- Generated Scenario -->
          <div id="scenario-result" class="card" style="display: none; background: var(--bg-magenta); margin-top: 1rem;">
            <p class="small-label" data-i18n="generated_scenario">Gegenereerd Scenario</p>
            <div class="body-text" id="scenario-text" style="margin-top: 1rem; white-space: pre-line;"></div>
            <button class="btn btn-primary" style="margin-top: 1.5rem; width: 100%;" onclick="goToPhase(2)" data-i18n="continue_phase2">
              Verder naar Fase 2
            </button>
          </div>
        </div>
      </section>

      <!-- Phase 2: Disruption Introduction -->
      <section id="phase-2" class="phase-content" style="display: none;">
        <div class="card">
          <button class="back-button" onclick="goToPhase(1)">‚Üê Back</button>
          <div class="card-header">
            <span class="label" data-i18n="phase2_title">Fase 2: Disruptie</span>
          </div>
          <p class="body-text" data-i18n="phase2_intro">
            Selecteer technologie√´n, een actor en een trigger om what-if vragen te genereren.
          </p>

          <!-- Technology Selection -->
          <div class="card" style="background: var(--bg-grey); margin-top: 1.5rem;">
            <!-- Scan Cards Button -->
            <button class="btn scan-button" onclick="openCamera('phase2')" data-i18n="scan_cards_phase2">
              üì∑ Scan All Cards (Tech + Actor + Event)
            </button>
            <div class="scan-divider"><span data-i18n="or_manual">or select manually</span></div>

            <p class="small-label" style="margin-bottom: 0.75rem;" data-i18n="select_technologies">Technologie√´n (3, inclusief quantum)</p>
            <div class="mobile-grid-3">
              <div class="field-group">
                <label class="field-label">Quantum Tech</label>
                <select id="select-tech-quantum" class="btn">
                  <option value="quantum_sensing">Quantum Sensing</option>
                  <option value="quantum_computing">Quantum Computing</option>
                  <option value="quantum_communication">Quantum Communication</option>
                </select>
              </div>
              <div class="field-group">
                <label class="field-label">Technology 2</label>
                <select id="select-tech-2" class="btn">
                  <option value="" data-i18n="select_placeholder">-- Kies --</option>
                  <option value="climate_tech">Climate Tech</option>
                  <option value="biotech">Biotech</option>
                  <option value="neurotech">Neurotech</option>
                  <option value="space_tech">Space Tech</option>
                  <option value="agi">AGI</option>
                  <option value="asi">ASI</option>
                  <option value="robotics">Robotics</option>
                </select>
              </div>
              <div class="field-group">
                <label class="field-label">Technology 3</label>
                <select id="select-tech-3" class="btn">
                  <option value="" data-i18n="select_placeholder">-- Kies --</option>
                  <option value="climate_tech">Climate Tech</option>
                  <option value="biotech">Biotech</option>
                  <option value="neurotech">Neurotech</option>
                  <option value="space_tech">Space Tech</option>
                  <option value="agi">AGI</option>
                  <option value="asi">ASI</option>
                  <option value="robotics">Robotics</option>
                </select>
              </div>
            </div>

            <!-- Actor and Event -->
            <div class="mobile-grid-2" style="margin-top: 1.5rem;">
              <div class="field-group">
                <label class="field-label" data-i18n="select_actor">Actor</label>
                <select id="select-actor" class="btn">
                  <option value="" data-i18n="select_placeholder">-- Kies --</option>
                  <option value="criminal_networks">Criminal networks</option>
                  <option value="foreign_states">Foreign states</option>
                  <option value="big_tech">Big Tech</option>
                  <option value="research_institutions">Research institutions</option>
                  <option value="ngos">NGOs</option>
                  <option value="citizens">Citizens</option>
                  <option value="journalists">Journalists</option>
                  <option value="startups">Startups</option>
                  <option value="insurance_companies">Insurance companies</option>
                  <option value="custom">Custom (enter below)</option>
                </select>
                <input type="text" id="input-actor-custom" class="btn" placeholder="Custom actor..." style="margin-top: 0.5rem; display: none;">
              </div>
              <div class="field-group">
                <label class="field-label" data-i18n="select_event">Trigger Event</label>
                <select id="select-event" class="btn">
                  <option value="" data-i18n="select_placeholder">-- Kies --</option>
                  <option value="major_breakthrough">Major breakthrough</option>
                  <option value="security_breach">Security breach</option>
                  <option value="regulatory_shift">Regulatory shift</option>
                  <option value="talent_exodus">Talent exodus</option>
                  <option value="international_treaty">International treaty</option>
                  <option value="maturity_tipping_point">Maturity tipping point</option>
                  <option value="loss_of_control">Loss of control</option>
                  <option value="public_scandal">Public scandal</option>
                  <option value="market_collapse">Market collapse</option>
                  <option value="custom">Custom (enter below)</option>
                </select>
                <input type="text" id="input-event-custom" class="btn" placeholder="Custom event..." style="margin-top: 0.5rem; display: none;">
              </div>
            </div>

            <button class="btn btn-primary" style="margin-top: 1.5rem; width: 100%;" onclick="generateWhatIfQuestions()" id="btn-generate-whatif" data-i18n="generate_whatif">
              Genereer What-If Vragen
            </button>
          </div>

          <!-- What-If Questions Result -->
          <div id="whatif-result" class="card" style="display: none; background: var(--bg-blue); margin-top: 1rem;">
            <p class="small-label" data-i18n="whatif_questions">What-If Vragen</p>
            <div id="whatif-questions-list" style="margin-top: 1rem;"></div>

            <!-- Custom What-If Input -->
            <div style="margin-top: 1.5rem; padding-top: 1rem; border-top: 1px solid var(--black);">
              <p class="small-label" data-i18n="or_custom_whatif">Of voer een eigen vraag in:</p>
              <textarea id="input-custom-whatif" class="btn" placeholder="What if..." style="width: 100%; height: 80px; margin-top: 0.5rem; resize: vertical; text-transform: none;"></textarea>
            </div>

            <button class="btn btn-primary" style="margin-top: 1rem; width: 100%;" onclick="proceedToPhase3()" id="btn-proceed-phase3" data-i18n="continue_phase3">
              Verder met geselecteerde vraag
            </button>
          </div>
        </div>
      </section>

      <!-- Phase 3: Consequences -->
      <section id="phase-3" class="phase-content" style="display: none;">
        <div class="card">
          <button class="back-button" onclick="goToPhase(2)">‚Üê Back</button>
          <div class="card-header">
            <span class="label" data-i18n="phase3_title">Fase 3: Consequenties</span>
          </div>

          <!-- Selected What-If Display -->
          <div class="card" style="background: var(--bg-blue); margin-bottom: 1rem;">
            <p class="small-label" data-i18n="selected_whatif">Geselecteerde What-If Vraag</p>
            <p class="sub-headline" id="selected-whatif-display" style="margin-top: 0.5rem;"></p>
          </div>

          <!-- Consequences Result -->
          <div id="consequences-result" class="card" style="background: var(--bg-magenta);">
            <p class="small-label" data-i18n="consequences">Consequenties</p>
            <div class="body-text" id="consequences-text" style="margin-top: 1rem; white-space: pre-line;">
              <div style="text-align: center; padding: 2rem;">
                <span class="loading-spinner"></span><br><br>
                <span data-i18n="generating_consequences">Consequenties genereren...</span>
              </div>
            </div>
          </div>

          <button class="btn btn-primary" style="margin-top: 1rem; width: 100%;" onclick="goToPhase(4)" data-i18n="continue_phase4">
            Verder naar Fase 4
          </button>
        </div>
      </section>

      <!-- Phase 4: Strategic Focus -->
      <section id="phase-4" class="phase-content" style="display: none;">
        <div class="card">
          <button class="back-button" onclick="goToPhase(3)">‚Üê Back</button>
          <div class="card-header">
            <span class="label" data-i18n="phase4_title">Fase 4: Strategische Focus</span>
          </div>
          <p class="body-text" data-i18n="phase4_intro">
            Selecteer de belangrijkste consequenties om strategisch te bespreken. Markeer items die aandacht vereisen.
          </p>

          <!-- Consequence Selection -->
          <div id="strategic-consequences" class="card" style="background: var(--bg-grey); margin-top: 1.5rem;">
            <p class="small-label" data-i18n="select_strategic">Selecteer strategische prioriteiten</p>
            <div id="consequence-items" style="margin-top: 1rem;">
              <!-- Populated dynamically -->
            </div>
          </div>

          <!-- Strategic Notes -->
          <div class="card" style="background: var(--bg-blue); margin-top: 1rem;">
            <p class="small-label" data-i18n="strategic_notes">Strategische Notities</p>
            <textarea id="input-strategic-notes" class="btn" placeholder="Notities voor de strategie discussie..." style="width: 100%; height: 120px; margin-top: 0.5rem; resize: vertical; text-transform: none;"></textarea>
          </div>

          <!-- Summary of selected items -->
          <div id="strategic-summary" class="card" style="background: var(--bg-magenta); margin-top: 1rem; display: none;">
            <p class="small-label" data-i18n="strategic_summary">Geselecteerde Prioriteiten</p>
            <div id="strategic-summary-list" style="margin-top: 0.5rem;"></div>
          </div>

          <button class="btn btn-primary" style="margin-top: 1rem; width: 100%;" onclick="goToPhase(5)" data-i18n="continue_phase5">
            Verder naar Export
          </button>
        </div>
      </section>

      <!-- Phase 5: Export -->
      <section id="phase-5" class="phase-content" style="display: none;">
        <div class="card">
          <button class="back-button" onclick="goToPhase(4)">‚Üê Back</button>
          <div class="card-header">
            <span class="label" data-i18n="phase5_title">Fase 5: Export & Opslaan</span>
          </div>
          <p class="body-text" data-i18n="phase5_intro">
            Bekijk de volledige sessie samenvatting en exporteer of sla op voor later gebruik.
          </p>

          <!-- Session Summary -->
          <div id="session-summary" class="card" style="background: var(--bg-grey); margin-top: 1.5rem;">
            <p class="small-label" data-i18n="session_summary">Sessie Samenvatting</p>

            <!-- Archetype & Scenario -->
            <div style="margin-top: 1rem; padding: 1rem; background: var(--white); border: 1px solid var(--black);">
              <p class="small-label" style="color: var(--blue);">ARCHETYPE</p>
              <p class="sub-headline" id="summary-archetype"></p>
              <p class="body-text" id="summary-nuance" style="margin-top: 0.25rem; font-size: 0.875rem; opacity: 0.8;"></p>
            </div>

            <!-- Scenario Preview -->
            <div style="margin-top: 1rem; padding: 1rem; background: var(--white); border: 1px solid var(--black);">
              <p class="small-label" style="color: var(--magenta);">SCENARIO</p>
              <p class="body-text" id="summary-scenario" style="margin-top: 0.5rem; max-height: 150px; overflow-y: auto;"></p>
            </div>

            <!-- What-If Question -->
            <div style="margin-top: 1rem; padding: 1rem; background: var(--white); border: 1px solid var(--black);">
              <p class="small-label" style="color: var(--blue);">WHAT-IF</p>
              <p class="body-text" id="summary-whatif" style="margin-top: 0.5rem;"></p>
            </div>

            <!-- Technologies & Context -->
            <div style="margin-top: 1rem; padding: 1rem; background: var(--white); border: 1px solid var(--black);">
              <p class="small-label" style="color: var(--red);">CONTEXT</p>
              <div style="margin-top: 0.5rem;">
                <p class="body-text" style="margin-bottom: 0.25rem;"><strong>Technologies:</strong> <span id="summary-techs"></span></p>
                <p class="body-text" style="margin-bottom: 0.25rem;"><strong>Actor:</strong> <span id="summary-actor"></span></p>
                <p class="body-text"><strong>Trigger:</strong> <span id="summary-trigger"></span></p>
              </div>
            </div>

            <!-- Strategic Priorities -->
            <div style="margin-top: 1rem; padding: 1rem; background: var(--white); border: 1px solid var(--black);">
              <p class="small-label" style="color: var(--magenta);">STRATEGISCHE PRIORITEITEN</p>
              <div id="summary-priorities" style="margin-top: 0.5rem;"></div>
              <div id="summary-notes" style="margin-top: 0.5rem; font-style: italic;"></div>
            </div>
          </div>

          <!-- Export Options -->
          <div class="card" style="background: var(--bg-blue); margin-top: 1rem;">
            <p class="small-label" data-i18n="export_options">Export Opties</p>
            <div class="mobile-grid-2" style="margin-top: 1rem;">
              <button class="btn btn-secondary" onclick="exportToPDF()" data-i18n="export_pdf">
                Download PDF
              </button>
              <button class="btn btn-secondary" onclick="copyToClipboard()" data-i18n="copy_summary">
                Kopieer Tekst
              </button>
            </div>
          </div>

          <!-- Save to Database -->
          <div class="card" style="background: var(--bg-magenta); margin-top: 1rem;">
            <p class="small-label" data-i18n="save_session">Sessie Opslaan</p>
            <div style="margin-top: 0.75rem;">
              <label class="small-label" data-i18n="session_name">Sessie Naam</label>
              <input type="text" id="input-session-name" class="btn" placeholder="Geef een naam aan deze sessie..." style="width: 100%; margin-top: 0.5rem; text-transform: none;">
            </div>
            <button class="btn btn-primary" style="margin-top: 1rem; width: 100%;" onclick="saveSession()" id="btn-save-session" data-i18n="save_to_database">
              Opslaan in Database
            </button>
            <div id="save-status" style="margin-top: 0.75rem;"></div>
          </div>

          <!-- New Session Button -->
          <button class="btn" style="margin-top: 1.5rem; width: 100%;" onclick="startNewSession()" data-i18n="start_new">
            Start Nieuwe Sessie
          </button>
        </div>
      </section>
    </main>
  </div>

  <!-- Camera Modal -->
  <div id="camera-modal" class="camera-modal" style="display: none;">
    <div class="camera-modal-content">
      <div class="camera-header">
        <span class="label" id="camera-title">üì∑ Scan Cards</span>
        <button class="btn" onclick="closeCamera()">‚úï</button>
      </div>

      <!-- Live Camera View -->
      <div id="camera-live" class="camera-view">
        <video id="camera-video" autoplay playsinline></video>
        <p class="camera-hint" id="camera-hint">Position all cards in frame</p>
      </div>

      <!-- Captured Image Preview -->
      <div id="camera-preview" class="camera-view" style="display: none;">
        <img id="camera-image" alt="Captured cards">
        <canvas id="camera-canvas" style="display: none;"></canvas>
      </div>

      <!-- Processing State -->
      <div id="camera-processing" class="camera-view" style="display: none;">
        <div style="text-align: center; padding: 3rem;">
          <span class="loading-spinner" style="width: 40px; height: 40px;"></span>
          <p class="body-text" style="margin-top: 1rem;" id="camera-processing-text">Analyzing cards...</p>
        </div>
      </div>

      <!-- Camera Controls -->
      <div class="camera-controls">
        <button id="btn-capture" class="btn btn-primary" onclick="capturePhoto()">
          üì∏ Capture
        </button>
        <button id="btn-retake" class="btn" onclick="retakePhoto()" style="display: none;">
          ‚Üª Retake
        </button>
        <button id="btn-use-photo" class="btn btn-primary" onclick="usePhoto()" style="display: none;">
          ‚úì Use This Photo
        </button>
      </div>

      <!-- Error Message -->
      <div id="camera-error" class="status-message error" style="display: none; margin-top: 1rem;"></div>
    </div>
  </div>

  <!-- Debug Toggle -->
  <button class="btn debug-toggle" onclick="toggleDebug()">DB</button>

  <!-- Debug Panel -->
  <div id="debug-panel" class="hidden">
    <strong>Debug Log:</strong>
    <pre id="debug-log"></pre>
  </div>

  <!-- ================================
       JavaScript Application
       ================================ -->
  <script>
    // ================================
    // Configuration
    // ================================
    const SUPABASE_URL = 'https://ccfyvpqtxypiawbbftgs.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNjZnl2cHF0eHlwaWF3YmJmdGdzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY4MzIzOTYsImV4cCI6MjA4MjQwODM5Nn0.C-_T4ZmhcB1rihlcnpwUC_APohAOGEE9nQREmsXBTVg';

    // ================================
    // Global State
    // ================================
    const AppState = {
      language: 'nl',
      currentPhase: 1,
      sessionId: null,
      archetype: null,
      archetypeMapping: null,
      archetypeDescription: null,
      scenario: null,
      selectedTechnologies: [],
      selectedActor: null,
      selectedEvent: null,
      whatIfQuestions: [],
      selectedWhatIf: null,
      consequences: null,
      strategicPriorities: [],
      strategicNotes: '',
      savedSessionId: null
    };

    // ================================
    // Supabase Client
    // ================================
    let supabaseClient = null;

    function initSupabase() {
      try {
        supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        debugLog('Supabase client initialized');
        return true;
      } catch (error) {
        debugLog('Supabase init error: ' + error.message);
        return false;
      }
    }

    // ================================
    // Language/i18n System
    // ================================
    const translations = {
      nl: {
        phase1_title: 'Fase 1: Scenario Basis',
        phase1_intro: 'Selecteer de 3 binaire keuzes om het basisscenario te bepalen.',
        card_resources: 'Resources',
        card_system: 'System',
        card_values: 'Values',
        select_placeholder: '-- Kies --',
        determine_archetype: 'Genereer Scenario',
        archetype: 'Archetype',
        generated_scenario: 'Gegenereerd Scenario',
        continue_phase2: 'Verder naar Fase 2',
        debug: 'Debug',
        connecting: 'Verbinding maken...',
        connected: 'Verbonden met database',
        connection_error: 'Kan geen verbinding maken met database',
        select_all_options: 'Selecteer alle drie de opties',
        generating_scenario: 'Scenario wordt gegenereerd...',
        determining_archetype: 'Archetype bepalen...',
        error_archetype: 'Fout bij ophalen archetype',
        // Phase 2
        phase2_title: 'Fase 2: Disruptie',
        phase2_intro: 'Selecteer technologie√´n, een actor en een trigger om what-if vragen te genereren.',
        select_technologies: 'Technologie√´n (3, inclusief quantum)',
        select_actor: 'Actor',
        select_event: 'Trigger Event',
        generate_whatif: 'Genereer What-If Vragen',
        generating_whatif: 'What-if vragen genereren...',
        whatif_questions: 'What-If Vragen',
        or_custom_whatif: 'Of voer een eigen vraag in:',
        continue_phase3: 'Verder met geselecteerde vraag',
        select_whatif_error: 'Selecteer een what-if vraag of voer een eigen vraag in',
        select_tech_actor_event: 'Selecteer alle technologie√´n, actor en event',
        // Phase 3
        phase3_title: 'Fase 3: Consequenties',
        selected_whatif: 'Geselecteerde What-If Vraag',
        consequences: 'Consequenties',
        generating_consequences: 'Consequenties genereren...',
        continue_phase4: 'Verder naar Fase 4',
        // Phase 4
        phase4_title: 'Fase 4: Strategische Focus',
        phase4_intro: 'Selecteer de belangrijkste consequenties om strategisch te bespreken. Markeer items die aandacht vereisen.',
        select_strategic: 'Selecteer strategische prioriteiten',
        strategic_notes: 'Strategische Notities',
        strategic_summary: 'Geselecteerde Prioriteiten',
        continue_phase5: 'Verder naar Export',
        no_consequences: 'Geen consequenties beschikbaar. Ga terug naar Fase 3.',
        // Phase 5
        phase5_title: 'Fase 5: Export & Opslaan',
        phase5_intro: 'Bekijk de volledige sessie samenvatting en exporteer of sla op voor later gebruik.',
        session_summary: 'Sessie Samenvatting',
        export_options: 'Export Opties',
        export_pdf: 'Download PDF',
        copy_summary: 'Kopieer Tekst',
        save_session: 'Sessie Opslaan',
        session_name: 'Sessie Naam',
        save_to_database: 'Opslaan in Database',
        start_new: 'Start Nieuwe Sessie',
        copied_success: 'Gekopieerd naar klembord!',
        save_success: 'Sessie opgeslagen!',
        save_error: 'Fout bij opslaan',
        no_priorities: 'Geen prioriteiten geselecteerd',
        pdf_generating: 'PDF genereren...',
        // Camera
        scan_cards_phase1: 'üì∑ Scan Kaarten',
        scan_cards_phase2: 'üì∑ Scan Alle Kaarten (Tech + Actor + Event)',
        or_manual: 'of selecteer handmatig',
        camera_error: 'Camera niet beschikbaar',
        analyzing_cards: 'Kaarten analyseren...',
        card_scan_failed: 'Kaarten niet herkend, probeer opnieuw',
        cards_detected: 'Kaarten gedetecteerd!'
      },
      en: {
        phase1_title: 'Phase 1: Scenario Foundation',
        phase1_intro: 'Select the 3 binary choices to determine the base scenario.',
        card_resources: 'Resources',
        card_system: 'System',
        card_values: 'Values',
        select_placeholder: '-- Select --',
        determine_archetype: 'Generate Scenario',
        archetype: 'Archetype',
        generated_scenario: 'Generated Scenario',
        continue_phase2: 'Continue to Phase 2',
        debug: 'Debug',
        connecting: 'Connecting...',
        connected: 'Connected to database',
        connection_error: 'Cannot connect to database',
        select_all_options: 'Please select all three options',
        generating_scenario: 'Generating scenario...',
        determining_archetype: 'Determining archetype...',
        error_archetype: 'Error fetching archetype',
        // Phase 2
        phase2_title: 'Phase 2: Disruption',
        phase2_intro: 'Select technologies, an actor, and a trigger to generate what-if questions.',
        select_technologies: 'Technologies (3, including quantum)',
        select_actor: 'Actor',
        select_event: 'Trigger Event',
        generate_whatif: 'Generate What-If Questions',
        generating_whatif: 'Generating what-if questions...',
        whatif_questions: 'What-If Questions',
        or_custom_whatif: 'Or enter your own question:',
        continue_phase3: 'Continue with selected question',
        select_whatif_error: 'Select a what-if question or enter your own',
        select_tech_actor_event: 'Select all technologies, actor, and event',
        // Phase 3
        phase3_title: 'Phase 3: Consequences',
        selected_whatif: 'Selected What-If Question',
        consequences: 'Consequences',
        generating_consequences: 'Generating consequences...',
        continue_phase4: 'Continue to Phase 4',
        // Phase 4
        phase4_title: 'Phase 4: Strategic Focus',
        phase4_intro: 'Select the key consequences for strategic discussion. Mark items requiring attention.',
        select_strategic: 'Select strategic priorities',
        strategic_notes: 'Strategic Notes',
        strategic_summary: 'Selected Priorities',
        continue_phase5: 'Continue to Export',
        no_consequences: 'No consequences available. Go back to Phase 3.',
        // Phase 5
        phase5_title: 'Phase 5: Export & Save',
        phase5_intro: 'Review the full session summary and export or save for later use.',
        session_summary: 'Session Summary',
        export_options: 'Export Options',
        export_pdf: 'Download PDF',
        copy_summary: 'Copy Text',
        save_session: 'Save Session',
        session_name: 'Session Name',
        save_to_database: 'Save to Database',
        start_new: 'Start New Session',
        copied_success: 'Copied to clipboard!',
        save_success: 'Session saved!',
        save_error: 'Error saving',
        no_priorities: 'No priorities selected',
        pdf_generating: 'Generating PDF...',
        // Camera
        scan_cards_phase1: 'üì∑ Scan Cards',
        scan_cards_phase2: 'üì∑ Scan All Cards (Tech + Actor + Event)',
        or_manual: 'or select manually',
        camera_error: 'Camera not available',
        analyzing_cards: 'Analyzing cards...',
        card_scan_failed: 'Cards not recognized, please try again',
        cards_detected: 'Cards detected!'
      }
    };

    function t(key) {
      return translations[AppState.language]?.[key] || translations['en']?.[key] || key;
    }

    function updateUILanguage() {
      document.querySelectorAll('[data-i18n]').forEach(el => {
        const key = el.getAttribute('data-i18n');
        el.textContent = t(key);
      });
      document.documentElement.lang = AppState.language;
    }

    // ================================
    // Debug Utilities
    // ================================
    function debugLog(message) {
      const timestamp = new Date().toLocaleTimeString();
      const logEl = document.getElementById('debug-log');
      if (logEl) {
        logEl.textContent += `[${timestamp}] ${message}\n`;
        logEl.scrollTop = logEl.scrollHeight;
      }
      console.log(`[Debug] ${message}`);
    }

    function toggleDebug() {
      document.getElementById('debug-panel').classList.toggle('hidden');
    }

    function showDebugInfo() {
      debugLog('Current State: ' + JSON.stringify(AppState, null, 2));
    }

    // ================================
    // Screen Navigation
    // ================================
    function showScreen(screenId) {
      document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
      document.getElementById(screenId)?.classList.add('active');
    }

    function goToPhase(phase) {
      AppState.currentPhase = phase;

      // Update phase indicators
      document.querySelectorAll('.phase-dot').forEach(dot => {
        const dotPhase = parseInt(dot.dataset.phase);
        dot.classList.remove('active', 'completed');
        if (dotPhase === phase) dot.classList.add('active');
        if (dotPhase < phase) dot.classList.add('completed');
      });

      // Show correct phase content
      document.querySelectorAll('.phase-content').forEach(p => p.style.display = 'none');
      document.getElementById(`phase-${phase}`).style.display = 'block';

      // Restore previously generated content when navigating back
      if (phase === 1) {
        // Show archetype and scenario if they exist
        if (AppState.archetype) {
          document.getElementById('archetype-result').style.display = 'block';
        }
        if (AppState.scenario) {
          document.getElementById('scenario-result').style.display = 'block';
        }
      } else if (phase === 2) {
        // Show what-if questions if they exist
        if (AppState.whatIfQuestions.length > 0) {
          document.getElementById('whatif-result').style.display = 'block';
        }
      } else if (phase === 3) {
        // Show consequences if they exist
        if (AppState.consequences) {
          document.getElementById('consequences-text').innerHTML = formatConsequencesOutput(AppState.consequences);
        }
      }

      // Initialize phase-specific content
      if (phase === 4) initPhase4();
      if (phase === 5) initPhase5();

      debugLog(`Navigated to Phase ${phase}`);
    }

    // ================================
    // Session Management
    // ================================
    async function startSession(language) {
      AppState.language = language;
      updateUILanguage();
      showScreen('screen-main');
      debugLog(`Session started with language: ${language}`);
    }

    // ================================
    // Supabase Data Functions
    // ================================
    async function fetchArchetypeMapping(resources, system, values) {
      debugLog(`Fetching archetype for: ${resources}, ${system}, ${values}`);

      try {
        // Table uses axis_a (resources), axis_b (system), axis_c (values)
        const { data, error } = await supabaseClient
          .from('Archetype_mapping')
          .select('*')
          .ilike('axis_a', resources)
          .ilike('axis_b', system)
          .ilike('axis_c', values);

        if (error) throw error;

        debugLog(`Archetype mapping result: ${JSON.stringify(data)}`);
        return data?.[0] || null;
      } catch (error) {
        debugLog(`Error fetching archetype mapping: ${error.message}`);
        return null;
      }
    }

    async function fetchArchetypeDescription(archetypeId) {
      debugLog(`Fetching description for archetype: ${archetypeId}`);

      try {
        // Table uses 'id' column for archetype identifier
        const { data, error } = await supabaseClient
          .from('Archetype description')
          .select('*')
          .eq('id', archetypeId);

        if (error) throw error;

        debugLog(`Archetype description result: ${JSON.stringify(data)}`);
        return data?.[0] || null;
      } catch (error) {
        debugLog(`Error fetching archetype description: ${error.message}`);
        return null;
      }
    }

    async function fetchPrompt(promptId) {
      debugLog(`Fetching prompt: ${promptId}`);

      try {
        // Prompts table uses 'id' column (e.g., 'scenario_writing')
        const { data, error } = await supabaseClient
          .from('prompts')
          .select('*')
          .eq('id', promptId)
          .single();

        if (error) throw error;

        debugLog(`Prompt fetched: ${promptId}`);
        return data;
      } catch (error) {
        debugLog(`Error fetching prompt: ${error.message}`);
        return null;
      }
    }

    async function fetchSectorInfo() {
      debugLog('Fetching sector information');

      try {
        const { data, error } = await supabaseClient
          .from('Sector information: JenV')
          .select('*');

        if (error) throw error;

        debugLog(`Sector info fetched: ${data?.length} records`);
        return data;
      } catch (error) {
        debugLog(`Error fetching sector info: ${error.message}`);
        return null;
      }
    }

    // ================================
    // Gemini API Functions
    // ================================
    async function callGemini(prompt, image = null, type = 'text') {
      debugLog(`Calling Gemini API (type: ${type})`);

      try {
        const response = await fetch('/api/gemini', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ prompt, image, type })
        });

        const data = await response.json();

        if (data.error) {
          throw new Error(data.error);
        }

        debugLog('Gemini response received');
        return data.result;
      } catch (error) {
        debugLog(`Gemini API error: ${error.message}`);
        throw error;
      }
    }

    // ================================
    // Phase 1: Scenario Foundation
    // ================================
    async function determineArchetype() {
      const resources = document.getElementById('select-resources').value;
      const system = document.getElementById('select-system').value;
      const values = document.getElementById('select-values').value;

      if (!resources || !system || !values) {
        alert(t('select_all_options'));
        return;
      }

      debugLog(`Determining archetype for: ${resources}, ${system}, ${values}`);

      // Disable button and show loading
      const btnEl = document.getElementById('btn-determine');
      btnEl.disabled = true;
      btnEl.innerHTML = `<span class="loading-spinner"></span> ${t('determining_archetype')}`;

      // Show archetype result with loading state
      const resultEl = document.getElementById('archetype-result');
      resultEl.style.display = 'block';
      document.getElementById('archetype-name').textContent = '...';
      document.getElementById('archetype-nuance').textContent = '';
      document.getElementById('archetype-summary').textContent = t('connecting');

      try {
        // Get archetype mapping
        const mapping = await fetchArchetypeMapping(resources, system, values);

        if (!mapping) {
          throw new Error('No archetype mapping found');
        }

        // Mapping uses archetype_id and nuance_name/nuance_description
        const archetypeId = mapping.archetype_id;
        AppState.archetype = archetypeId;
        AppState.archetypeMapping = mapping;

        // Get archetype description from the description table
        const description = await fetchArchetypeDescription(archetypeId);
        AppState.archetypeDescription = description;

        // Display the archetype - simplified view
        const displayName = description?.name || archetypeId;
        const nuanceName = mapping.nuance_name;

        // Create a one-sentence summary from the nuance description
        const summary = getFirstSentence(mapping.nuance_description);

        document.getElementById('archetype-name').textContent = displayName;
        document.getElementById('archetype-nuance').textContent = nuanceName;
        document.getElementById('archetype-summary').textContent = summary;

        debugLog(`Archetype determined: ${archetypeId} (${nuanceName})`);

        // Generate scenario
        await generateScenario(archetypeId, description, mapping);

      } catch (error) {
        debugLog(`Error: ${error.message}`);
        document.getElementById('archetype-name').textContent = t('error_archetype');
        document.getElementById('archetype-summary').textContent = error.message;
      } finally {
        // Re-enable button
        btnEl.disabled = false;
        btnEl.textContent = t('determine_archetype');
      }
    }

    // Helper to extract first sentence
    function getFirstSentence(text) {
      if (!text) return '';
      // Split on period followed by space or end of string
      const match = text.match(/^[^.]+\./);
      return match ? match[0].trim() : text.substring(0, 150) + '...';
    }

    async function generateScenario(archetypeId, archetypeDescription, mapping) {
      debugLog('Generating scenario...');

      const scenarioEl = document.getElementById('scenario-result');
      const scenarioTextEl = document.getElementById('scenario-text');

      scenarioEl.style.display = 'block';
      scenarioTextEl.innerHTML = `<div style="text-align: center; padding: 2rem;"><span class="loading-spinner"></span><br><br>${t('generating_scenario')}</div>`;

      try {
        // Fetch required data from Supabase
        const [promptData, sectorData] = await Promise.all([
          fetchPrompt('scenario_writing'),
          fetchSectorInfo()
        ]);

        debugLog(`Prompt data: ${promptData ? 'loaded' : 'missing'}`);
        debugLog(`Sector data: ${sectorData?.length || 0} items`);

        // Build the prompt for Gemini
        const fullPrompt = buildScenarioPrompt(
          promptData,
          archetypeId,
          archetypeDescription,
          mapping,
          sectorData
        );

        debugLog('Sending prompt to Gemini...');
        debugLog(`Prompt length: ${fullPrompt.length} chars`);

        // Call Gemini API
        const scenario = await callGemini(fullPrompt, null, 'scenario');

        AppState.scenario = scenario;

        // Format the scenario for display with styled sections
        scenarioTextEl.innerHTML = formatScenarioWithSections(scenario);

        debugLog('Scenario generated successfully');

      } catch (error) {
        debugLog(`Scenario generation error: ${error.message}`);
        scenarioTextEl.innerHTML = `<div class="status-message error">Error: ${error.message}</div>`;
      }
    }

    // Filter out quantum-related entries from sector data (for Phase 1)
    function filterOutQuantum(sectorData) {
      if (!sectorData) return [];
      const quantumKeywords = ['quantum', 'q-day', 'pqc', 'qkd', 'qutech'];
      return sectorData.filter(item => {
        const text = `${item.title} ${item.content}`.toLowerCase();
        return !quantumKeywords.some(keyword => text.includes(keyword));
      });
    }

    function buildScenarioPrompt(promptData, archetypeId, archetypeDescription, mapping, sectorData) {
      // Get the card choices for context
      const resources = document.getElementById('select-resources').value;
      const system = document.getElementById('select-system').value;
      const values = document.getElementById('select-values').value;

      // Filter out quantum content for Phase 1 scenarios
      const filteredSectorData = filterOutQuantum(sectorData);
      debugLog(`Sector data: ${sectorData?.length || 0} total, ${filteredSectorData.length} after quantum filter`);

      // Use the prompt from Supabase (column: prompt_text)
      const basePrompt = promptData?.prompt_text || `
Generate a future scenario for the Dutch Ministry of Justice and Security (JenV).
The scenario should be vivid, concrete, and thought-provoking.
Write in ${AppState.language === 'nl' ? 'Dutch' : 'English'}.
      `;

      // Build the context to inject into the prompt
      const context = `
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
INPUT DATA
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

CARD CHOICES:
- Resources: ${resources} (${mapping?.axis_a_label || ''})
- System: ${system} (${mapping?.axis_b_label || ''})
- Values: ${values} (${mapping?.axis_c_label || ''})

ARCHETYPE: ${archetypeDescription?.name || archetypeId}
${archetypeDescription?.description || ''}

SPECIFIC NUANCE: ${mapping?.nuance_name || ''}
${mapping?.nuance_description || ''}

WRITING GUIDANCE:
${archetypeDescription?.writing_guidance || ''}

KEY VOCABULARY:
${archetypeDescription?.key_vocabulary || ''}

SECTOR KNOWLEDGE (Dutch Ministry of Justice and Security - JenV):
${filteredSectorData.map(s => `- ${s.title}: ${s.content}`).join('\n') || 'Focus on justice, security, and law enforcement.'}

OUTPUT LANGUAGE: ${AppState.language === 'nl' ? 'Dutch (Nederlands)' : 'English'}
`;

      return `${basePrompt}\n\n${context}`;
    }

    function formatScenarioOutput(text) {
      if (!text) return '';

      // Basic markdown parsing
      let formatted = text
        // Bold: **text** -> <strong>text</strong>
        .replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>')
        // Italic: *text* -> <em>text</em>
        .replace(/(?<!\*)\*([^*]+)\*(?!\*)/g, '<em>$1</em>')
        // Headers
        .replace(/^#### (.+)$/gm, '<div class="section-header">$1</div>')
        .replace(/^### (.+)$/gm, '<div class="section-header">$1</div>')
        .replace(/^## (.+)$/gm, '<h3 class="scenario-title">$1</h3>')
        // Line breaks
        .replace(/\n\n/g, '</p><p style="margin-top: 0.75rem;">')
        .replace(/\n/g, '<br>');

      // Convert bullet points
      formatted = formatted.replace(/(<br>)?- (.+?)(<br>|<\/p>|$)/g, '<li>$2</li>$3');
      formatted = formatted.replace(/(<li>.*?<\/li>)+/g, '<ul class="consequence-section">$&</ul>');

      return `<div class="formatted-content"><p>${formatted}</p></div>`;
    }

    function formatScenarioWithSections(text) {
      if (!text) return '';

      const lang = AppState.language;
      let html = '';

      // Try to identify sections in the scenario
      const lines = text.split('\n');
      let currentSection = 'intro';
      let narrativeContent = '';
      let opportunitiesContent = '';
      let risksContent = '';
      let otherContent = '';

      for (let line of lines) {
        const lowerLine = line.toLowerCase();

        // Detect section changes
        if (lowerLine.includes('een dag uit het leven') || lowerLine.includes('a day in the life') || lowerLine.includes('vignette') || lowerLine.includes('narrative')) {
          currentSection = 'narrative';
          continue;
        } else if (lowerLine.includes('kansen') || lowerLine.includes('opportunities') || lowerLine.includes('mogelijkheden')) {
          currentSection = 'opportunities';
          continue;
        } else if (lowerLine.includes('risico') || lowerLine.includes('risks') || lowerLine.includes('bedreigingen') || lowerLine.includes('threats')) {
          currentSection = 'risks';
          continue;
        }

        // Add content to appropriate section
        if (currentSection === 'narrative') {
          narrativeContent += line + '\n';
        } else if (currentSection === 'opportunities') {
          opportunitiesContent += line + '\n';
        } else if (currentSection === 'risks') {
          risksContent += line + '\n';
        } else {
          otherContent += line + '\n';
        }
      }

      // Build HTML
      if (otherContent.trim()) {
        html += `<div class="scenario-intro">${parseMarkdown(otherContent)}</div>`;
      }

      if (narrativeContent.trim()) {
        const label = lang === 'nl' ? 'EEN DAG UIT HET LEVEN' : 'A DAY IN THE LIFE';
        html += `<div class="narrative-vignette">
          <span class="narrative-label">${label}</span>
          <p>${parseMarkdown(narrativeContent)}</p>
        </div>`;
      }

      if (opportunitiesContent.trim()) {
        const label = lang === 'nl' ? 'KANSEN' : 'OPPORTUNITIES';
        html += `<div class="opportunities-section">
          <strong style="color: var(--blue);">${label}</strong>
          ${parseMarkdownList(opportunitiesContent)}
        </div>`;
      }

      if (risksContent.trim()) {
        const label = lang === 'nl' ? "RISICO'S" : 'RISKS';
        html += `<div class="risks-section">
          <strong style="color: var(--red);">${label}</strong>
          ${parseMarkdownList(risksContent)}
        </div>`;
      }

      return html || formatScenarioOutput(text);
    }

    function parseMarkdown(text) {
      if (!text) return '';
      return text
        .replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>')
        .replace(/(?<!\*)\*([^*]+)\*(?!\*)/g, '<em>$1</em>')
        .replace(/\n\n/g, '</p><p>')
        .replace(/\n/g, '<br>')
        .trim();
    }

    function parseMarkdownList(text) {
      if (!text) return '';
      const lines = text.split('\n').filter(l => l.trim());
      let html = '<ul class="consequence-section">';
      for (let line of lines) {
        let content = line.replace(/^[-‚Ä¢*]\s*/, '').trim();
        if (content) {
          content = content
            .replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>')
            .replace(/(?<!\*)\*([^*]+)\*(?!\*)/g, '<em>$1</em>');
          html += `<li>${content}</li>`;
        }
      }
      html += '</ul>';
      return html;
    }

    function formatWhatIfQuestions(questions) {
      if (!questions || !questions.length) return '';

      let html = '';
      questions.forEach((q, index) => {
        const questionText = q.question || q;
        const techCombo = q.technologies || '';
        const domain = q.domain || q.impact_domain || '';
        const tension = q.tension || q.value_tension || '';

        html += `<div class="whatif-card" onclick="selectWhatIf(${index})" data-index="${index}">
          <div class="whatif-question">${parseMarkdown(questionText)}</div>
          <div class="whatif-meta">
            ${techCombo ? `<span class="whatif-tag tech">${techCombo}</span>` : ''}
            ${domain ? `<span class="whatif-tag domain">${domain}</span>` : ''}
            ${tension ? `<span class="whatif-tag">${tension}</span>` : ''}
          </div>
        </div>`;
      });

      return html;
    }

    function formatConsequencesOutput(text) {
      if (!text) return formatScenarioOutput(text);

      const lang = AppState.language;
      let html = '';

      // Section markers to look for
      const sectionMarkers = {
        'what_happens': ['wat gebeurt er', 'what happens', 'direct effects', 'directe effecten'],
        'second_order': ['tweede-orde', 'second-order', '2nd order', 'tweede orde'],
        'third_order': ['derde-orde', 'third-order', '3rd order', 'derde orde'],
        'applications': ['nieuwe toepassingen', 'new applications', 'toepassingen', 'applications'],
        'elsa': ['elsa', 'ethical', 'ethisch', 'legal', 'juridisch', 'social', 'sociaal'],
        'winners_losers': ['wie wint', 'who wins', 'winners', 'losers', 'winnaars', 'verliezers']
      };

      const sectionLabels = {
        'what_happens': lang === 'nl' ? 'WAT GEBEURT ER?' : 'WHAT HAPPENS?',
        'second_order': lang === 'nl' ? 'TWEEDE-ORDE EFFECTEN' : 'SECOND-ORDER EFFECTS',
        'third_order': lang === 'nl' ? 'DERDE-ORDE EFFECTEN' : 'THIRD-ORDER EFFECTS',
        'applications': lang === 'nl' ? 'NIEUWE TOEPASSINGEN' : 'NEW APPLICATIONS',
        'elsa': lang === 'nl' ? 'ELSA IMPLICATIES' : 'ELSA IMPLICATIONS',
        'winners_losers': lang === 'nl' ? 'WIE WINT, WIE VERLIEST?' : 'WHO WINS, WHO LOSES?'
      };

      // Parse text into sections
      const lines = text.split('\n');
      let sections = {};
      let currentSection = 'intro';

      for (let line of lines) {
        const lowerLine = line.toLowerCase();

        // Check for section markers
        let foundSection = null;
        for (let [key, markers] of Object.entries(sectionMarkers)) {
          if (markers.some(m => lowerLine.includes(m))) {
            foundSection = key;
            break;
          }
        }

        if (foundSection) {
          currentSection = foundSection;
          if (!sections[currentSection]) sections[currentSection] = [];
          continue;
        }

        if (!sections[currentSection]) sections[currentSection] = [];
        if (line.trim()) sections[currentSection].push(line);
      }

      // Build HTML for each section
      for (let [key, content] of Object.entries(sections)) {
        if (!content.length) continue;

        if (key === 'intro') {
          html += `<div class="consequence-section">${parseMarkdownList(content.join('\n'))}</div>`;
        } else if (key === 'winners_losers') {
          html += `<div class="section-header">${sectionLabels[key]}</div>`;
          const contentText = content.join('\n');
          const winnersMatch = contentText.match(/winners?:?\s*([\s\S]*?)(?=losers?:|verliezers?:|$)/i);
          const losersMatch = contentText.match(/losers?:?\s*([\s\S]*?)$/i) || contentText.match(/verliezers?:?\s*([\s\S]*?)$/i);

          if (winnersMatch) {
            html += `<div class="winners-section">${parseMarkdownList(winnersMatch[1])}</div>`;
          }
          if (losersMatch) {
            html += `<div class="losers-section">${parseMarkdownList(losersMatch[1])}</div>`;
          }
          if (!winnersMatch && !losersMatch) {
            html += parseMarkdownList(contentText);
          }
        } else if (key === 'elsa') {
          html += `<div class="section-header">${sectionLabels[key]}</div>`;
          html += `<div class="consequence-section">${formatElsaSection(content.join('\n'))}</div>`;
        } else {
          html += `<div class="section-header">${sectionLabels[key]}</div>`;
          html += `<div class="consequence-section">${parseMarkdownList(content.join('\n'))}</div>`;
        }
      }

      return html || formatScenarioOutput(text);
    }

    function formatElsaSection(text) {
      let html = '<ul class="consequence-section">';
      const lines = text.split('\n').filter(l => l.trim());

      for (let line of lines) {
        let content = line.replace(/^[-‚Ä¢*]\s*/, '').trim();
        // Make ELSA labels bold
        content = content
          .replace(/^(Ethical|Ethisch|Ethische?):?\s*/i, '<span class="elsa-label">Ethical:</span> ')
          .replace(/^(Legal|Juridisch|Juridische?):?\s*/i, '<span class="elsa-label">Legal:</span> ')
          .replace(/^(Social|Sociaal|Sociale?|Societal|Maatschappelijk):?\s*/i, '<span class="elsa-label">Social:</span> ')
          .replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>')
          .replace(/(?<!\*)\*([^*]+)\*(?!\*)/g, '<em>$1</em>');

        if (content) {
          html += `<li>${content}</li>`;
        }
      }

      html += '</ul>';
      return html;
    }

    // ================================
    // Phase 2: What-If Generation
    // ================================

    // Show/hide custom input fields based on dropdown selection
    document.addEventListener('DOMContentLoaded', () => {
      const actorSelect = document.getElementById('select-actor');
      const eventSelect = document.getElementById('select-event');

      if (actorSelect) {
        actorSelect.addEventListener('change', (e) => {
          const customInput = document.getElementById('input-actor-custom');
          customInput.style.display = e.target.value === 'custom' ? 'block' : 'none';
        });
      }

      if (eventSelect) {
        eventSelect.addEventListener('change', (e) => {
          const customInput = document.getElementById('input-event-custom');
          customInput.style.display = e.target.value === 'custom' ? 'block' : 'none';
        });
      }
    });

    async function fetchTechnologyKnowledge() {
      debugLog('Fetching technology knowledge');
      try {
        const { data, error } = await supabaseClient
          .from('technology_knowledge')
          .select('*');
        if (error) throw error;
        debugLog(`Technology knowledge fetched: ${data?.length || 0} items`);
        return data || [];
      } catch (error) {
        debugLog(`Error fetching technology knowledge: ${error.message}`);
        return [];
      }
    }

    async function generateWhatIfQuestions() {
      // Get selections
      const techQuantum = document.getElementById('select-tech-quantum').value;
      const tech2 = document.getElementById('select-tech-2').value;
      const tech3 = document.getElementById('select-tech-3').value;

      let actor = document.getElementById('select-actor').value;
      if (actor === 'custom') {
        actor = document.getElementById('input-actor-custom').value;
      }

      let event = document.getElementById('select-event').value;
      if (event === 'custom') {
        event = document.getElementById('input-event-custom').value;
      }

      // Validate
      if (!tech2 || !tech3 || !actor || !event) {
        alert(t('select_tech_actor_event'));
        return;
      }

      // Store in AppState
      AppState.selectedTechnologies = [techQuantum, tech2, tech3];
      AppState.selectedActor = actor;
      AppState.selectedEvent = event;

      debugLog(`Generating what-if questions for: ${techQuantum}, ${tech2}, ${tech3}, ${actor}, ${event}`);

      // Show loading
      const btnEl = document.getElementById('btn-generate-whatif');
      btnEl.disabled = true;
      btnEl.innerHTML = `<span class="loading-spinner"></span> ${t('generating_whatif')}`;

      const resultEl = document.getElementById('whatif-result');
      resultEl.style.display = 'block';
      document.getElementById('whatif-questions-list').innerHTML = `<div style="text-align: center; padding: 1rem;"><span class="loading-spinner"></span></div>`;

      try {
        // Fetch data from Supabase
        const [promptData, sectorData, techData] = await Promise.all([
          fetchPrompt('whatif_generation'),
          fetchSectorInfo(),
          fetchTechnologyKnowledge()
        ]);

        // Build prompt
        const fullPrompt = buildWhatIfPrompt(promptData, sectorData, techData);

        debugLog('Sending what-if prompt to Gemini...');

        // Call Gemini
        const response = await callGemini(fullPrompt, null, 'whatif');

        // Parse the response into questions
        const questions = parseWhatIfResponse(response);
        AppState.whatIfQuestions = questions;

        // Display questions with radio buttons
        displayWhatIfQuestions(questions);

        debugLog(`Generated ${questions.length} what-if questions`);

      } catch (error) {
        debugLog(`What-if generation error: ${error.message}`);
        document.getElementById('whatif-questions-list').innerHTML = `<div class="status-message error">Error: ${error.message}</div>`;
      } finally {
        btnEl.disabled = false;
        btnEl.textContent = t('generate_whatif');
      }
    }

    function buildWhatIfPrompt(promptData, sectorData, techData) {
      const [techQuantum, tech2, tech3] = AppState.selectedTechnologies;
      const actor = AppState.selectedActor;
      const event = AppState.selectedEvent;

      // Format technology names for display
      const formatTech = (t) => t.replace(/_/g, ' ').replace(/\b\w/g, c => c.toUpperCase());

      const basePrompt = promptData?.prompt_text || `
Generate 3 what-if questions based on the selected technologies, actor, and trigger event.
Each question should be provocative and challenge assumptions about the future.
Write in ${AppState.language === 'nl' ? 'Dutch' : 'English'}.
      `;

      // Replace placeholders in the prompt
      let prompt = basePrompt
        .replace(/\[TECH_1\]/g, formatTech(tech2))
        .replace(/\[TECH_2\]/g, formatTech(tech3))
        .replace(/\[ACTOR\]/g, formatTech(actor))
        .replace(/\[TRIGGER\]/g, formatTech(event));

      const context = `
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
INPUT DATA
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

SELECTED TECHNOLOGIES:
1. Quantum: ${formatTech(techQuantum)}
2. Technology 2: ${formatTech(tech2)}
3. Technology 3: ${formatTech(tech3)}

ACTOR: ${formatTech(actor)}

TRIGGER EVENT: ${formatTech(event)}

ARCHETYPE CONTEXT: ${AppState.archetypeDescription?.name || AppState.archetype}
${AppState.archetypeMapping?.nuance_description || ''}

TECHNOLOGY KNOWLEDGE:
${techData?.map(t => `- ${t.name || t.technology}: ${t.description || t.content || ''}`).join('\n') || 'Use general knowledge about the selected technologies.'}

SECTOR KNOWLEDGE (JenV):
${sectorData?.slice(0, 15).map(s => `- ${s.title}: ${s.content}`).join('\n') || 'Dutch Ministry of Justice and Security'}

OUTPUT LANGUAGE: ${AppState.language === 'nl' ? 'Dutch (Nederlands)' : 'English'}
`;

      return `${prompt}\n\n${context}`;
    }

    function parseWhatIfResponse(response) {
      // Try to extract questions from the response
      const questions = [];
      const lines = response.split('\n');

      let currentQuestion = null;
      let currentMeta = {};

      for (const line of lines) {
        const trimmed = line.trim();

        // Look for "Question X" or "What if" patterns
        if (trimmed.match(/^(Question\s*\d|What if)/i) || trimmed.startsWith('What if')) {
          if (currentQuestion) {
            questions.push({ text: currentQuestion, ...currentMeta });
          }
          currentQuestion = trimmed.replace(/^Question\s*\d[:\s]*/i, '');
          currentMeta = {};
        } else if (trimmed.startsWith('- Impact Domain:')) {
          currentMeta.impactDomain = trimmed.replace('- Impact Domain:', '').trim();
        } else if (trimmed.startsWith('- Value Tension:')) {
          currentMeta.valueTension = trimmed.replace('- Value Tension:', '').trim();
        } else if (currentQuestion && trimmed && !trimmed.startsWith('-') && !trimmed.startsWith('Impact') && !trimmed.startsWith('Value')) {
          // Continue the question if it spans multiple lines
          if (!currentQuestion.endsWith('?')) {
            currentQuestion += ' ' + trimmed;
          }
        }
      }

      // Add the last question
      if (currentQuestion) {
        questions.push({ text: currentQuestion, ...currentMeta });
      }

      // If parsing failed, just split by double newlines
      if (questions.length === 0) {
        const parts = response.split(/\n\n+/);
        parts.forEach((part, i) => {
          const cleaned = part.trim();
          if (cleaned.toLowerCase().includes('what if') || cleaned.includes('?')) {
            questions.push({ text: cleaned });
          }
        });
      }

      return questions.slice(0, 3); // Return max 3 questions
    }

    function displayWhatIfQuestions(questions) {
      const container = document.getElementById('whatif-questions-list');

      if (questions.length === 0) {
        container.innerHTML = '<p class="body-text">No questions generated. Try again or enter a custom question.</p>';
        return;
      }

      let html = '';
      questions.forEach((q, i) => {
        html += `
          <div class="card" style="background: var(--white); margin-bottom: 0.75rem; cursor: pointer;" onclick="selectWhatIf(${i})">
            <label style="display: flex; align-items: flex-start; gap: 0.75rem; cursor: pointer;">
              <input type="radio" name="whatif-selection" value="${i}" style="margin-top: 0.25rem;">
              <div>
                <p class="body-text" style="margin: 0;">${q.text}</p>
                ${q.impactDomain ? `<p class="small-label" style="margin-top: 0.5rem; opacity: 0.7;">Impact: ${q.impactDomain}</p>` : ''}
                ${q.valueTension ? `<p class="small-label" style="opacity: 0.7;">Tension: ${q.valueTension}</p>` : ''}
              </div>
            </label>
          </div>
        `;
      });

      container.innerHTML = html;
    }

    function selectWhatIf(index) {
      // Clear custom input when selecting a generated question
      document.getElementById('input-custom-whatif').value = '';

      // Select the radio button
      const radios = document.querySelectorAll('input[name="whatif-selection"]');
      if (radios[index]) {
        radios[index].checked = true;
      }
    }

    function proceedToPhase3() {
      // Get selected question
      const selectedRadio = document.querySelector('input[name="whatif-selection"]:checked');
      const customInput = document.getElementById('input-custom-whatif').value.trim();

      let selectedQuestion = null;

      if (customInput) {
        selectedQuestion = customInput;
      } else if (selectedRadio) {
        const index = parseInt(selectedRadio.value);
        selectedQuestion = AppState.whatIfQuestions[index]?.text;
      }

      if (!selectedQuestion) {
        alert(t('select_whatif_error'));
        return;
      }

      AppState.selectedWhatIf = selectedQuestion;
      debugLog(`Selected what-if: ${selectedQuestion}`);

      // Navigate to Phase 3 and generate consequences
      goToPhase(3);
      generateConsequences();
    }

    // ================================
    // Phase 3: Consequences
    // ================================

    async function generateConsequences() {
      debugLog('Generating consequences...');

      // Display selected what-if
      document.getElementById('selected-whatif-display').textContent = AppState.selectedWhatIf;

      const resultEl = document.getElementById('consequences-text');
      resultEl.innerHTML = `<div style="text-align: center; padding: 2rem;"><span class="loading-spinner"></span><br><br>${t('generating_consequences')}</div>`;

      try {
        // Fetch data from Supabase
        const [promptData, sectorData, techData] = await Promise.all([
          fetchPrompt('consequence_generation'),
          fetchSectorInfo(),
          fetchTechnologyKnowledge()
        ]);

        // Build prompt
        const fullPrompt = buildConsequencePrompt(promptData, sectorData, techData);

        debugLog('Sending consequence prompt to Gemini...');
        debugLog(`Prompt length: ${fullPrompt.length} chars`);

        // Call Gemini
        const response = await callGemini(fullPrompt, null, 'consequences');

        AppState.consequences = response;

        // Format and display with styled sections
        resultEl.innerHTML = formatConsequencesOutput(response);

        debugLog('Consequences generated successfully');

      } catch (error) {
        debugLog(`Consequence generation error: ${error.message}`);
        resultEl.innerHTML = `<div class="status-message error">Error: ${error.message}</div>`;
      }
    }

    function buildConsequencePrompt(promptData, sectorData, techData) {
      const [techQuantum, tech2, tech3] = AppState.selectedTechnologies;
      const formatTech = (t) => t.replace(/_/g, ' ').replace(/\b\w/g, c => c.toUpperCase());

      const basePrompt = promptData?.prompt_text || `
Generate consequences for the selected what-if question, including 2nd and 3rd order effects,
new technology applications, ELSA implications, and who wins/loses.
Write in ${AppState.language === 'nl' ? 'Dutch' : 'English'}.
      `;

      const context = `
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
INPUT DATA
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

SELECTED WHAT-IF QUESTION:
${AppState.selectedWhatIf}

PHASE 1 SCENARIO:
${AppState.scenario || 'No scenario available'}

ARCHETYPE: ${AppState.archetypeDescription?.name || AppState.archetype}
${AppState.archetypeDescription?.description || ''}

NUANCE: ${AppState.archetypeMapping?.nuance_name || ''}
${AppState.archetypeMapping?.nuance_description || ''}

SELECTED TECHNOLOGIES:
1. ${formatTech(techQuantum)}
2. ${formatTech(tech2)}
3. ${formatTech(tech3)}

ACTOR: ${formatTech(AppState.selectedActor)}
TRIGGER: ${formatTech(AppState.selectedEvent)}

TECHNOLOGY KNOWLEDGE:
${techData?.map(t => `- ${t.name || t.technology}: ${t.description || t.content || ''}`).join('\n') || 'Use general knowledge about the selected technologies.'}

SECTOR KNOWLEDGE (JenV):
${sectorData?.map(s => `- ${s.title}: ${s.content}`).join('\n') || 'Dutch Ministry of Justice and Security'}

OUTPUT LANGUAGE: ${AppState.language === 'nl' ? 'Dutch (Nederlands)' : 'English'}
`;

      return `${basePrompt}\n\n${context}`;
    }

    // ================================
    // Phase 4: Strategic Focus
    // ================================

    function initPhase4() {
      debugLog('Initializing Phase 4...');

      // Parse consequences into selectable items with source sections
      const consequences = AppState.consequences || '';
      const items = parseConsequencesForSelection(consequences);

      const container = document.getElementById('consequence-items');

      if (items.length === 0) {
        container.innerHTML = `<p class="body-text">${t('no_consequences')}</p>`;
        return;
      }

      let html = '';
      items.forEach((item, i) => {
        const sourceLabel = item.source || '';
        html += `
          <div class="priority-item" onclick="togglePriority(${i})">
            <label style="display: flex; align-items: flex-start; gap: 0.75rem; cursor: pointer;">
              <input type="checkbox" id="priority-${i}" value="${i}" onchange="updateStrategicSummary()" style="margin-top: 0.25rem; flex-shrink: 0;">
              <div style="flex: 1;">
                ${sourceLabel ? `<div class="priority-source">${sourceLabel}</div>` : ''}
                <div class="priority-text">${item.text || item}</div>
              </div>
            </label>
          </div>
        `;
      });

      container.innerHTML = html;

      // Store parsed items for later reference
      AppState.parsedConsequences = items;

      debugLog(`Phase 4 initialized with ${items.length} consequence items`);
    }

    function parseConsequencesForSelection(text) {
      if (!text) return [];

      const items = [];
      const lang = AppState.language;

      // Section labels for source tagging
      const sectionLabels = {
        'what_happens': lang === 'nl' ? 'Directe Effecten' : 'Direct Effects',
        'second_order': lang === 'nl' ? 'Tweede-orde' : '2nd Order',
        'third_order': lang === 'nl' ? 'Derde-orde' : '3rd Order',
        'applications': lang === 'nl' ? 'Toepassingen' : 'Applications',
        'elsa': 'ELSA',
        'winners': lang === 'nl' ? 'Winnaars' : 'Winners',
        'losers': lang === 'nl' ? 'Verliezers' : 'Losers'
      };

      // Section markers
      const sectionMarkers = {
        'what_happens': ['wat gebeurt er', 'what happens', 'direct effects'],
        'second_order': ['tweede-orde', 'second-order', '2nd order'],
        'third_order': ['derde-orde', 'third-order', '3rd order'],
        'applications': ['nieuwe toepassingen', 'new applications'],
        'elsa': ['elsa', 'ethical', 'ethisch'],
        'winners': ['winners', 'winnaars', 'wie wint'],
        'losers': ['losers', 'verliezers', 'wie verliest']
      };

      // Parse with section tracking
      const lines = text.split('\n');
      let currentSection = 'intro';
      let currentItem = '';

      for (const line of lines) {
        const trimmed = line.trim();
        const lowerLine = trimmed.toLowerCase();

        // Check for section markers
        let foundSection = null;
        for (let [key, markers] of Object.entries(sectionMarkers)) {
          if (markers.some(m => lowerLine.includes(m))) {
            foundSection = key;
            break;
          }
        }

        if (foundSection) {
          if (currentItem) {
            items.push({ text: currentItem.trim(), source: sectionLabels[currentSection] || '' });
          }
          currentSection = foundSection;
          currentItem = '';
          continue;
        }

        // Check for bullet points or numbered items
        if (trimmed.match(/^[-‚Ä¢*]\s+/) || trimmed.match(/^\d+[.)]\s+/)) {
          if (currentItem) {
            items.push({ text: currentItem.trim(), source: sectionLabels[currentSection] || '' });
          }
          currentItem = trimmed.replace(/^[-‚Ä¢*]\s+/, '').replace(/^\d+[.)]\s+/, '');
        } else if (trimmed.match(/^#{1,4}\s+/) || trimmed.match(/^\*\*[^*]+\*\*/)) {
          // Headers - skip as grouping titles
          if (currentItem) {
            items.push({ text: currentItem.trim(), source: sectionLabels[currentSection] || '' });
          }
          currentItem = '';
        } else if (trimmed && currentItem) {
          // Continuation of previous item
          currentItem += ' ' + trimmed;
        }
      }

      if (currentItem) {
        items.push({ text: currentItem.trim(), source: sectionLabels[currentSection] || '' });
      }

      // Clean up markdown from text
      return items
        .filter(item => (item.text || '').length > 15)
        .map(item => ({
          text: (item.text || '')
            .replace(/\*\*([^*]+)\*\*/g, '$1')
            .replace(/\*([^*]+)\*/g, '$1'),
          source: item.source
        }))
        .slice(0, 15);
    }

    function togglePriority(index) {
      const checkbox = document.getElementById(`priority-${index}`);
      if (checkbox) {
        checkbox.checked = !checkbox.checked;
        updateStrategicSummary();
      }
    }

    function updateStrategicSummary() {
      const selected = [];
      const checkboxes = document.querySelectorAll('#consequence-items input[type="checkbox"]:checked');

      checkboxes.forEach(cb => {
        const index = parseInt(cb.value);
        if (AppState.parsedConsequences && AppState.parsedConsequences[index]) {
          selected.push(AppState.parsedConsequences[index]);
        }
      });

      AppState.strategicPriorities = selected;

      const summaryEl = document.getElementById('strategic-summary');
      const summaryList = document.getElementById('strategic-summary-list');

      if (selected.length > 0) {
        summaryEl.style.display = 'block';
        summaryList.innerHTML = selected.map(s =>
          `<p class="body-text" style="margin-bottom: 0.5rem; padding-left: 1rem; border-left: 3px solid var(--magenta);">${s}</p>`
        ).join('');
      } else {
        summaryEl.style.display = 'none';
      }

      debugLog(`Strategic priorities updated: ${selected.length} items selected`);
    }

    // ================================
    // Phase 5: Export & Save
    // ================================

    function initPhase5() {
      debugLog('Initializing Phase 5...');

      // Save strategic notes
      AppState.strategicNotes = document.getElementById('input-strategic-notes')?.value || '';

      // Populate summary
      const formatTech = (t) => t?.replace(/_/g, ' ').replace(/\b\w/g, c => c.toUpperCase()) || '';

      document.getElementById('summary-archetype').textContent =
        AppState.archetypeDescription?.name || AppState.archetype || '-';

      document.getElementById('summary-nuance').textContent =
        AppState.archetypeMapping?.nuance_name || '';

      document.getElementById('summary-scenario').textContent =
        (AppState.scenario || '-').substring(0, 500) + (AppState.scenario?.length > 500 ? '...' : '');

      document.getElementById('summary-whatif').textContent =
        AppState.selectedWhatIf || '-';

      document.getElementById('summary-techs').textContent =
        AppState.selectedTechnologies.map(formatTech).join(', ') || '-';

      document.getElementById('summary-actor').textContent =
        formatTech(AppState.selectedActor) || '-';

      document.getElementById('summary-trigger').textContent =
        formatTech(AppState.selectedEvent) || '-';

      // Strategic priorities
      const prioritiesEl = document.getElementById('summary-priorities');
      if (AppState.strategicPriorities.length > 0) {
        prioritiesEl.innerHTML = AppState.strategicPriorities.map(p =>
          `<p class="body-text" style="margin-bottom: 0.25rem;">‚Ä¢ ${p}</p>`
        ).join('');
      } else {
        prioritiesEl.innerHTML = `<p class="body-text" style="opacity: 0.7;">${t('no_priorities')}</p>`;
      }

      // Notes
      const notesEl = document.getElementById('summary-notes');
      if (AppState.strategicNotes) {
        notesEl.innerHTML = `<p class="body-text">"${AppState.strategicNotes}"</p>`;
      } else {
        notesEl.innerHTML = '';
      }

      debugLog('Phase 5 summary populated');
    }

    function buildExportText() {
      const formatTech = (t) => t?.replace(/_/g, ' ').replace(/\b\w/g, c => c.toUpperCase()) || '';
      const lang = AppState.language;

      let text = `
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
TECH FUTURES EXPLORER - ${lang === 'nl' ? 'SESSIE RAPPORT' : 'SESSION REPORT'}
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

${lang === 'nl' ? 'ARCHETYPE' : 'ARCHETYPE'}: ${AppState.archetypeDescription?.name || AppState.archetype}
${lang === 'nl' ? 'Nuance' : 'Nuance'}: ${AppState.archetypeMapping?.nuance_name || '-'}

‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
${lang === 'nl' ? 'SCENARIO' : 'SCENARIO'}
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
${AppState.scenario || '-'}

‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
${lang === 'nl' ? 'TECHNOLOGIE√ãN & CONTEXT' : 'TECHNOLOGIES & CONTEXT'}
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
${lang === 'nl' ? 'Technologie√´n' : 'Technologies'}: ${AppState.selectedTechnologies.map(formatTech).join(', ')}
Actor: ${formatTech(AppState.selectedActor)}
Trigger: ${formatTech(AppState.selectedEvent)}

‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
WHAT-IF
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
${AppState.selectedWhatIf || '-'}

‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
${lang === 'nl' ? 'CONSEQUENTIES' : 'CONSEQUENCES'}
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
${AppState.consequences || '-'}

‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
${lang === 'nl' ? 'STRATEGISCHE PRIORITEITEN' : 'STRATEGIC PRIORITIES'}
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
${AppState.strategicPriorities.length > 0 ?
        AppState.strategicPriorities.map((p, i) => `${i + 1}. ${p}`).join('\n') :
        (lang === 'nl' ? 'Geen prioriteiten geselecteerd' : 'No priorities selected')}

${AppState.strategicNotes ? `
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
${lang === 'nl' ? 'NOTITIES' : 'NOTES'}
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
${AppState.strategicNotes}
` : ''}

‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
${lang === 'nl' ? 'Gegenereerd op' : 'Generated on'}: ${new Date().toLocaleString(lang === 'nl' ? 'nl-NL' : 'en-US')}
Tech Futures Explorer - Quantum Delta NL
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
`;

      return text.trim();
    }

    async function copyToClipboard() {
      const text = buildExportText();

      try {
        await navigator.clipboard.writeText(text);
        alert(t('copied_success'));
        debugLog('Text copied to clipboard');
      } catch (error) {
        debugLog(`Clipboard error: ${error.message}`);
        // Fallback for older browsers
        const textarea = document.createElement('textarea');
        textarea.value = text;
        document.body.appendChild(textarea);
        textarea.select();
        document.execCommand('copy');
        document.body.removeChild(textarea);
        alert(t('copied_success'));
      }
    }

    function exportToPDF() {
      debugLog('Generating PDF...');

      // Create a printable version
      const text = buildExportText();

      // Open print dialog with formatted content
      const printWindow = window.open('', '_blank');
      printWindow.document.write(`
        <!DOCTYPE html>
        <html>
        <head>
          <title>Tech Futures Explorer - Export</title>
          <style>
            body {
              font-family: 'Courier New', monospace;
              padding: 2rem;
              max-width: 800px;
              margin: 0 auto;
              font-size: 12px;
              line-height: 1.6;
            }
            pre {
              white-space: pre-wrap;
              word-wrap: break-word;
            }
            @media print {
              body { padding: 1rem; }
            }
          </style>
        </head>
        <body>
          <pre>${text.replace(/</g, '&lt;').replace(/>/g, '&gt;')}</pre>
          <scr` + `ipt>
            window.onload = function() {
              window.print();
            }
          </scr` + `ipt>
        </body>
        </html>
      `);
      printWindow.document.close();
    }

    async function saveSession() {
      const sessionName = document.getElementById('input-session-name').value.trim();
      const statusEl = document.getElementById('save-status');
      const btnEl = document.getElementById('btn-save-session');

      if (!sessionName) {
        statusEl.innerHTML = `<p class="status-message error">${AppState.language === 'nl' ? 'Voer een sessie naam in' : 'Enter a session name'}</p>`;
        return;
      }

      btnEl.disabled = true;
      btnEl.innerHTML = `<span class="loading-spinner"></span>`;
      statusEl.innerHTML = '';

      try {
        const sessionData = {
          name: sessionName,
          language: AppState.language,
          archetype_id: AppState.archetype,
          archetype_name: AppState.archetypeDescription?.name,
          nuance_name: AppState.archetypeMapping?.nuance_name,
          scenario: AppState.scenario,
          technologies: AppState.selectedTechnologies,
          actor: AppState.selectedActor,
          trigger_event: AppState.selectedEvent,
          whatif_question: AppState.selectedWhatIf,
          consequences: AppState.consequences,
          strategic_priorities: AppState.strategicPriorities,
          strategic_notes: AppState.strategicNotes,
          created_at: new Date().toISOString()
        };

        const { data, error } = await supabaseClient
          .from('sessions')
          .insert([sessionData])
          .select();

        if (error) throw error;

        AppState.savedSessionId = data?.[0]?.id;

        statusEl.innerHTML = `<p class="status-message success">‚úì ${t('save_success')} (ID: ${AppState.savedSessionId || 'saved'})</p>`;
        debugLog(`Session saved with ID: ${AppState.savedSessionId}`);

      } catch (error) {
        debugLog(`Save error: ${error.message}`);
        statusEl.innerHTML = `<p class="status-message error">${t('save_error')}: ${error.message}</p>`;
      } finally {
        btnEl.disabled = false;
        btnEl.textContent = t('save_to_database');
      }
    }

    function startNewSession() {
      // Reset AppState
      AppState.currentPhase = 1;
      AppState.archetype = null;
      AppState.archetypeMapping = null;
      AppState.archetypeDescription = null;
      AppState.scenario = null;
      AppState.selectedTechnologies = [];
      AppState.selectedActor = null;
      AppState.selectedEvent = null;
      AppState.whatIfQuestions = [];
      AppState.selectedWhatIf = null;
      AppState.consequences = null;
      AppState.strategicPriorities = [];
      AppState.strategicNotes = '';
      AppState.savedSessionId = null;

      // Reset form elements
      document.getElementById('select-resources').value = '';
      document.getElementById('select-system').value = '';
      document.getElementById('select-values').value = '';
      document.getElementById('select-tech-2').value = '';
      document.getElementById('select-tech-3').value = '';
      document.getElementById('select-actor').value = '';
      document.getElementById('select-event').value = '';
      document.getElementById('input-custom-whatif').value = '';
      document.getElementById('input-strategic-notes').value = '';
      document.getElementById('input-session-name').value = '';

      // Hide result sections
      document.getElementById('archetype-result').style.display = 'none';
      document.getElementById('scenario-result').style.display = 'none';
      document.getElementById('whatif-result').style.display = 'none';
      document.getElementById('strategic-summary').style.display = 'none';
      document.getElementById('save-status').innerHTML = '';

      // Go to start screen
      showScreen('screen-start');

      debugLog('New session started - state reset');
    }

    // ================================
    // Camera Functions
    // ================================

    let cameraStream = null;
    let currentCameraPhase = null;
    let capturedImageData = null;

    async function openCamera(phase) {
      currentCameraPhase = phase;
      capturedImageData = null;

      const modal = document.getElementById('camera-modal');
      const video = document.getElementById('camera-video');
      const errorEl = document.getElementById('camera-error');
      const liveView = document.getElementById('camera-live');
      const previewView = document.getElementById('camera-preview');
      const processingView = document.getElementById('camera-processing');

      // Reset UI state
      liveView.style.display = 'flex';
      previewView.style.display = 'none';
      processingView.style.display = 'none';
      errorEl.style.display = 'none';
      document.getElementById('btn-capture').style.display = 'inline-block';
      document.getElementById('btn-retake').style.display = 'none';
      document.getElementById('btn-use-photo').style.display = 'none';

      // Update title and hint based on phase
      if (phase === 'phase1') {
        document.getElementById('camera-title').textContent = 'üì∑ ' + (AppState.language === 'nl' ? 'Scan 3 Kaarten' : 'Scan 3 Cards');
        document.getElementById('camera-hint').textContent = AppState.language === 'nl'
          ? 'Plaats Resources, System en Values kaarten in beeld'
          : 'Position Resources, System and Values cards in frame';
      } else {
        document.getElementById('camera-title').textContent = 'üì∑ ' + (AppState.language === 'nl' ? 'Scan 5 Kaarten' : 'Scan 5 Cards');
        document.getElementById('camera-hint').textContent = AppState.language === 'nl'
          ? 'Plaats 3 Tech + 1 Actor + 1 Event kaarten in beeld'
          : 'Position 3 Tech + 1 Actor + 1 Event cards in frame';
      }

      modal.style.display = 'flex';

      try {
        // Request camera access
        cameraStream = await navigator.mediaDevices.getUserMedia({
          video: {
            facingMode: 'environment', // Prefer back camera on mobile
            width: { ideal: 1920 },
            height: { ideal: 1080 }
          }
        });

        video.srcObject = cameraStream;
        await video.play();
        debugLog('Camera opened successfully');

      } catch (error) {
        debugLog(`Camera error: ${error.message}`);
        errorEl.textContent = t('camera_error') + ': ' + error.message;
        errorEl.style.display = 'block';
        liveView.style.display = 'none';
      }
    }

    function closeCamera() {
      const modal = document.getElementById('camera-modal');
      const video = document.getElementById('camera-video');

      // Stop camera stream
      if (cameraStream) {
        cameraStream.getTracks().forEach(track => track.stop());
        cameraStream = null;
      }

      video.srcObject = null;
      modal.style.display = 'none';
      currentCameraPhase = null;
      capturedImageData = null;

      debugLog('Camera closed');
    }

    function capturePhoto() {
      const video = document.getElementById('camera-video');
      const canvas = document.getElementById('camera-canvas');
      const image = document.getElementById('camera-image');
      const liveView = document.getElementById('camera-live');
      const previewView = document.getElementById('camera-preview');

      // Set canvas size to video size
      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;

      // Draw video frame to canvas
      const ctx = canvas.getContext('2d');
      ctx.drawImage(video, 0, 0);

      // Get image data as base64
      capturedImageData = canvas.toDataURL('image/jpeg', 0.9);

      // Show preview
      image.src = capturedImageData;
      liveView.style.display = 'none';
      previewView.style.display = 'flex';

      // Update buttons
      document.getElementById('btn-capture').style.display = 'none';
      document.getElementById('btn-retake').style.display = 'inline-block';
      document.getElementById('btn-use-photo').style.display = 'inline-block';

      debugLog('Photo captured');
    }

    function retakePhoto() {
      const liveView = document.getElementById('camera-live');
      const previewView = document.getElementById('camera-preview');

      capturedImageData = null;

      // Show live view again
      liveView.style.display = 'flex';
      previewView.style.display = 'none';

      // Update buttons
      document.getElementById('btn-capture').style.display = 'inline-block';
      document.getElementById('btn-retake').style.display = 'none';
      document.getElementById('btn-use-photo').style.display = 'none';

      debugLog('Retaking photo');
    }

    async function usePhoto() {
      if (!capturedImageData) return;

      const previewView = document.getElementById('camera-preview');
      const processingView = document.getElementById('camera-processing');
      const errorEl = document.getElementById('camera-error');

      // Show processing state
      previewView.style.display = 'none';
      processingView.style.display = 'flex';
      document.getElementById('camera-processing-text').textContent = t('analyzing_cards');
      document.getElementById('btn-retake').style.display = 'none';
      document.getElementById('btn-use-photo').style.display = 'none';
      errorEl.style.display = 'none';

      try {
        // Extract base64 data (remove data:image/jpeg;base64, prefix)
        const base64Image = capturedImageData.split(',')[1];

        // Build prompt based on phase
        let prompt;
        if (currentCameraPhase === 'phase1') {
          prompt = `Analyze this image of cards from a futures workshop.
Identify the 3 binary choice cards shown:
1. RESOURCES axis: Look for a card showing either "Abundance" or "Limits"
2. SYSTEM axis: Look for a card showing either "Stable" or "Breakdown"
3. VALUES axis: Look for a card showing either "Collective" or "Individual"

Respond in JSON format only:
{
  "resources": "abundance" or "limits",
  "system": "stable" or "breakdown",
  "values": "collective" or "individual",
  "confidence": "high", "medium", or "low"
}

If you cannot identify a card clearly, use null for that value.`;
        } else {
          prompt = `Analyze this image of cards from a futures workshop.
Identify 5 cards shown:
1. QUANTUM TECHNOLOGY: One of "quantum_sensing", "quantum_computing", or "quantum_communication"
2. TECHNOLOGY 2: One of "climate_tech", "biotech", "neurotech", "space_tech", "agi", "asi", "robotics"
3. TECHNOLOGY 3: One of "climate_tech", "biotech", "neurotech", "space_tech", "agi", "asi", "robotics"
4. ACTOR: One of "criminal_networks", "foreign_states", "big_tech", "research_institutions", "ngos", "citizens", "journalists", "startups", "insurance_companies"
5. TRIGGER EVENT: One of "major_breakthrough", "security_breach", "regulatory_shift", "talent_exodus", "international_treaty", "maturity_tipping_point", "loss_of_control", "public_scandal", "market_collapse"

Respond in JSON format only:
{
  "quantum_tech": "quantum_sensing" or "quantum_computing" or "quantum_communication",
  "tech_2": one of the technology values,
  "tech_3": one of the technology values,
  "actor": one of the actor values,
  "event": one of the event values,
  "confidence": "high", "medium", or "low"
}

If you cannot identify a card clearly, use null for that value.`;
        }

        debugLog('Sending image to Gemini for analysis...');

        // Call Gemini with image
        const response = await callGemini(prompt, base64Image, 'vision');

        debugLog('Gemini response: ' + response);

        // Parse the response
        const result = parseCardScanResponse(response);

        if (result) {
          // Apply results to dropdowns
          applyCardScanResults(result);

          // Close camera and show success
          closeCamera();
          debugLog('Cards detected and applied successfully');
        } else {
          throw new Error(t('card_scan_failed'));
        }

      } catch (error) {
        debugLog(`Card scan error: ${error.message}`);
        processingView.style.display = 'none';
        previewView.style.display = 'flex';
        errorEl.textContent = error.message;
        errorEl.style.display = 'block';
        document.getElementById('btn-retake').style.display = 'inline-block';
        document.getElementById('btn-use-photo').style.display = 'inline-block';
      }
    }

    function parseCardScanResponse(response) {
      try {
        // Try to extract JSON from the response
        let jsonStr = response;

        // If response contains markdown code block, extract it
        const jsonMatch = response.match(/```(?:json)?\s*([\s\S]*?)\s*```/);
        if (jsonMatch) {
          jsonStr = jsonMatch[1];
        }

        // Try to find JSON object in the response
        const objectMatch = jsonStr.match(/\{[\s\S]*\}/);
        if (objectMatch) {
          jsonStr = objectMatch[0];
        }

        const parsed = JSON.parse(jsonStr);
        debugLog('Parsed card scan result: ' + JSON.stringify(parsed));
        return parsed;
      } catch (error) {
        debugLog('Failed to parse card scan response: ' + error.message);
        return null;
      }
    }

    function applyCardScanResults(result) {
      if (currentCameraPhase === 'phase1') {
        // Apply Phase 1 results
        if (result.resources) {
          document.getElementById('select-resources').value = result.resources.toLowerCase();
        }
        if (result.system) {
          document.getElementById('select-system').value = result.system.toLowerCase();
        }
        if (result.values) {
          document.getElementById('select-values').value = result.values.toLowerCase();
        }
        debugLog(`Phase 1 cards applied: resources=${result.resources}, system=${result.system}, values=${result.values}`);
      } else {
        // Apply Phase 2 results
        if (result.quantum_tech) {
          document.getElementById('select-tech-quantum').value = result.quantum_tech.toLowerCase();
        }
        if (result.tech_2) {
          document.getElementById('select-tech-2').value = result.tech_2.toLowerCase();
        }
        if (result.tech_3) {
          document.getElementById('select-tech-3').value = result.tech_3.toLowerCase();
        }
        if (result.actor) {
          document.getElementById('select-actor').value = result.actor.toLowerCase();
          // Hide custom input if visible
          document.getElementById('input-actor-custom').style.display = 'none';
        }
        if (result.event) {
          document.getElementById('select-event').value = result.event.toLowerCase();
          // Hide custom input if visible
          document.getElementById('input-event-custom').style.display = 'none';
        }
        debugLog(`Phase 2 cards applied: quantum=${result.quantum_tech}, tech2=${result.tech_2}, tech3=${result.tech_3}, actor=${result.actor}, event=${result.event}`);
      }
    }

    // ================================
    // Connection Test
    // ================================
    async function testConnection() {
      const statusEl = document.getElementById('connection-status');

      try {
        // Test Supabase connection by fetching archetype mappings
        const { data, error } = await supabaseClient
          .from('Archetype_mapping')
          .select('*')
          .limit(1);

        if (error) throw error;

        statusEl.className = 'status-message success';
        statusEl.innerHTML = `‚úì ${t('connected')}`;
        debugLog('Connection test successful');

        // Log table info
        debugLog(`Sample archetype mapping: ${JSON.stringify(data)}`);

      } catch (error) {
        statusEl.className = 'status-message error';
        statusEl.innerHTML = `‚úó ${t('connection_error')}: ${error.message}`;
        debugLog(`Connection test failed: ${error.message}`);
      }
    }

    // ================================
    // Initialize Application
    // ================================
    document.addEventListener('DOMContentLoaded', async () => {
      debugLog('Application initializing...');

      // Initialize Supabase
      if (initSupabase()) {
        // Test the connection
        await testConnection();
      }

      debugLog('Application ready');
    });
  </script>

</body>
</html>
